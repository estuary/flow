"use strict";(self.webpackChunksite=self.webpackChunksite||[]).push([[44],{59124:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>a,contentTitle:()=>s,default:()=>h,frontMatter:()=>i,metadata:()=>d,toc:()=>l});var n=o(74848),r=o(28453);const i={},s="How to join two collections (TypeScript)",d={id:"guides/howto_join_two_collections_typescript",title:"How to join two collections (TypeScript)",description:"This guide will teach you how to write and publish a TypeScript derivation, which will join two collections together on a common key.",source:"@site/docs/guides/howto_join_two_collections_typescript.md",sourceDirName:"guides",slug:"/guides/howto_join_two_collections_typescript",permalink:"/guides/howto_join_two_collections_typescript",draft:!1,unlisted:!1,editUrl:"https://github.com/estuary/flow/edit/master/site/docs/guides/howto_join_two_collections_typescript.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"How to generate an Estuary Flow Refresh Token",permalink:"/guides/how_to_generate_refresh_token"},next:{title:"Schema evolution",permalink:"/guides/schema-evolution"}},a={},l=[{value:"Introduction<a></a>",id:"introduction",level:2},{value:"Setting up your development environment<a></a>",id:"setting-up-your-development-environment",level:2},{value:"Writing the derivation<a></a>",id:"writing-the-derivation",level:2},{value:"Wrapping up<a></a>",id:"wrapping-up",level:2}];function c(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",img:"img",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,r.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.h1,{id:"how-to-join-two-collections-typescript",children:"How to join two collections (TypeScript)"}),"\n",(0,n.jsx)(t.p,{children:"This guide will teach you how to write and publish a TypeScript derivation, which will join two collections together on a common key."}),"\n",(0,n.jsxs)(t.h2,{id:"introduction",children:["Introduction",(0,n.jsx)("a",{id:"introduction"})]}),"\n",(0,n.jsx)(t.p,{children:"This tutorial will show you how to implement a stateless transformation using TypeScript. You\u2019ll learn how to implement a flow that matches orders to customers in real-time."}),"\n",(0,n.jsxs)(t.h2,{id:"setting-up-your-development-environment",children:["Setting up your development environment",(0,n.jsx)("a",{id:"setting-up-your-development-environment"})]}),"\n",(0,n.jsxs)(t.p,{children:["The data sources used in this tutorial are available in two Google Sheets. This one for the ",(0,n.jsx)(t.a,{href:"https://docs.google.com/spreadsheets/d/1glzIgMIeS5Fd2unb-m9J6czXdWBXK_x_ZsgzxbVUclQ/edit#gid=0",children:"orders"})," and this one for the ",(0,n.jsx)(t.a,{href:"https://docs.google.com/spreadsheets/d/1WUyM9hmRwa8B1Kz2buFcscZegPA35nvTdaHC-L3xr7U/edit#gid=0",children:"customers"}),". Make a copy of each so you\u2019ll be able to test out the pipeline by adding, editing or removing records."]}),"\n",(0,n.jsx)(t.p,{children:"Customers table sample"}),"\n",(0,n.jsxs)(t.table,{children:[(0,n.jsx)(t.thead,{children:(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.th,{style:{textAlign:"right"}}),(0,n.jsx)(t.th,{}),(0,n.jsx)(t.th,{}),(0,n.jsx)(t.th,{})]})}),(0,n.jsxs)(t.tbody,{children:[(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"right"},children:"customer_id"}),(0,n.jsx)(t.td,{children:"email"}),(0,n.jsx)(t.td,{children:"name"}),(0,n.jsx)(t.td,{children:"phone"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"right"},children:"101"}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.a,{href:"mailto:customer1@email.com",children:"customer1@email.com"})}),(0,n.jsx)(t.td,{children:"John Doe"}),(0,n.jsx)(t.td,{children:"123-456-7890"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"right"},children:"102"}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.a,{href:"mailto:customer2@email.com",children:"customer2@email.com"})}),(0,n.jsx)(t.td,{children:"Jane Smith"}),(0,n.jsx)(t.td,{children:"987-654-3210"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"right"},children:"103"}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.a,{href:"mailto:customer3@email.com",children:"customer3@email.com"})}),(0,n.jsx)(t.td,{children:"Alex Lee"}),(0,n.jsx)(t.td,{children:"555-123-4567"})]})]})]}),"\n",(0,n.jsx)(t.p,{children:"Orders table sample"}),"\n",(0,n.jsxs)(t.table,{children:[(0,n.jsx)(t.thead,{children:(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.th,{style:{textAlign:"right"}}),(0,n.jsx)(t.th,{style:{textAlign:"right"}}),(0,n.jsx)(t.th,{style:{textAlign:"right"}}),(0,n.jsx)(t.th,{style:{textAlign:"right"}})]})}),(0,n.jsxs)(t.tbody,{children:[(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"right"},children:"order_id"}),(0,n.jsx)(t.td,{style:{textAlign:"right"},children:"customer_id"}),(0,n.jsx)(t.td,{style:{textAlign:"right"},children:"order_date"}),(0,n.jsx)(t.td,{style:{textAlign:"right"},children:"total_amount"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"right"},children:"1"}),(0,n.jsx)(t.td,{style:{textAlign:"right"},children:"101"}),(0,n.jsx)(t.td,{style:{textAlign:"right"},children:"2024-05-10 8:00:00"}),(0,n.jsx)(t.td,{style:{textAlign:"right"},children:"50"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"right"},children:"2"}),(0,n.jsx)(t.td,{style:{textAlign:"right"},children:"102"}),(0,n.jsx)(t.td,{style:{textAlign:"right"},children:"2024-05-09 12:00:00"}),(0,n.jsx)(t.td,{style:{textAlign:"right"},children:"75.5"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{style:{textAlign:"right"},children:"3"}),(0,n.jsx)(t.td,{style:{textAlign:"right"},children:"103"}),(0,n.jsx)(t.td,{style:{textAlign:"right"},children:"2024-05-08 15:30:00"}),(0,n.jsx)(t.td,{style:{textAlign:"right"},children:"100.25"})]})]})]}),"\n",(0,n.jsxs)(t.p,{children:["As you can see, both tables contain a field called ",(0,n.jsx)(t.code,{children:"customer_id"}),". This is what we\u2019re going to use as the key in our join operation. One customer can have multiple orders, but one order can only belong to one customer. There are also some customers without any orders."]}),"\n",(0,n.jsx)(t.p,{children:"Let\u2019s say you want to see all customers and all of their orders in the results. This means, you\u2019ll be looking to implement a full outer join."}),"\n",(0,n.jsxs)(t.p,{children:["To create the collections in Estuary Flow, head over to the dashboard and ",(0,n.jsx)(t.a,{href:"https://dashboard.estuary.dev/captures/create",children:"create"})," a new Google Sheet capture. Give it a name and add one of the previously copied sheet\u2019s URL as the \u201cSpreadsheet Link\u201d. Repeat this process for the other sheet, which should leave you with 2 collections."]}),"\n",(0,n.jsx)(t.p,{children:"You can take a look into each via the data preview window on the Collections page to verify that the sample data has already landed in Flow."}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{src:"https://storage.googleapis.com/estuary-marketing-strapi-uploads/uploads//orders_sheet_collection_b99f3c9c84/orders_sheet_collection_b99f3c9c84.png",alt:"Orders collection"})}),"\n",(0,n.jsxs)(t.p,{children:["In order to implement transformations through ",(0,n.jsx)(t.a,{href:"https://docs.estuary.dev/concepts/#derivations",children:"derivations"}),", you\u2019ll need to set up your development environment. You\u2019ll need a text editor and ",(0,n.jsx)(t.a,{href:"https://docs.estuary.dev/concepts/flowctl/",children:"flowctl"}),", the CLI-tool for Flow installed on your machine. Check out the ",(0,n.jsx)(t.a,{href:"https://docs.estuary.dev/concepts/flowctl/#installation-and-setup",children:"docs page"})," on installation instructions."]}),"\n",(0,n.jsxs)(t.p,{children:["To verify that you\u2019re able to access Flow via ",(0,n.jsx)(t.code,{children:"flowctl"}),", see if you can execute these commands successfully to view documents in your collections."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",children:'flowctl collections read --collection <your_collection_id> --uncommitted\n\n{"_meta":{"uuid":"9790e50e-0ed3-11ef-8401-6d9be407e4b8"},"customer_id":"101","order_date":"2024-05-10 8:00:00","order_id":"1","row_id":203,"total_amount":"50"}\n{"_meta":{"uuid":"9790e50e-0ed3-11ef-8801-6d9be407e4b8"},"customer_id":"102","order_date":"2024-05-09 12:00:00","order_id":"2","row_id":204,"total_amount":"75.5"}\n{"_meta":{"uuid":"9790e50e-0ed3-11ef-8c01-6d9be407e4b8"},"customer_id":"103","order_date":"2024-05-08 15:30:00","order_id":"3","row_id":205,"total_amount":"100.25"}\n{"_meta":{"uuid":"9790e50e-0ed3-11ef-9001-6d9be407e4b8"},"customer_id":"101","order_date":"2024-05-07 10:00:00","order_id":"4","row_id":206,"total_amount":"25.75"}\n{"_meta":{"uuid":"9790e50e-0ed3-11ef-9401-6d9be407e4b8"},"customer_id":"103","order_date":"2024-05-06 14:45:00","order_id":"5","row_id":207,"total_amount":"60.2"}\n{"_meta":{"uuid":"9790e50e-0ed3-11ef-9801-6d9be407e4b8"},"customer_id":"102","order_date":"2024-05-05 11:20:00","order_id":"6","row_id":208,"total_amount":"45.9"}\n{"_meta":{"uuid":"9790e50e-0ed3-11ef-9c01-6d9be407e4b8"},"customer_id":"104","order_date":"2024-05-04 9:30:00","order_id":"7","row_id":209,"total_amount":"80.1"}\n'})}),"\n",(0,n.jsx)(t.p,{children:"If you see something similar, you\u2019re good to continue!"}),"\n",(0,n.jsxs)(t.h2,{id:"writing-the-derivation",children:["Writing the derivation",(0,n.jsx)("a",{id:"writing-the-derivation"})]}),"\n",(0,n.jsxs)(t.p,{children:["Set up your folder structure so you can organize the resources required for the derivation. Create a working directory to follow along, and inside, create a ",(0,n.jsx)(t.code,{children:"flow.yaml"})," file."]}),"\n",(0,n.jsxs)(t.p,{children:["Inside your ",(0,n.jsx)(t.code,{children:"flow.yaml "}),"file, add the following contents:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-yaml",children:"collections:\n\n\xa0\xa0Dani/join-tutorial-typescript/customers_with_orders:\n\xa0\xa0\xa0\xa0schema:\n\xa0\xa0\xa0\xa0\xa0\xa0description: >-\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0A document that represents the joined result of orders with customer\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0information\n\xa0\xa0\xa0\xa0\xa0\xa0type: object\n\xa0\xa0\xa0\xa0\xa0\xa0properties:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0customer_id:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0type: string\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0email:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0type: string\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0name:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0type: string\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0phone:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0type: string\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0orders:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0type: array\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0items:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0$ref: orders.schema.yaml\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0reduce:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0strategy: merge\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0key:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0- /order_id\n\xa0\xa0\xa0\xa0\xa0\xa0required:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0- customer_id\n\xa0\xa0\xa0\xa0\xa0\xa0reduce:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0strategy: merge\n\xa0\xa0\xa0\xa0key:\n\xa0\xa0\xa0\xa0\xa0\xa0- /customer_id\n\n\xa0\xa0\xa0\xa0derive:\n\xa0\xa0\xa0\xa0\xa0\xa0using:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0typescript:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0module: full-outer-join.flow.ts\n\xa0\xa0\xa0\xa0\xa0\xa0transforms:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0- name: fromOrders\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0source:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0name: Dani/join-tutorial-orders/Sheet1_v2\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0shuffle:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0key:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0- /customer_id\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0- name: fromCustomers\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0source:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0name: Dani/join-tutorial-customers/Sheet1\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0shuffle:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0key:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0- /customer_id\n"})}),"\n",(0,n.jsxs)(t.p,{children:["Let\u2019s take a look at this in a bit more detail. Essentially, we define one collection which it\u2019s a ",(0,n.jsx)(t.code,{children:"derivation"})," that is the result of two transformations."]}),"\n",(0,n.jsx)(t.p,{children:"In the schema definition, we specify what structure we want the documents of the result collection to take on."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-yaml",children:"\xa0 Dani/join-tutorial-typescript/customers_with_orders:\n\xa0\xa0\xa0\xa0schema:\n\xa0\xa0\xa0\xa0\xa0\xa0description: >-\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0A document that represents the joined result of orders with customer\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0information\n\xa0\xa0\xa0\xa0\xa0\xa0type: object\n\xa0\xa0\xa0\xa0\xa0\xa0properties:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0customer_id:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0type: string\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0email:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0type: string\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0name:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0type: string\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0phone:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0type: string\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0orders:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0type: array\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0items:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0$ref: orders.schema.yaml\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0reduce:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0strategy: merge\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0key:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0- /order_id\n\xa0\xa0\xa0\xa0\xa0\xa0required:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0- customer_id\n\xa0\xa0\xa0\xa0\xa0\xa0reduce:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0strategy: merge\n\xa0\xa0\xa0\xa0key:\n\xa0\xa0\xa0\xa0\xa0\xa0- /customer_id\n"})}),"\n",(0,n.jsx)(t.p,{children:"Because you are going to implement a 1-to-many join using the two source collections, it\u2019s important to pay attention to what reduction strategy Flow uses."}),"\n",(0,n.jsxs)(t.p,{children:["There are two ",(0,n.jsx)(t.code,{children:"merge"})," strategies defined here, one for the ",(0,n.jsx)(t.code,{children:"customers_with_orders "}),"collection and for the nested ",(0,n.jsx)(t.code,{children:"orders"})," array.\xa0"]}),"\n",(0,n.jsx)(t.admonition,{title:"Merge reduces the left-hand side and right-hand side by recursively reducing shared document locations. The LHS and RHS must either both be objects, or both be arrays.",type:"note"}),"\n",(0,n.jsxs)(t.p,{children:["For the nested merge, you have to define a key, which is one or more JSON pointers that are relative to the reduced location. If both sides are arrays and a merge key is present, then a deep sorted merge of the respective items is done, as ordered by the key. In this case, setting it to ",(0,n.jsx)(t.code,{children:"order_id"})," will cause the reduction to collect all orders for a given customer."]}),"\n",(0,n.jsxs)(t.p,{children:["The items in the nested array of orders are defined by the schema in a separate file, to which we refer to using ",(0,n.jsx)(t.code,{children:"$ref: orders.schema.yaml"}),"."]}),"\n",(0,n.jsx)(t.p,{children:"The derivation details are defined in the next section of the yaml:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-yaml",children:"\xa0 \xa0 derive:\n\xa0\xa0\xa0\xa0\xa0\xa0using:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0typescript:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0module: full-outer-join.flow.ts\n\xa0\xa0\xa0\xa0\xa0\xa0transforms:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0- name: fromOrders\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0source:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0name: Dani/join-tutorial-orders/Sheet1_v2\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0shuffle:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0key:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0- /customer_id\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0- name: fromCustomers\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0source:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0name: Dani/join-tutorial-customers/Sheet1\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0shuffle:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0key:\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0- /customer_id\n"})}),"\n",(0,n.jsxs)(t.p,{children:["This tells flow that the transformation code is defined in a TypeScript file called ",(0,n.jsx)(t.code,{children:"full-outer-join.flow.ts"})," (which doesn\u2019t exist \u2013 yet!) and that there are in fact two transformations that it expects, one for each source collection."]}),"\n",(0,n.jsx)(t.p,{children:"Shuffles let Flow identify the shard that should process a particular source document, in order to co-locate that processing with other documents it may need to know about."}),"\n",(0,n.jsx)(t.p,{children:"Both transformations shuffle data on the same key. An important detail is that if a derivation has more than one transformation, the shuffle keys of all transformations must align with one another in terms of the extracted key types (string vs integer) as well as the number of components in a composite key."}),"\n",(0,n.jsxs)(t.p,{children:["Let\u2019s generate the scaffolding for the derivation using ",(0,n.jsx)(t.code,{children:"flowctl"}),"."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",children:"flowctl generate --source flow.yaml\n"})}),"\n",(0,n.jsx)(t.p,{children:"This command will create a few new files in your current working directory."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",children:"\u279c\xa0 tree\n.\n\u251c\u2500\u2500 deno.json\n\u251c\u2500\u2500 flow.yaml\n\u251c\u2500\u2500 flow_generated\n\u2502 \xa0 \u2514\u2500\u2500 typescript\n\u2502 \xa0 \xa0 \xa0 \u2514\u2500\u2500 Dani\n\u2502 \xa0 \xa0 \xa0 \xa0 \xa0 \u2514\u2500\u2500 join-tutorial-typescript\n\u2502 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \xa0 \u2514\u2500\u2500 customers_with_orders.ts\n\u251c\u2500\u2500 full-outer-join.flow.ts\n\u2514\u2500\u2500 orders.schema.yaml\n\n5 directories, 5 files\n"})}),"\n",(0,n.jsxs)(t.p,{children:["The folder ",(0,n.jsx)(t.code,{children:"flow_generated"})," along with the ",(0,n.jsx)(t.code,{children:"deno.json"})," file are two things you won\u2019t have to modify during this tutorial. If you take a look at file that ",(0,n.jsx)(t.code,{children:"flowctl"})," generated under ",(0,n.jsx)(t.code,{children:"flow_generated/typescript/<your_working_directory>/<your_prefix>/customers_with_orders.ts"})," you can see the types you are able to use in your transformations."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-typescript",children:"// Generated for published documents of derived collection customers_with_orders.\nexport type Document = /* A document that represents the joined result of orders with customer information */ {\n\xa0\xa0\xa0\xa0customer_id: string;\n\xa0\xa0\xa0\xa0email?: string;\n\xa0\xa0\xa0\xa0name?: string;\n\xa0\xa0\xa0\xa0orders?: unknown[];\n\xa0\xa0\xa0\xa0phone?: string;\n};\n\n// Generated for read documents of sourced collection Sheet1.\nexport type SourceFromOrders = {\n\xa0\xa0\xa0\xa0customer_id?: string;\n\xa0\xa0\xa0\xa0order_date?: string;\n\xa0\xa0\xa0\xa0order_id?: string;\n\xa0\xa0\xa0\xa0row_id: number;\n\xa0\xa0\xa0\xa0total_amount?: string;\n};\n\n// Generated for read documents of sourced collection Sheet1.\nexport type SourceFromCustomers = {\n\xa0\xa0\xa0\xa0customer_id?: string;\n\xa0\xa0\xa0\xa0email?: string;\n\xa0\xa0\xa0\xa0name?: string;\n\xa0\xa0\xa0\xa0phone?: string;\n\xa0\xa0\xa0\xa0row_id: number;\n};\n"})}),"\n",(0,n.jsxs)(t.p,{children:["Now, the actual transformation code will live in the following file: ",(0,n.jsx)(t.code,{children:"full-outer-join.flow.ts"}),". Take a look at its contents."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-typescript",children:'import { IDerivation, Document, SourceFromOrders, SourceFromCustomers } from \'flow/Dani/join-tutorial-typescript/customers_with_orders.ts\';\n\n// Implementation for derivation Dani/join-tutorial-typescript/customers_with_orders.\nexport class Derivation extends IDerivation {\n\xa0\xa0\xa0\xa0fromOrders(_read: { doc: SourceFromOrders }): Document[] {\n\xa0\xa0\xa0\xa0\xa0\xa0throw new Error("Not implemented");\n\xa0\xa0\xa0\xa0}\n\xa0\xa0\xa0\xa0fromCustomers(_read: { doc: SourceFromCustomers }): Document[] {\n\xa0\xa0\xa0\xa0\xa0\xa0throw new Error("Not implemented");\n\xa0\xa0}\n}\n'})}),"\n",(0,n.jsxs)(t.p,{children:["Helpfully, ",(0,n.jsx)(t.code,{children:"flowctl"})," provides two skeleton functions. Update the function body to implement the filter functionality. Modify the Derivation class like this:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-typescript",children:'import { IDerivation, Document, SourceFromOrders, SourceFromCustomers } from \'flow/Dani/join-tutorial-typescript/customers_with_orders.ts\';\n\n// Implementation for derivation Dani/join-tutorial-typescript/customers_with_orders.\nexport class Derivation extends IDerivation {\n\xa0\xa0\xa0\xa0fromOrders(_read: { doc: SourceFromOrders }): Document[] {\n\xa0\xa0\xa0\xa0\xa0\xa0return [{\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0customer_id: _read.doc.customer_id || "",\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0orders: [_read.doc],\n\xa0\xa0\xa0\xa0\xa0\xa0}];\n\xa0\xa0\xa0\xa0}\n\xa0\xa0\xa0\xa0fromCustomers(_read: { doc: SourceFromCustomers }): Document[] {\n\xa0\xa0\xa0\xa0\xa0\xa0return [{\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0customer_id: _read.doc.customer_id || "",\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0email: _read.doc.email,\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0name: _read.doc.name,\n\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0phone: _read.doc.phone\n\xa0\xa0\xa0\xa0\xa0\xa0}];\n\xa0\xa0}\n}\n'})}),"\n",(0,n.jsx)(t.p,{children:"As you can see here, all we do is return the fields we need from each document, there\u2019s no code required to define the actual \u201cjoin\u201d \u2013 all the heavy lifting is done in the reduction phase during materialization by the Flow runtime based on the schema you defined earlier."}),"\n",(0,n.jsxs)(t.p,{children:["Publish the derivation using ",(0,n.jsx)(t.code,{children:"flowctl"}),":"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",children:"flowctl catalog publish --source flow.yaml\n"})}),"\n",(0,n.jsx)(t.p,{children:"After it\u2019s successfully published, head over to the Flow dashboard to see the new collection."}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{src:"https://storage.googleapis.com/estuary-marketing-strapi-uploads/uploads//customers_with_orders_collection_d3c09d237f/customers_with_orders_collection_d3c09d237f.png",alt:"Customers with Orders collection"})}),"\n",(0,n.jsx)(t.p,{children:"If you take a look at the preview window at the bottom of the page, you might notice that the documents are not yet in their final, reduced form. As mentioned earlier, the reduction happens during materialization. Let's create one to show the results!"}),"\n",(0,n.jsxs)(t.p,{children:["Head over to the ",(0,n.jsx)(t.a,{href:"https://dashboard.estuary.dev/materializations/create",children:"materialization creation page"}),", search for Google Sheets and configure a new connector. Create a fresh Google Sheet and copy its URL as the Spreadsheet Link."]}),"\n",(0,n.jsx)(t.p,{children:"In the third configuration step, select the derivation you created as the source collection."}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{src:"https://storage.googleapis.com/estuary-marketing-strapi-uploads/uploads//source_collection_capture_e3946cd3a0/source_collection_capture_e3946cd3a0.png",alt:"Link source collection to materialization"})}),"\n",(0,n.jsx)(t.p,{children:"After everything looks good, press the \u201cSave and Publish\u201d button in the top-right corner to provision your materialization connector."}),"\n",(0,n.jsx)(t.p,{children:"And that\u2019s it! Go check out the sheet you created to store the results. You should see all orders associated with their respective customer in the nested array."}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{src:"https://storage.googleapis.com/estuary-marketing-strapi-uploads/uploads//results_8c3a566b86/results_8c3a566b86.png",alt:"Reduced results in a Google Sheet"})}),"\n",(0,n.jsx)(t.p,{children:"To test the data flow, head over to the source \u201cOrders\u201d sheet, and add a new order for a customer. After a few seconds, you should see the new order added to the array of existing orders of the customer. Take a few minutes to play around with different actions as well; deleting an order, adding a customer, editing details of either entity."}),"\n",(0,n.jsxs)(t.h2,{id:"wrapping-up",children:["Wrapping up",(0,n.jsx)("a",{id:"wrapping-up"})]}),"\n",(0,n.jsx)(t.p,{children:"In this guide you learned how to write a TypeScript derivation to join two collections. After finishing with the tutorial, don\u2019t forget to delete resources you don\u2019t need anymore."})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(c,{...e})}):c(e)}},28453:(e,t,o)=>{o.d(t,{R:()=>s,x:()=>d});var n=o(96540);const r={},i=n.createContext(r);function s(e){const t=n.useContext(i);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function d(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),n.createElement(i.Provider,{value:t},e.children)}}}]);