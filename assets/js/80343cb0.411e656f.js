"use strict";(self.webpackChunksite=self.webpackChunksite||[]).push([[294],{28453:(e,t,r)=>{r.d(t,{R:()=>i,x:()=>d});var n=r(96540);const s={},o=n.createContext(s);function i(e){const t=n.useContext(o);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function d(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),n.createElement(o.Provider,{value:t},e.children)}},52139:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>c,contentTitle:()=>d,default:()=>h,frontMatter:()=>i,metadata:()=>n,toc:()=>a});const n=JSON.parse('{"id":"reference/openmetrics-api","title":"OpenMetrics API","description":"Estuary\'s OpenMetrics API exposes detailed metrics data on your captures, derivations, and materializations. This allows you to track your Estuary Flow usage and pipeline activity in depth.","source":"@site/docs/reference/openmetrics-api.md","sourceDirName":"reference","slug":"/reference/openmetrics-api","permalink":"/reference/openmetrics-api","draft":false,"unlisted":false,"editUrl":"https://github.com/estuary/flow/edit/master/site/docs/reference/openmetrics-api.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Materialization sync schedule","permalink":"/reference/materialization-sync-schedule"}}');var s=r(74848),o=r(28453);const i={},d="OpenMetrics API",c={},a=[{value:"Using the OpenMetrics API",id:"using-the-openmetrics-api",level:2},{value:"Prometheus",id:"prometheus",level:3},{value:"Datadog",id:"datadog",level:3},{value:"Custom integration",id:"custom-integration",level:3},{value:"Available metrics",id:"available-metrics",level:2}];function l(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.header,{children:(0,s.jsx)(t.h1,{id:"openmetrics-api",children:"OpenMetrics API"})}),"\n",(0,s.jsx)(t.p,{children:"Estuary's OpenMetrics API exposes detailed metrics data on your captures, derivations, and materializations. This allows you to track your Estuary Flow usage and pipeline activity in depth.\nIntegrating the API with monitoring platforms like Prometheus or Datadog also allows you to implement alerts with greater specificity than Estuary currently offers natively."}),"\n",(0,s.jsx)(t.h2,{id:"using-the-openmetrics-api",children:"Using the OpenMetrics API"}),"\n",(0,s.jsx)(t.p,{children:"The OpenMetrics API consists of one main endpoint:"}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.code,{children:"https://agent-api-1084703453822.us-central1.run.app/api/v1/metrics/{prefix}/"})}),"\n",(0,s.jsxs)(t.p,{children:["The prefix may be for your entire tenant (such as ",(0,s.jsx)(t.code,{children:"acmeCo/"}),") or a subset (such as ",(0,s.jsx)(t.code,{children:"acmeCo/sub/path/"}),")."]}),"\n",(0,s.jsx)(t.admonition,{type:"warning",children:(0,s.jsx)(t.p,{children:"Don't forget the trailing slash on your tenant or subpath: it's part of your prefix."})}),"\n",(0,s.jsxs)(t.p,{children:["To authenticate the API, you will need an ",(0,s.jsx)(t.a,{href:"/guides/how_to_generate_refresh_token",children:"Estuary refresh token"}),". You can generate one in the ",(0,s.jsx)(t.a,{href:"https://dashboard.estuary.dev/admin/api",children:"Admin panel"})," of your dashboard."]}),"\n",(0,s.jsx)(t.p,{children:"See the sections below for specific instructions on working with the API in relation to:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"#prometheus",children:"Prometheus"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"#datadog",children:"Datadog"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"#custom-integration",children:"As a custom integration"})}),"\n"]}),"\n",(0,s.jsx)(t.h3,{id:"prometheus",children:"Prometheus"}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.a,{href:"https://prometheus.io/",children:"Prometheus"})," is an open-source monitoring solution. Integrating the OpenMetrics API with Prometheus lets you track your Estuary metrics over time."]}),"\n",(0,s.jsxs)(t.p,{children:["To use the OpenMetrics API with Prometheus, configure your ",(0,s.jsx)(t.code,{children:"prometheus.yml"})," file to include Estuary's information. For example:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-yaml",children:"global:\n  scrape_interval: 1m\n\nscrape_configs:\n  - job_name: estuary\n    scheme: https\n    bearer_token: REFRESH_TOKEN\n    metrics_path: /api/v1/metrics/PREFIX/\n    static_configs:\n      - targets: [agent-api-1084703453822.us-central1.run.app]\n"})}),"\n",(0,s.jsxs)(t.p,{children:["Make sure to replace ",(0,s.jsx)(t.code,{children:"REFRESH_TOKEN"})," and ",(0,s.jsx)(t.code,{children:"PREFIX"})," with your generated refresh token and desired prefix."]}),"\n",(0,s.jsx)(t.p,{children:"To try this locally with Docker, you can run:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:'docker run --rm -it -p "9090:9090" -v $(pwd)/prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus:latest\n'})}),"\n",(0,s.jsxs)(t.p,{children:["You will then be able to view a Prometheus dashboard at ",(0,s.jsx)(t.a,{href:"http://localhost:9090/",children:"http://localhost:9090/"})," to start graphing your metrics."]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{src:"https://storage.googleapis.com/estuary-marketing-strapi-uploads/uploads//openmetrics_prometheus_3fb3fe6bfa/openmetrics_prometheus_3fb3fe6bfa.png",alt:"Prometheus dashboard"})}),"\n",(0,s.jsx)(t.h3,{id:"datadog",children:"Datadog"}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.a,{href:"https://www.datadoghq.com/",children:"Datadog"})," is a cloud-monitoring-as-a-service platform. Like with Prometheus, you can integrate with Datadog to track your Estuary metrics over time. To do so, though, you will need some additional information related to your Datadog account."]}),"\n",(0,s.jsxs)(t.p,{children:["To use the OpenMetrics API with Datadog, add the API endpoint to your ",(0,s.jsx)(t.code,{children:"datadog.yaml"})," agent config. For example:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-yaml",children:'init_config: {}\n\ninstances:\n  - openmetrics_endpoint: https://agent-api-1084703453822.us-central1.run.app/api/v1/metrics/PREFIX/\n    namespace: estuary\n    min_collection_interval: 60\n    headers:\n      Authorization: Bearer REFRESH_TOKEN\n    metrics:\n      - ".*"\n'})}),"\n",(0,s.jsxs)(t.p,{children:["Make sure to replace ",(0,s.jsx)(t.code,{children:"REFRESH_TOKEN"})," and ",(0,s.jsx)(t.code,{children:"PREFIX"})," with your generated refresh token and desired prefix."]}),"\n",(0,s.jsx)(t.p,{children:"You can try running an agent locally with Docker using:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:'docker run --rm -it -v $(pwd)/datadog.yaml:/etc/datadog-agent/conf.d/openmetrics.d/conf.yaml:ro \\\n  -e DD_API_KEY=YOUR_DATADOG_API_KEY \\\n  -e DD_SITE=YOUR_DATADOG_SITE \\\n  -e DD_HOSTNAME=YOUR_HOSTNAME \\\n  -p "9090:9090" \\\n  gcr.io/datadoghq/agent:latest\n'})}),"\n",(0,s.jsx)(t.p,{children:"Note that you will need to include environment variables for:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Your Datadog API key"}),"\n",(0,s.jsx)(t.li,{children:"Your Datadog site"}),"\n",(0,s.jsx)(t.li,{children:"Your Datadog host name"}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{src:"https://storage.googleapis.com/estuary-marketing-strapi-uploads/uploads//openmetrics_datadog_62a6b99a88/openmetrics_datadog_62a6b99a88.png",alt:"Datadog dashboard"})}),"\n",(0,s.jsxs)(t.p,{children:["For more information on configuring your Datadog agent and retrieving the required data, see ",(0,s.jsx)(t.a,{href:"https://docs.datadoghq.com/agent/",children:"Datadog's docs"}),"."]}),"\n",(0,s.jsx)(t.h3,{id:"custom-integration",children:"Custom integration"}),"\n",(0,s.jsxs)(t.p,{children:["You can also access the OpenMetrics API directly or as part of a custom integration. To do so, use the endpoint with your prefix as the URL and use your refresh token as an ",(0,s.jsx)(t.code,{children:"Authorization: Bearer"})," header."]}),"\n",(0,s.jsxs)(t.p,{children:["For example, using ",(0,s.jsx)(t.code,{children:"curl"})," this would look like:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"curl --location 'https://agent-api-1084703453822.us-central1.run.app/api/v1/metrics/PREFIX/' \\\n--header 'Authorization: Bearer REFRESH_TOKEN'\n"})}),"\n",(0,s.jsx)(t.p,{children:"The output will contain the current totals for various tasks under the prefix, separated by metric name. The response uses the following format:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:'# HELP logged_warnings_total Total log lines at level WARN, by task\n# TYPE logged_warnings_total counter\nlogged_warnings_total{task="acmeCo/prefix/source-oracle"} 12\nlogged_warnings_total{task="acmeCo/prefix/materialize-mongodb"} 5\n# HELP logged_errors_total Total log lines at level ERROR, by task\n# TYPE logged_errors_total counter\n{...}\n# HELP materialized_out_docs_total Total number of post-reduce documents stored to the target, by task and source collection\n# TYPE materialized_out_docs_total counter\nmaterialized_out_docs_total{task="acmeCo/prefix/dekaf-tinybird",collection="acmeCo/prefix/collection"} 1580\n# EOF\n'})}),"\n",(0,s.jsx)(t.p,{children:"If you implement your own polling, note that the recommended interval for most use cases is one minute."}),"\n",(0,s.jsx)(t.h2,{id:"available-metrics",children:"Available metrics"}),"\n",(0,s.jsx)(t.p,{children:"Estuary currently tracks the following metrics in the OpenMetrics API. Metrics fall in one of two categories:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Counters:"})," return the total related to that metric (eg. total number of docs or bytes)"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Gauges:"})," return the latest publication timestamp"]}),"\n"]}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{children:"Name"}),(0,s.jsx)(t.th,{children:"Type"}),(0,s.jsx)(t.th,{children:"Description"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"captured_in_bytes_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total number of pre-combine bytes captured by the connector, by task and target collection"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"captured_in_docs_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total number of pre-combine documents captured by the connector, by task and target collection"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"captured_out_bytes_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total number of post-combine bytes captured by the connector, by task and target collection"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"captured_out_docs_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total number of post-combine documents captured by the connector, by task and target collection"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"derived_in_bytes_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total number of pre-reduce bytes read from the source collection, by task, source collection, and transform"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"derived_in_docs_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total number of pre-reduce documents read from the source collection, by task, source collection, and transform"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"derived_last_source_published_at_time_seconds"})}),(0,s.jsx)(t.td,{children:"Gauge"}),(0,s.jsx)(t.td,{children:"Publication timestamp of the most recent source collection document that was processed by the derivation, given as seconds since the unix epoch"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"derived_out_bytes_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total number of post-combine bytes published by derivation transforms, by task"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"derived_out_docs_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total number of post-combine documents published by derivation transforms, by task"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"derived_yield_bytes_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total number of pre-combine bytes published by derivation transforms, by task"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"derived_yield_docs_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total number of pre-combine documents published by derivation transforms, by task"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"logged_errors_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total log lines at level ERROR, by task"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"logged_failures_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total log lines indicating task failure, by task"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"logged_warnings_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total log lines at level WARN, by task"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"materialized_in_bytes_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total number of pre-reduce bytes read from the source collection, by task and source collection"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"materialized_in_docs_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total number of pre-reduce documents read from the source collection, by task and source collection"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"materialized_last_source_published_at_time_seconds"})}),(0,s.jsx)(t.td,{children:"Gauge"}),(0,s.jsx)(t.td,{children:"Publication timestamp of the most recent source collection document that was materialized, given as seconds since the unix epoch"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"materialized_load_bytes_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total number of pre-reduce bytes loaded from the target, by task and source collection"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"materialized_load_docs_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total number of pre-reduce documents loaded from the target, by task and source collection"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"materialized_out_bytes_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total number of post-reduce bytes stored to the target, by task and source collection"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"materialized_out_docs_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total number of post-reduce documents stored to the target, by task and source collection"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"read_by_me_bytes_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total number of collection bytes read by this task, by task"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"read_by_me_docs_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total number of collection documents read by this task, by task"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"read_from_me_bytes_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total number of collection bytes read from this source, by collection"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"read_from_me_docs_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total number of collection documents read from this source, by collection"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"txn_count_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total number of transactions processed by this task, by task"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"usage_seconds_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total number of billable seconds of connector usage time, by task"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"written_by_me_bytes_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total number of collection bytes written by this task, by task"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"written_by_me_docs_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total number of collection documents written by this task, by task"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"written_to_me_bytes_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total number of collection bytes written to this target, by collection"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:(0,s.jsx)(t.code,{children:"written_to_me_docs_total"})}),(0,s.jsx)(t.td,{children:"Counter"}),(0,s.jsx)(t.td,{children:"Total number of collection documents written to this target, by collection"})]})]})]})]})}function h(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}}}]);