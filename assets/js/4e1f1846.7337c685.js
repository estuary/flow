"use strict";(self.webpackChunksite=self.webpackChunksite||[]).push([[3766],{90534:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>d,toc:()=>l});var i=t(74848),s=t(28453);const o={},r="Tinybird",d={id:"reference/Connectors/materialization-connectors/Dekaf/tinybird",title:"Tinybird",description:"This connector materializes Flow collections as Kafka-compatible messages that a Tinybird Kafka consumer can read. Tinybird is a data platform for user-facing analytics.",source:"@site/docs/reference/Connectors/materialization-connectors/Dekaf/tinybird.md",sourceDirName:"reference/Connectors/materialization-connectors/Dekaf",slug:"/reference/Connectors/materialization-connectors/Dekaf/tinybird",permalink:"/reference/Connectors/materialization-connectors/Dekaf/tinybird",draft:!1,unlisted:!1,editUrl:"https://github.com/estuary/flow/edit/master/site/docs/reference/Connectors/materialization-connectors/Dekaf/tinybird.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Startree",permalink:"/reference/Connectors/materialization-connectors/Dekaf/startree"},next:{title:"Elasticsearch",permalink:"/reference/Connectors/materialization-connectors/Elasticsearch"}},a={},l=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Variants",id:"variants",level:2},{value:"Setup",id:"setup",level:2},{value:"Connecting Estuary Flow to Tinybird",id:"connecting-estuary-flow-to-tinybird",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Properties",id:"properties",level:3},{value:"Endpoint",id:"endpoint",level:4},{value:"Bindings",id:"bindings",level:4},{value:"Sample",id:"sample",level:3},{value:"Configuring support for deletions",id:"configuring-support-for-deletions",level:2},{value:"Soft deletes",id:"soft-deletes",level:3},{value:"Store whole document as JSON",id:"store-whole-document-as-json",level:4},{value:"Mark extracted fields as nullable",id:"mark-extracted-fields-as-nullable",level:4},{value:"Hard deletes",id:"hard-deletes",level:3},{value:"Enable Dekaf&#39;s <code>cdc</code> deletions mode.",id:"enable-dekafs-cdc-deletions-mode",level:4},{value:"Set up your schema for soft deletes",id:"set-up-your-schema-for-soft-deletes",level:4}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"tinybird",children:"Tinybird"}),"\n",(0,i.jsxs)(n.p,{children:["This connector materializes Flow collections as Kafka-compatible messages that a Tinybird Kafka consumer can read. ",(0,i.jsx)(n.a,{href:"https://www.tinybird.co/",children:"Tinybird"})," is a data platform for user-facing analytics."]}),"\n",(0,i.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,i.jsx)(n.p,{children:"To use this connector, you'll need:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"At least one Flow collection"}),"\n",(0,i.jsx)(n.li,{children:"A Tinybird account"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"variants",children:"Variants"}),"\n",(0,i.jsxs)(n.p,{children:["This connector is a variant of the default Dekaf connector. For other integration options, see the main ",(0,i.jsx)(n.a,{href:"/reference/Connectors/materialization-connectors/Dekaf/",children:"Dekaf"})," page."]}),"\n",(0,i.jsx)(n.h2,{id:"setup",children:"Setup"}),"\n",(0,i.jsx)(n.p,{children:"Provide an auth token when setting up the Dekaf connector. This can be a password of your choosing and will be used to authenticate consumers to your Kafka topics."}),"\n",(0,i.jsxs)(n.p,{children:["Once the connector is created, note the task name, such as ",(0,i.jsx)(n.code,{children:"YOUR-ORG/YOUR-PREFIX/YOUR-MATERIALIZATION"}),". You will use this as the username."]}),"\n",(0,i.jsx)(n.h2,{id:"connecting-estuary-flow-to-tinybird",children:"Connecting Estuary Flow to Tinybird"}),"\n",(0,i.jsx)(n.p,{children:"In your Tinybird Workspace, create a new Data Source and use the Kafka Connector."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Configure Estuary Flow Data Source",src:t(584).A+"",width:"1794",height:"1305"})}),"\n",(0,i.jsx)(n.p,{children:"To configure the connection details, use the following settings."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Bootstrap servers: ",(0,i.jsx)(n.code,{children:"dekaf.estuary-data.com"})]}),"\n",(0,i.jsxs)(n.li,{children:["SASL Mechanism: ",(0,i.jsx)(n.code,{children:"PLAIN"})]}),"\n",(0,i.jsxs)(n.li,{children:["SASL Username: Your materialization task name, such as ",(0,i.jsx)(n.code,{children:"YOUR-ORG/YOUR-PREFIX/YOUR-MATERIALIZATION"})]}),"\n",(0,i.jsx)(n.li,{children:"SASL Password: Your materialization's auth token"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:'Tick the "Decode Avro messages with Schema Registry" box, and use the following settings:'}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["URL: ",(0,i.jsx)(n.code,{children:"https://dekaf.estuary-data.com"})]}),"\n",(0,i.jsx)(n.li,{children:"Username: The same as your SASL username"}),"\n",(0,i.jsx)(n.li,{children:"Password: The same as your SASL password"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Configure Estuary Flow Schema Registry",src:t(94367).A+"",width:"1800",height:"1025"})}),"\n",(0,i.jsx)(n.p,{children:"Click Next and you will see a list of topics. These topics are the collections you added to your materialization.\nSelect the collection you want to ingest into Tinybird, and click Next."}),"\n",(0,i.jsx)(n.p,{children:"Configure your consumer group as needed."}),"\n",(0,i.jsx)(n.p,{children:"Finally, you will see a preview of the Data Source schema. Feel free to make any modifications as required, then click\nCreate Data Source."}),"\n",(0,i.jsx)(n.p,{children:"This will complete the connection with Tinybird, and new data from the Estuary Flow collection will arrive in your\nTinybird Data Source in real-time."}),"\n",(0,i.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,i.jsx)(n.p,{children:"To use this connector, begin with data in one or more Flow collections.\nUse the below properties to configure a Dekaf materialization, which will direct one or more of your Flow collections to your desired topics."}),"\n",(0,i.jsx)(n.h3,{id:"properties",children:"Properties"}),"\n",(0,i.jsx)(n.h4,{id:"endpoint",children:"Endpoint"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Property"}),(0,i.jsx)(n.th,{children:"Title"}),(0,i.jsx)(n.th,{children:"Description"}),(0,i.jsx)(n.th,{children:"Type"}),(0,i.jsx)(n.th,{children:"Required/Default"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"/token"})}),(0,i.jsx)(n.td,{children:"Auth Token"}),(0,i.jsx)(n.td,{children:"The password that Kafka consumers can use to authenticate to this task."}),(0,i.jsx)(n.td,{children:"string"}),(0,i.jsx)(n.td,{children:"Required"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"/strict_topic_names"})}),(0,i.jsx)(n.td,{children:"Strict Topic Names"}),(0,i.jsx)(n.td,{children:"Whether or not to expose topic names in a strictly Kafka-compliant format."}),(0,i.jsx)(n.td,{children:"boolean"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"false"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"/deletions"})}),(0,i.jsx)(n.td,{children:"Deletion Mode"}),(0,i.jsxs)(n.td,{children:["Can choose between ",(0,i.jsx)(n.code,{children:"kafka"})," or ",(0,i.jsx)(n.code,{children:"cdc"})," deletion modes."]}),(0,i.jsx)(n.td,{children:"string"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"kafka"})})]})]})]}),"\n",(0,i.jsx)(n.h4,{id:"bindings",children:"Bindings"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Property"}),(0,i.jsx)(n.th,{children:"Title"}),(0,i.jsx)(n.th,{children:"Description"}),(0,i.jsx)(n.th,{children:"Type"}),(0,i.jsx)(n.th,{children:"Required/Default"})]})}),(0,i.jsx)(n.tbody,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"/topic_name"})}),(0,i.jsx)(n.td,{children:"Topic Name"}),(0,i.jsx)(n.td,{children:"Kafka topic name that Dekaf will publish under."}),(0,i.jsx)(n.td,{children:"string"}),(0,i.jsx)(n.td,{children:"Required"})]})})]}),"\n",(0,i.jsx)(n.h3,{id:"sample",children:"Sample"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"materializations:\n  ${PREFIX}/${mat_name}:\n    endpoint:\n      dekaf:\n        config:\n          token: <auth-token>\n          strict_topic_names: false\n          deletions: kafka\n        variant: tinybird\n    bindings:\n      - resource:\n          topic_name: ${COLLECTION_NAME}\n        source: ${PREFIX}/${COLLECTION_NAME}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"configuring-support-for-deletions",children:"Configuring support for deletions"}),"\n",(0,i.jsxs)(n.p,{children:["Many Flow connectors capture a stream of change data which can include deletions, represented by the ",(0,i.jsxs)(n.a,{href:"/reference/deletions",children:[(0,i.jsx)(n.code,{children:"_meta/op"})," field"]}),". By default, the schema that Tinybird infers from your data won't include support for these deletions documents. The reason for this is that we frequently don't include the entire document that got deleted, and instead simply include its key. This will violate non-null constraints that get inferred at dataflow creation time. You can configure deletions in two ways:"]}),"\n",(0,i.jsx)(n.h3,{id:"soft-deletes",children:"Soft deletes"}),"\n",(0,i.jsxs)(n.p,{children:["Soft deletes simply require relaxing the Tinybird schema to avoid quarantining deletion documents. To do this, you can either store the whole document in a JSON column and deal with extracting fields in the destination system, or you can manually mark all data fields as ",(0,i.jsx)(n.code,{children:"Nullable(..)"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"store-whole-document-as-json",children:"Store whole document as JSON"}),"\n",(0,i.jsxs)(n.p,{children:["If you want the raw data from your Flow collection to be ingested into Tinybird without dealing with schema issues, you can request that the full document be stored as JSON using the special ",(0,i.jsx)(n.code,{children:"#.__value"})," pointer. Note that you still need to extract the key, as well as ",(0,i.jsx)(n.code,{children:"_meta.op"})," which will contain one of ",(0,i.jsx)(n.code,{children:"c"}),", ",(0,i.jsx)(n.code,{children:"u"}),", or ",(0,i.jsx)(n.code,{children:"d"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'SCHEMA >\n    `__value` String `json:#.__value`,\n    `_id` String `json:$._id`,\n    `__offset` Int64,\n    `_meta_op` String `json:$._meta.op`\nENGINE "ReplacingMergeTree"\nENGINE_SORTING_KEY "_id"\nENGINE_VER "__offset"\nKAFKA_STORE_RAW_VALUE \'True\'\n'})}),"\n",(0,i.jsxs)(n.admonition,{type:"note",children:[(0,i.jsxs)(n.p,{children:["Using the ",(0,i.jsx)(n.code,{children:"ReplacingMergeTree"})," engine along with selecting ",(0,i.jsx)(n.code,{children:"__offset"})," as the revision will have the effect of deduplicating your CDC stream by the provided ",(0,i.jsx)(n.code,{children:"ENGINE_SORTING_KEY"}),", where the last write wins."]}),(0,i.jsxs)(n.p,{children:["If you'd rather keep the entire changelog, you can instead use ",(0,i.jsx)(n.code,{children:"MergeTree"}),". See ",(0,i.jsx)(n.a,{href:"https://www.tinybird.co/docs/concepts/data-sources#supported-engines-and-settings",children:"here"})," for more details on the various options available to you."]})]}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["The field ",(0,i.jsx)(n.code,{children:"_id"})," here represents your ",(0,i.jsx)(n.a,{href:"/concepts/collections/#keys",children:"collection's key"}),", which is ",(0,i.jsx)(n.strong,{children:"not"})," always ",(0,i.jsx)(n.code,{children:"_id"}),"."]})}),"\n",(0,i.jsxs)(n.admonition,{type:"note",children:[(0,i.jsxs)(n.p,{children:["If your collection key contains multiple fields, you can instead take advantage of the fact that Dekaf extracts and serializes your key into the Kafka record's key field, which is accessible in Tinybird via the special ",(0,i.jsx)(n.code,{children:"__key"})," field."]}),(0,i.jsxs)(n.p,{children:["To do so, set ",(0,i.jsx)(n.code,{children:'ENGINE_SORTING_KEY "__key"'}),"."]})]}),"\n",(0,i.jsx)(n.h4,{id:"mark-extracted-fields-as-nullable",children:"Mark extracted fields as nullable"}),"\n",(0,i.jsx)(n.p,{children:"If you want to extract certain fields from your documents, you must explicitly mark them all as nullable in order to avoid rejecting deletion documents which don't contain the same data as a create or update document."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'SCHEMA >\n    `_id` String `json:$._id`,\n    `_meta_op` String `json:$._meta.op`,\n    `example_field` Nullable(String) `json:$.example`\nENGINE "ReplacingMergeTree"\nENGINE_SORTING_KEY "__key"\nENGINE_VER "__offset"\n'})}),"\n",(0,i.jsx)(n.admonition,{type:"warning",children:(0,i.jsx)(n.p,{children:"Array fields do not support being marked as nullable, so you will not be able to extract array fields here."})}),"\n",(0,i.jsx)(n.h3,{id:"hard-deletes",children:"Hard deletes"}),"\n",(0,i.jsx)(n.p,{children:"Instead of exposing deletion events for you to handle on your own, hard deletes cause deleted documents (identified by their unique key) to be deleted from the Tinybird dataflow entirely."}),"\n",(0,i.jsxs)(n.h4,{id:"enable-dekafs-cdc-deletions-mode",children:["Enable Dekaf's ",(0,i.jsx)(n.code,{children:"cdc"})," deletions mode."]}),"\n",(0,i.jsxs)(n.p,{children:["This will change its default behavior of emitting deletions as Kafka null-value'd records, to emitting the full deletion document plus a special ",(0,i.jsx)(n.code,{children:"/_meta/is_deleted"})," field which we'll use in a moment."]}),"\n",(0,i.jsxs)(n.p,{children:["To enable this setting in the UI, expand the ",(0,i.jsx)(n.strong,{children:"Deletion Mode"})," option in your materialization's Endpoint Config. Choose ",(0,i.jsx)(n.code,{children:"cdc"})," from the dropdown menu."]}),"\n",(0,i.jsxs)(n.p,{children:["In the schema, this would be the ",(0,i.jsx)(n.code,{children:"deletions"})," setting:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"endpoint:\n  dekaf:\n    config:\n      deletions: cdc\n"})}),"\n",(0,i.jsx)(n.h4,{id:"set-up-your-schema-for-soft-deletes",children:"Set up your schema for soft deletes"}),"\n",(0,i.jsx)(n.p,{children:"Pick one of the two options from above:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#store-whole-document-as-json",children:"Store whole document as JSON"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#mark-extracted-fields-as-nullable",children:"Mark extracted fields as nullable"})}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Then, you can extract the ",(0,i.jsx)(n.code,{children:"/_meta/is_deleted"})," field, and configure the ",(0,i.jsx)(n.code,{children:"ReplacingMergeTree"})," engine's ",(0,i.jsx)(n.code,{children:"ENGINE_IS_DELETED"})," flag to use it:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'SCHEMA >\n    `__value` String `json:#.__value`,\n    `_meta_is_deleted` UInt8 `json:$._meta.is_deleted`,\n    `_meta_op` String `json:$._meta.op`\nENGINE "ReplacingMergeTree"\nENGINE_SORTING_KEY "__key"\nENGINE_VER "__offset"\nENGINE_IS_DELETED "_meta_is_deleted"\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Now, the last piece to the puzzle is to add the ",(0,i.jsx)(n.code,{children:"FINAL"})," keyword to any Tinybird query targeting this datasource. For example, if you create a pipe that looks like this:"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Node 1"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"SELECT * FROM your_datasource FINAL\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Node 2"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-SQL",children:"SELECT * FROM your_top_node WHERE _meta_op = 'd'\n"})}),"\n",(0,i.jsx)(n.p,{children:"You should find no rows returned, indicating that the deleted rows were correctly filtered out."})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},584:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/tinybird-dekaf-connection-fba932bedbbcc4c576198ff245096769.png"},94367:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/tinybird-schema-registry-setup-3c11dac3b72c2af35804bed40ffb67b5.png"},28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>d});var i=t(96540);const s={},o=i.createContext(s);function r(e){const n=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);