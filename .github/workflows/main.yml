name: CI

# Controls when the action will run. Triggers the workflow on push
# or pull request events, but only for the primary branch.
on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-18.04

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - run: make extra-ci-runner-setup
      - run: make print-versions

      # TODO(johnny): This works well, but published docker images have the visibility
      # of the associated repository, and there's no way to change this without making
      # the repo itself public. Which we may well do, so leaving commented out for now.
      #
      #- name: Login to GitHub package docker registry
      #  run: |
      #    echo "${{ secrets.GITHUB_TOKEN }}" | \
      #      docker login --username ${{ github.actor }} --password-stdin docker.pkg.github.com

      - name: Login to quay.io container registry
        run: |
          echo "${{ secrets.QUAY_TOKEN }}" | \
            docker login --username ${{ secrets.QUAY_USERNAME }} --password-stdin quay.io

      - name: Cache/Restore Rust dependencies.
        uses: actions/cache@v2
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cache/Restore Go dependencies.
        uses: actions/cache@v2
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - run: make install-tools
      - run: go mod download
      - uses: actions-rs/cargo@v1
        with:
          command: build
          args: --locked --release
      - run: make sql-test
      - run: make rust-test
      - run: make build-test-catalog
      - run: make go-test-ci
      - run: make catalog-test
      - run: make package
      - run: make docker-image
      - run: make docker-push-to-quay
      - run: cargo install cargo-cache --no-default-features --features ci-autoclean
      - run: cargo-cache
