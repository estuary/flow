---
source: tests/materialize_tests.rs
expression: clean_output
---
/* This SQL has been generated automatically by flowctl for a materialization of the Flow Collection 'stock/daily-stats' to the target 'localSqlite' */

BEGIN;

/* This table holds the checkpoints for all of the consumers for all materializations targeting this database. */
CREATE TABLE IF NOT EXISTS gazette_checkpoints (shard_fqn TEXT NOT NULL PRIMARY KEY, fence INTEGER NOT NULL, checkpoint BLOB NOT NULL);

/* This table holds the configuration objects for all materializations to this target system. The configuration that gets persisted here is generated automatically by flowctl, and will be used by the flow-consumer at runtime to determine which fields should be projected into the table. */
CREATE TABLE IF NOT EXISTS flow_materializations (table_name TEXT NOT NULL PRIMARY KEY, config_json TEXT);
INSERT INTO flow_materializations (table_name, config_json) VALUES ('test_table', '{"collection":"stock/daily-stats","fields":[{"field":"ask/avgD","locationPtr":"/ask/avgD","primaryKey":false},{"field":"ask/avgN","locationPtr":"/ask/avgN","primaryKey":false},{"field":"ask/high","locationPtr":"/ask/high","primaryKey":false},{"field":"ask/low","locationPtr":"/ask/low","primaryKey":false},{"field":"date","locationPtr":"/date","primaryKey":true},{"field":"exchange","locationPtr":"/exchange","primaryKey":false},{"field":"first/price","locationPtr":"/first/price","primaryKey":false},{"field":"first/size","locationPtr":"/first/size","primaryKey":false},{"field":"last/price","locationPtr":"/last/price","primaryKey":false},{"field":"last/size","locationPtr":"/last/size","primaryKey":false},{"field":"my_special_column","locationPtr":"/bid","primaryKey":false},{"field":"price/avgD","locationPtr":"/price/avgD","primaryKey":false},{"field":"price/avgN","locationPtr":"/price/avgN","primaryKey":false},{"field":"price/high","locationPtr":"/price/high","primaryKey":false},{"field":"price/low","locationPtr":"/price/low","primaryKey":false},{"field":"security","locationPtr":"/security","primaryKey":true},{"field":"spread/avgD","locationPtr":"/spread/avgD","primaryKey":false},{"field":"spread/avgN","locationPtr":"/spread/avgN","primaryKey":false},{"field":"spread/high","locationPtr":"/spread/high","primaryKey":false},{"field":"spread/low","locationPtr":"/spread/low","primaryKey":false},{"field":"volume","locationPtr":"/volume","primaryKey":false}]}');

/* Materialization of Estuary collection 'stock/daily-stats', intended for sqlite target 'localSqlite' */
CREATE TABLE IF NOT EXISTS "test_table" (
	/* auto-generated projection of JSON at: /ask/avgD with inferred types: [number] */
	"ask/avgD" REAL,

	/* auto-generated projection of JSON at: /ask/avgN with inferred types: [number] */
	"ask/avgN" REAL,

	/* auto-generated projection of JSON at: /ask/high with inferred types: [number] */
	"ask/high" REAL,

	/* auto-generated projection of JSON at: /ask/low with inferred types: [number] */
	"ask/low" REAL,

	/* auto-generated projection of JSON at: /date with inferred types: [string] */
	"date" TEXT NOT NULL,

	/* user provided projection of JSON at: /exchange (partition key) with inferred types: [string] */
	"exchange" TEXT NOT NULL,

	/* auto-generated projection of JSON at: /first/price with inferred types: [number] */
	"first/price" REAL,

	/* auto-generated projection of JSON at: /first/size with inferred types: [integer] */
	"first/size" INTEGER,

	/* auto-generated projection of JSON at: /last/price with inferred types: [number] */
	"last/price" REAL,

	/* auto-generated projection of JSON at: /last/size with inferred types: [integer] */
	"last/size" INTEGER,

	/* user provided projection of JSON at: /bid with inferred types: [object] */
	"my_special_column" TEXT,

	/* auto-generated projection of JSON at: /price/avgD with inferred types: [number] */
	"price/avgD" REAL,

	/* auto-generated projection of JSON at: /price/avgN with inferred types: [number] */
	"price/avgN" REAL,

	/* auto-generated projection of JSON at: /price/high with inferred types: [number] */
	"price/high" REAL,

	/* auto-generated projection of JSON at: /price/low with inferred types: [number] */
	"price/low" REAL,

	/* auto-generated projection of JSON at: /security with inferred types: [string] */
	"security" TEXT NOT NULL,

	/* auto-generated projection of JSON at: /spread/avgD with inferred types: [number] */
	"spread/avgD" REAL,

	/* auto-generated projection of JSON at: /spread/avgN with inferred types: [number] */
	"spread/avgN" REAL,

	/* auto-generated projection of JSON at: /spread/high with inferred types: [number] */
	"spread/high" REAL,

	/* auto-generated projection of JSON at: /spread/low with inferred types: [number] */
	"spread/low" REAL,

	/* auto-generated projection of JSON at: /volume with inferred types: [integer] */
	"volume" INTEGER,
	/* This column holds the complete document from the Flow Collection, with all reduction annotations applied. It is added automatically to all materializations. */
	/* auto-generated projection of JSON at: / with inferred types: [object] */
	"flow_document" TEXT NOT NULL,

	PRIMARY KEY("date", "security")
);

COMMIT;

Gazette Shard Spec:
ApplyRequest {
    changes: [
        Change {
            expect_mod_revision: -1,
            upsert: Some(
                ShardSpec {
                    id: "materialization/stock/daily-stats/localSqlite/test_table",
                    sources: [],
                    recovery_log_prefix: "",
                    hint_prefix: "",
                    hint_backups: 0,
                    max_txn_duration: Some(
                        Duration {
                            seconds: 1,
                            nanos: 0,
                        },
                    ),
                    min_txn_duration: None,
                    disable: false,
                    hot_standbys: 0,
                    labels: Some(
                        LabelSet {
                            labels: [
                                Label {
                                    name: "app.gazette.dev/managed-by",
                                    value: "estuary.dev/flow",
                                },
                                Label {
                                    name: "estuary.dev/catalog-url",
                                    value: "<placeholder-catalog-path>",
                                },
                                Label {
                                    name: "estuary.dev/collection",
                                    value: "stock/daily-stats",
                                },
                                Label {
                                    name: "estuary.dev/key-begin",
                                    value: "00",
                                },
                                Label {
                                    name: "estuary.dev/key-end",
                                    value: "ffffffff",
                                },
                                Label {
                                    name: "estuary.dev/materialization-table",
                                    value: "test_table",
                                },
                                Label {
                                    name: "estuary.dev/materialization-target",
                                    value: "localSqlite",
                                },
                                Label {
                                    name: "estuary.dev/rclock-begin",
                                    value: "0000000000000000",
                                },
                                Label {
                                    name: "estuary.dev/rclock-end",
                                    value: "ffffffffffffffff",
                                },
                            ],
                        },
                    ),
                    disable_wait_for_ack: false,
                },
            ),
            delete: "",
        },
    ],
    extension: [],
}

