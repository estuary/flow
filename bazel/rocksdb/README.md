# RocksDB Bazel Integration

Fast Bazel-native build of RocksDB that avoids the slow cargo build (~13 minutes) by building RocksDB C++ directly with Bazel (~22 seconds first time, cached thereafter).

## Overview

This directory contains the infrastructure for building RocksDB in Bazel:

- **BUILD.bazel** - Exports vendored bindings from main workspace
- **librocksdb.BUILD.bazel** - Builds RocksDB C++, Snappy, and librocksdb-sys
- **rust_rocksdb.BUILD.bazel** - Builds high-level `rocksdb` crate
- **bindings.rs** - Pre-generated FFI bindings (200KB, vendored)
- **lib.rs** - Thin wrapper that includes bindings
- **regenerate_bindings.sh** - Script to regenerate bindings for new versions

## Architecture

### Build Strategy

Instead of using `rust_bindgen_library` (which requires compiling entire LLVM/Clang toolchain - 5,245+ actions), we:

1. **Generate bindings once** using cargo's build.rs (1 minute)
2. **Vendor the bindings** as `bindings.rs` (checked into git)
3. **Export from main workspace** via `exports_files`
4. **Reference from external repos** using `@//bazel/rocksdb:bindings.rs`

### Repository Structure

```
Main Workspace (//bazel/rocksdb)
├── BUILD.bazel                      # Exports bindings.rs and lib.rs
├── bindings.rs                      # Vendored FFI bindings
└── lib.rs                           # Wrapper that includes bindings

@librocksdb (librocksdb-sys from crates.io)
├── BUILD.bazel                      # Uses librocksdb.BUILD.bazel
├── rocksdb/ (C++ sources)
├── snappy/ (compression)
└── Rust wrapper using @//bazel/rocksdb:bindings.rs

@rust_rocksdb (rocksdb crate from crates.io)
├── BUILD.bazel                      # Uses rust_rocksdb.BUILD.bazel
└── src/ (high-level Rust API)
```

### Cross-Repository References

The key insight is using `@//` to reference files from the main workspace:

```python
rust_library(
    name = "rocksdb_sys",
    srcs = [
        "@//bazel/rocksdb:lib.rs",      # From main workspace
        "@//bazel/rocksdb:bindings.rs",  # From main workspace
    ],
    crate_root = "@//bazel/rocksdb:lib.rs",
    deps = [":rocksdb_cc"],  # Local to @librocksdb
)
```

## Usage

### In Your Crate

```python
rust_library(
    name = "my_crate",
    deps = [
        "@rust_rocksdb//:rocksdb",  # Use this!
        # Other deps...
    ],
)
```

## Upgrading RocksDB

### Quick Version Bump (Same Major/Minor)

If the RocksDB version is compatible (e.g., 0.17.3 → 0.17.4):

1. Update `MODULE.bazel`:
   ```python
   http_archive(
       name = "librocksdb",
       url = "https://static.crates.io/crates/librocksdb-sys/librocksdb-sys-0.17.4+X.Y.Z.crate",
       sha256 = "...",  # Get with: curl -sL <url> | sha256sum
   )
   ```

2. Test:
   ```bash
   bazelisk build @librocksdb//:rocksdb_sys
   bazelisk test //crates/derive:derive_lib_test
   ```

### Major Version Upgrade

For breaking changes or API updates:

1. **Regenerate bindings**:
   ```bash
   ./bazel/rocksdb/regenerate_bindings.sh 0.18.0
   ```

2. **Update MODULE.bazel** with new versions and SHA256:
   ```python
   # Update both repositories
   http_archive(name = "librocksdb", ...)
   http_archive(name = "rust_rocksdb", ...)
   ```

3. **Test thoroughly**:
   ```bash
   bazelisk build @librocksdb//:rocksdb_cc
   bazelisk build @librocksdb//:rocksdb_sys
   bazelisk build @rust_rocksdb//:rocksdb
   bazelisk test //crates/derive:derive_lib_test
   ```

## Files

### bindings.rs

Pre-generated FFI bindings from RocksDB's C API (`rocksdb/include/rocksdb/c.h`).

- **Size**: ~200KB (6,326 lines)
- **Generated by**: librocksdb-sys build.rs using bindgen
- **Regenerate**: `./regenerate_bindings.sh`
- **Check into git**: Yes (avoids LLVM compilation)

### lib.rs

Minimal wrapper that includes the bindings:

```rust
#![allow(clippy::all, non_snake_case, non_camel_case_types, non_upper_case_globals)]
include!("bindings.rs");
```

### BUILD.bazel (Main Workspace)

```python
exports_files(["bindings.rs", "lib.rs"])
```

Makes files available to external repositories via `@//bazel/rocksdb:file.rs`.

### librocksdb.BUILD.bazel

Complete BUILD file for `@librocksdb` repository:
- Builds Snappy compression (cc_library)
- Builds RocksDB C++ (cc_library, 335 source files)
- Wraps with Rust (rust_library, uses vendored bindings)

### rust_rocksdb.BUILD.bazel

BUILD file for `@rust_rocksdb` repository:
- Builds high-level `rocksdb` crate
- Depends on `@librocksdb//:rocksdb_sys`

## References

- **librocksdb-sys**: https://crates.io/crates/librocksdb-sys
- **rocksdb**: https://crates.io/crates/rocksdb
- **RocksDB**: https://rocksdb.org/
- **Bazel rules_rust**: https://bazelbuild.github.io/rules_rust/
