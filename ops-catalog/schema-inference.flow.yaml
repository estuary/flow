collections:
  # A direct-copy of L1, but enables us to add more L1s
  # as we create more data planes.
  ops.us-central1.v1/inferred-schemas/L2:
    schema: schema-inference.schema.yaml
    key: [/collection_name]
    derive:
      using:
        sqlite: {}
      # The idea with this L2 collection is to merge
      # all data planes' L1 collections together
      transforms:
        - name: from-ops.us-central1.v1
          source: ops.us-central1.v1/inferred-schemas/L1
          shuffle: any
          lambda: select $collection_name, $schema;

  ops.us-central1.v1/inferred-schemas/L1:
    derive:
      using:
        sqlite: {}
      transforms:
        - name: inferredSchemas
          source: ops.us-central1.v1/logs
          shuffle: any
          lambda: |
            select
              $fields->'collection_name' as collection_name,
              $fields->'schema' as schema
            where $message = 'inferred schema updated';
    key: [/collection_name]
    schema: schema-inference.schema.yaml
