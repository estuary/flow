collections:
  estuary/global/schema-inference-L2:
    schema: schema-inference.schema.yaml
    key: [/collection_name]
    projections:
      collection_name: /collection_name
      schema: /schema
      ts: /ts

    derive:
      using:
        sqlite: {}
      # The idea with this L2 collection is to merge
      # all data planes' L1 collections together
      transforms:
        - name: from-ops.us-central1.v1
          source: ops.us-central1.v1/private/schema-inference-L1
          shuffle: any
          lambda: select $ts, $collection_name, $schema;
  ops.us-central1.v1/private/schema-inference-L1:
    derive:
      using:
        sqlite: {}
      transforms:
        - name: inferredSchemas
          source: ops.us-central1.v1/logs
          shuffle: any
          lambda: |
            select
              $ts,
              $fields->'collection_name' as collection_name,
              $fields->'schema' as schema
            where $message = 'inferred schema updated';
    projections:
      collection_name: /collection_name
      schema: /schema
      ts: /ts
    key: [/collection_name]
    schema: schema-inference.schema.yaml
