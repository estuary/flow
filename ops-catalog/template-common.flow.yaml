collections:
  ops/TENANT/logs:
    schema: ops-log-schema.json
    key: [/shard/name, /shard/keyBegin, /shard/rClockBegin, /ts]
    projections:
      kind:
        location: /shard/kind
        partition: true
      name:
        location: /shard/name
        partition: true

  ops/TENANT/stats:
    schema: ops-stats-schema.json
    key: [/shard/name, /shard/keyBegin, /shard/rClockBegin, /ts]
    projections:
      kind:
        location: /shard/kind
        partition: true
      name:
        location: /shard/name
        partition: true

  ops/TENANT/catalog-stats:
    schema:
      type: object
      reduce: { strategy: "merge" }
      properties:
        name: { type: string }
        grain:
          description: "Stats by month, day, or hour granularity."
          enum:
            - "monthly"
            - "daily"
            - "hourly"
        ts: { type: string }
        writtenBy: &docsAndBytes
          type: object
          reduce: { strategy: "merge" }
          properties:
            bytes:
              type: number
              reduce: { strategy: "sum" }
            docs:
              type: number
              reduce: { strategy: "sum" }
          required: [bytes, docs]
        readBy: *docsAndBytes
        writtenTo: *docsAndBytes
        readFrom: *docsAndBytes
      required: [
        name,
        grain,
        writtenBy,
        readBy,
        writtenTo,
        readFrom,
        ts
      ]
    key: [/name, /grain, /ts]
    projections:
      bytes_written_by: /writtenBy/bytes
      docs_written_by: /writtenBy/docs
      bytes_read_by: /readBy/bytes
      docs_read_by: /readBy/docs
      bytes_written_to: /writtenTo/bytes
      docs_written_to: /writtenTo/docs
      bytes_read_from: /readFrom/bytes
      docs_read_from: /readFrom/docs

    derivation:
      shards:
        minTxnDuration: 5s
      typescript: { module: "catalog-stats.ts" }
      transform:
        byGrain:
          source:
            name: ops/TENANT/stats
          publish: { lambda: typescript }

tests:
  ops/TENANT/tests/catalog-stats:
    - ingest:
        collection: ops/TENANT/stats
        documents:
          # Capture
          - shard:
              kind: capture
              name: tenant/test/cap
              keyBegin: "aabbccdd"
              rClockBegin: "00112233"
            ts: "2022-04-03T02:02:03.45678Z"
            capture:
              tenant/test/collection:
                right: { docsTotal: 1, bytesTotal: 15 }
                out: { docsTotal: 2, bytesTotal: 20 }
            txnCount: 2
            openSecondsTotal: 0.012
          # Same capture at a different hour, but the same day & month.
          - shard:
              kind: capture
              name: tenant/test/cap
              keyBegin: "aabbccdd"
              rClockBegin: "00112233"
            ts: "2022-04-03T03:02:03.45678Z"
            capture:
              tenant/test/collection:
                right: { docsTotal: 3, bytesTotal: 35 }
                out: { docsTotal: 4, bytesTotal: 45 }
            txnCount: 2
            openSecondsTotal: 0.012

          # Materialization
          # Sources from the same collection that the capture writes to, but on a different day &
          # hour during the same month.
          - shard:
              kind: materialization
              name: tenant/test/mat
              keyBegin: "aabbccdd"
              rClockBegin: "00112233"
            ts: "2022-04-04T03:02:03.45678Z"
            materialize:
              tenant/test/collection:
                right: { docsTotal: 10, bytesTotal: 150 }
            txnCount: 2
            openSecondsTotal: 0.012

          # Derivation
          - shard:
              kind: derivation
              name: tenant/test/collection # Same collection as the materialization & derivation use.
              keyBegin: "aabbccdd"
              rClockBegin: "00112233"
            ts: "2022-04-05T05:12:23.45678Z" # Same month but different day & hour than the materialization / derivation.
            derive:
              transforms:
                transform1:
                  source: "tenant/test/source-collection1" # This collection is read from.
                  input: { docsTotal: 5, bytesTotal: 20 }
                  update:
                    out: { docsTotal: 1, bytesTotal: 1 }
                    secondsTotal: 1
                transform2:
                  source: "tenant/test/source-collection2" # This collection is also read from.
                  input: { docsTotal: 6, bytesTotal: 30 }
                  publish:
                    out: { docsTotal: 2, bytesTotal: 2 }
                    secondsTotal: 2
              out: { docsTotal: 7, bytesTotal: 75 } # What was written to the collection.
            txnCount: 2
            openSecondsTotal: 0.012
    - verify:
        # Note: Spot checking docs counts in the monthly entry for tenant/test/collection.
        collection: ops/TENANT/catalog-stats
        documents:
            # Capture task
          - name: "tenant/test/cap"
            grain: "daily"
            ts: "2022-04-03T00:00:00.000Z"
            readBy:
              bytes: 0
            writtenBy:
              bytes: 65
            readFrom:
              bytes: 0
            writtenTo:
              bytes: 0
          - name: "tenant/test/cap"
            grain: "hourly"
            ts: "2022-04-03T02:00:00.000Z"
            readBy:
              bytes: 0
            writtenBy:
              bytes: 20
            readFrom:
              bytes: 0
            writtenTo:
              bytes: 0
          - name: "tenant/test/cap"
            grain: "hourly"
            ts: "2022-04-03T03:00:00.000Z"
            readBy:
              bytes: 0
            writtenBy:
              bytes: 45
            readFrom:
              bytes: 0
            writtenTo:
              bytes: 0
          - name: "tenant/test/cap"
            grain: "monthly"
            ts: "2022-04-01T00:00:00.000Z"
            readBy:
              bytes: 0
            writtenBy:
              bytes: 65
            readFrom:
              bytes: 0
            writtenTo:
              bytes: 0

            # Collection & derivation combo entity
          - name: "tenant/test/collection"
            grain: "daily"
            ts: "2022-04-03T00:00:00.000Z" # Capture day
            readBy:
              bytes: 0
            writtenBy:
              bytes: 0
            readFrom:
              bytes: 0
            writtenTo:
              bytes: 65
          - name: "tenant/test/collection"
            grain: "daily"
            ts: "2022-04-04T00:00:00.000Z" # Materialization day
            readBy:
              bytes: 0
            writtenBy:
              bytes: 0
            readFrom:
              bytes: 150
            writtenTo:
              bytes: 0
          - name: "tenant/test/collection"
            grain: "daily"
            ts: "2022-04-05T00:00:00.000Z" # Derivation day
            readBy:
              bytes: 50
            writtenBy:
              bytes: 75
            readFrom:
              bytes: 0
            writtenTo:
              bytes: 75
          - name: "tenant/test/collection"
            grain: "hourly"
            ts: "2022-04-03T02:00:00.000Z" # Capture hour 1
            readBy:
              bytes: 0
            writtenBy:
              bytes: 0
            readFrom:
              bytes: 0
            writtenTo:
              bytes: 20
          - name: "tenant/test/collection"
            grain: "hourly"
            ts: "2022-04-03T03:00:00.000Z" # Capture hour 2
            readBy:
              bytes: 0
            writtenBy:
              bytes: 0
            readFrom:
              bytes: 0
            writtenTo:
              bytes: 45
          - name: "tenant/test/collection"
            grain: "hourly"
            ts: "2022-04-04T03:00:00.000Z" # Materialization hour
            readBy:
              bytes: 0
            writtenBy:
              bytes: 0
            readFrom:
              bytes: 150
            writtenTo:
              bytes: 0
          - name: "tenant/test/collection"
            grain: "hourly"
            ts: "2022-04-05T05:00:00.000Z" # Derivation hour
            readBy:
              bytes: 50
            writtenBy:
              bytes: 75
            readFrom:
              bytes: 0
            writtenTo:
              bytes: 75
          - name: "tenant/test/collection"
            grain: "monthly"
            ts: "2022-04-01T00:00:00.000Z" # Same month for capture, materialization, and derivation.
            readBy:
              bytes: 50
              docs: 11
            writtenBy:
              bytes: 75
              docs: 7
            readFrom:
              bytes: 150
              docs: 10
            writtenTo:
              bytes: 140
              docs: 13

            # The materializaton task.
          - name: "tenant/test/mat"
            grain: "daily"
            ts: "2022-04-04T00:00:00.000Z"
            readBy:
              bytes: 150
            writtenBy:
              bytes: 0
            readFrom:
              bytes: 0
            writtenTo:
              bytes: 0
          - name: "tenant/test/mat"
            grain: "hourly"
            ts: "2022-04-04T03:00:00.000Z"
            readBy:
              bytes: 150
            writtenBy:
              bytes: 0
            readFrom:
              bytes: 0
            writtenTo:
              bytes: 0
          - name: "tenant/test/mat"
            grain: "monthly"
            ts: "2022-04-01T00:00:00.000Z"
            readBy:
              bytes: 150
            writtenBy:
              bytes: 0
            readFrom:
              bytes: 0
            writtenTo:
              bytes: 0

            # Source collections for the derivation.
          - name: "tenant/test/source-collection1"
            grain: "daily"
            ts: "2022-04-05T00:00:00.000Z"
            readBy:
              bytes: 0
            writtenBy:
              bytes: 0
            readFrom:
              bytes: 20
            writtenTo:
              bytes: 0
          - name: "tenant/test/source-collection1"
            grain: "hourly"
            ts: "2022-04-05T05:00:00.000Z"
            readBy:
              bytes: 0
            writtenBy:
              bytes: 0
            readFrom:
              bytes: 20
            writtenTo:
              bytes: 0
          - name: "tenant/test/source-collection1"
            grain: "monthly"
            ts: "2022-04-01T00:00:00.000Z"
            readBy:
              bytes: 0
            writtenBy:
              bytes: 0
            readFrom:
              bytes: 20
            writtenTo:
              bytes: 0
          - name: "tenant/test/source-collection2"
            grain: "daily"
            ts: "2022-04-05T00:00:00.000Z"
            readBy:
              bytes: 0
            writtenBy:
              bytes: 0
            readFrom:
              bytes: 30
            writtenTo:
              bytes: 0
          - name: "tenant/test/source-collection2"
            grain: "hourly"
            ts: "2022-04-05T05:00:00.000Z"
            readBy:
              bytes: 0
            writtenBy:
              bytes: 0
            readFrom:
              bytes: 30
            writtenTo:
              bytes: 0
          - name: "tenant/test/source-collection2"
            grain: "monthly"
            ts: "2022-04-01T00:00:00.000Z"
            readBy:
              bytes: 0
            writtenBy:
              bytes: 0
            readFrom:
              bytes: 30
            writtenTo:
              bytes: 0

# TODO(johnny): this is used only for local testing with `flowctl-go` and can go away soon.
storageMappings:
  "": { stores: [{ provider: S3, bucket: a-bucket }] }
