# Mise configuration for Estuary Flow development tasks
# See https://mise.jdx.dev for documentation

# Tool versions
[tools]
go = { version = "1.25" }
# `rust` is required, but installation via mise is incompatible with Swatim/rust-cache

"github:drager/wasm-pack" = { version = "0.13.1" }
"github:etcd-io/etcd" = { version = "3.5.24" }
"github:getsops/sops" = { version = "3.11.0", bin = "sops" }
"github:jdx/usage" = { version = "2.6.0" }
"github:mozilla/sccache" = {version = "0.12.0", platforms = { linux-arm64 =   { asset_pattern = "sccache-v*-aarch64-unknown-linux-musl.tar.gz" }, linux-x64 = { asset_pattern = "sccache-v*-x86_64-unknown-linux-musl.tar.gz" }, macos-arm64 = { asset_pattern = "sccache-v*-aarch64-apple-darwin.tar.gz" } } }
"github:nextest-rs/nextest" = { version = "cargo-nextest-0.9.114" }
"github:rui314/mold" = { version = "2.40.4" }
"github:supabase/cli" = { version = "2.54.11" }
"go:github.com/gogo/protobuf/protoc-gen-gogo" = { version = "1.3.2" }

# Environment variables
[env]

# Place cargo targets outside of the repo in a shared directory under $HOME.
# This allows for limited re-use across projects, but more importantly:
# it provides a stable home for built targets outside of the workspace root
# that's typically shared with VMs and incuring virtiofs overhead.
CARGO_TARGET_DIR = "{{ env.HOME }}/cargo-target"

# Treat all warnings as errors, and link using the `mold` linker (faster).
RUSTFLAGS = "-D warnings -C link-arg=-fuse-ld=mold"

# Install RocksDB under .build/, and set environment vars so that
# crate librocksdb-sys links our pre-built version.
ROCKSDB_VERSION = "9.10.0"
ROCKSDB_LIB_DIR = "{{ env.HOME }}/rocksdb-{{ env.ROCKSDB_VERSION }}/lib"
ROCKSDB_INCLUDE_DIR = "{{ env.HOME }}/rocksdb-{{ env.ROCKSDB_VERSION }}/include"

# Snappy is required by RocksDB and must be statically linked.
# Map mise arch() values (x64, arm64) to Debian multiarch triplets (x86_64, aarch64).
SNAPPY_LIB_DIR = """
{% if os() == 'linux' %}\
{% if arch() == 'x64' %}/usr/lib/x86_64-linux-gnu\
{% elif arch() == 'arm64' %}/usr/lib/aarch64-linux-gnu\
{% endif %}\
{% elif os() == 'macos' %}/opt/homebrew/lib\
{% endif %}"""

SNAPPY_STATIC = "1"

# Allow the `jemallocator` crate to link against the system jemalloc library.
JEMALLOC_OVERRIDE = """
{% if os() == 'linux' %}\
{% if arch() == 'x64' %}/usr/lib/x86_64-linux-gnu\
{% elif arch() == 'arm64' %}/usr/lib/aarch64-linux-gnu\
{% endif %}\
{% elif os() == 'macos' %}/opt/homebrew/lib\
{% endif %}\
/libjemalloc.a\
"""

# CGO flags for Go code that uses our `bindings` crate via cgo,
# and must include & link against RocksDB and other dependents.
CGO_CFLAGS = """
-I {{ env.ROCKSDB_INCLUDE_DIR }} \
"""

CGO_CPPFLAGS = """
-I {{ env.ROCKSDB_INCLUDE_DIR }} \
"""

# -lc must come before -lbindings due to how Go's internal linker processes
# CGO_LDFLAGS in a single left-to-right pass. When it examines -lbindings,
# it sees undefined references to malloc / free and requires that they be
# pre-resolved by libraries appearing earlier in the link order.
CGO_LDFLAGS = """
-fuse-ld=mold \
-L {{ env.CARGO_TARGET_DIR }}/debug \
-L {{ env.ROCKSDB_LIB_DIR }} \
-lc \
-lbindings \
-lrocksdb \
-lsnappy \
-lstdc++ \
-lssl \
-lcrypto \
-ldl \
-lm \
"""

RUSTC_WRAPPER = "sccache"