-- This table holds journal checkpoints, which Flow manages in order to ensure exactly-once updates for materializations
CREATE TABLE IF NOT EXISTS "gazette_checkpoints" (
	-- The id of the consumer shard. Note that a single collection may have multiple consumer shards materializing it, and each will have a separate checkpoint.
	"shard_fqn" TEXT NOT NULL,
	-- This nonce is used to uniquely identify unique process assignments of a shard and prevent them from conflicting.
	"fence" INTEGER NOT NULL,
	-- Checkpoint of the Flow consumer shard, encoded as base64 protobuf.
	"checkpoint" TEXT,

	PRIMARY KEY("shard_fqn")
);

SELECT "fence", "checkpoint" FROM "gazette_checkpoints" WHERE "shard_fqn" = ?;

INSERT INTO "gazette_checkpoints" ("shard_fqn", "fence", "checkpoint") VALUES (?, ?, ?);

UPDATE "gazette_checkpoints" SET "fence" = ?, "checkpoint" = ? WHERE "shard_fqn" = ?;
