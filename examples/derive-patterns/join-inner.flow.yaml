import:
  - inputs.flow.yaml

collections:
  patterns/inner-join:
    schema:
      $ref: schema.yaml#Join
      reduce: { strategy: lastWriteWins }
      required: [Key]
    key: [/Key]

    derive:
      using:
        sqlite:
          migrations:
            - |
              create table join_state (
                key text not null primary key,
                -- Stores the left hand side of the join
                lhs integer,
                -- Stores the right hand side of the join, using a JSON array
                -- since this is a one-to-many join
                rhs json
              );
      transforms:
        - name: fromInts
          source: patterns/ints
          shuffle: { key: [/Key] }
          lambda: |
            insert into join_state (key, lhs) values ($Key, $Int)
            on conflict (key) do update set lhs = lhs + $Int;
            -- now emit the joined result
            SELECT JSON_OBJECT(
              'Key', $Key,
              'LHS', lhs,
              'RHS', JSON(rhs)
            )
            FROM join_state
            WHERE key = $Key AND lhs IS NOT NULL AND rhs IS NOT NULL;

        - name: fromStrings
          source: patterns/strings
          shuffle: { key: [/Key] }
          lambda: |
            INSERT INTO join_state (key, rhs) VALUES ($Key, JSON_ARRAY($String))
            ON CONFLICT (key) DO UPDATE SET rhs = JSON_INSERT(COALESCE(rhs, '[]'), '$[#]', $String);
            -- now emit the joined result
            SELECT JSON_OBJECT(
              'Key', $Key,
              'LHS', lhs,
              'RHS', JSON(rhs)
            )
            FROM join_state
            WHERE key = $Key AND lhs IS NOT NULL AND rhs IS NOT NULL;
   
tests:
  patterns/test/inner-join:
    - ingest:
        collection: patterns/ints
        documents: [{ Key: key, Int: 5 }]
    - verify:
        description: Both sides must be matched before a document is published.
        collection: patterns/inner-join
        documents: []
    - ingest:
        collection: patterns/strings
        documents: [{ Key: key, String: hello }]
    - verify:
        collection: patterns/inner-join
        documents: [{ Key: key, LHS: 5, RHS: [hello] }]
    - ingest:
        collection: patterns/ints
        documents: [{ Key: key, Int: 7 }]
    - ingest:
        collection: patterns/strings
        documents: [{ Key: key, String: goodbye }]
    - verify:
        description: Reacts to accumulated updates of both sides.
        collection: patterns/inner-join
        documents: [{ Key: key, LHS: 12, RHS: [hello, goodbye] }]
