# Run soak-test as:
# go run /workspace/examples/soak-tests/set-ops/generator.go | \
#   pv --rate-limit 100 --line-mode --quiet | \
#   /workspace/.build/tools/websocat --protocol json/v1 ws://localhost:8081/ingest/soak/set-ops/operations
#
# Verify that all documents were processed correctly so far (should return no rows):
#   psql -h localhost --user flow -c 'select * from sets where "DerivedValues"::text != "ExpectValues"::text limit 1;'

collections:
  - name: soak/set-ops/operations
    schema: schema.yaml#/$defs/operation
    key: [/Author, /ID, /Op]
    projections:
      # Partition on /Ones, which is the number of set bits in /ID.
      # This is simply to exercise the regular creation of new partitions.
      Ones:
        location: /Ones
        partition: true

  - name: soak/set-ops/sets
    schema: schema.yaml#/$defs/outputWithReductions
    key: [/Author, /ID]
    projections:
      # Project some non-scalar types that we want to materialize.
      AppliedOps: /AppliedOps
      DerivedValues: /Derived/add
      ExpectValues: /ExpectValues

    derivation:
      transform:
        onOperation:
          source: { name: soak/set-ops/operations }
          shuffle: [/Author, /ID]
          publish:
            nodeJS: &lambda |
              if (source.Type == "add" || source.Type == "remove") {
                let mutate = (source as anchors.MutateOp);

                return [{
                  Author: mutate.Author,
                  ID: mutate.ID,
                  AppliedOps: [mutate.Op],
                  Derived: {
                    [mutate.Type]: mutate.Values,
                  },
                  [mutate.Type == "add" ? "AppliedAdd" : "AppliedRemove"]: 1,
                }];

              }

              let verify = (source as anchors.VerifyOp);

              return [{
                Author: verify.Author,
                ID: verify.ID,
                AppliedOps: [verify.Op],
                ExpectAdd: verify.TotalAdd,
                ExpectRemove: verify.TotalRemove,
                ExpectValues: verify.Values,
              }];

  - name: soak/set-ops/sets-register
    schema: schema.yaml#/$defs/output
    key: [/Author, /ID]
    projections:
      # Project the same non-scalar types as above, for materialization.
      AppliedOps: /AppliedOps
      DerivedValues: /Derived/add
      ExpectValues: /ExpectValues

    derivation:
      # Unlike "soak/set-ops/sets" above, we do all reduction within the
      # derivation register and only output the final value on a "verify" type.
      register:
        schema: schema.yaml#/$defs/outputWithReductions
        initial: { Author: 0, ID: 0 }

      transform:
        onOperation:
          source: { name: soak/set-ops/operations }
          shuffle: [/Author, /ID]
          update: { nodeJS: *lambda }
          publish:
            nodeJS: |
              if (source.Type == "verify") {
                return [register];
              }
              return [];

tests:
  "Set soak-test update and verify":
    - ingest:
        collection: soak/set-ops/operations
        documents:
          - {
              "Author": 17369,
              "ID": 0,
              "Ones": 0,
              "Op": 1,
              "Type": "remove",
              "Values": { "K": 1, "S": 1 },
            }
          - {
              "Author": 17369,
              "ID": 1,
              "Ones": 1,
              "Op": 1,
              "Type": "add",
              "Values": { "H": 1, "K": 1, "M": 1, "Q": 1, "U": 1, "V": 1 },
            }
          - {
              "Author": 17369,
              "ID": 1,
              "Ones": 1,
              "Op": 2,
              "Type": "add",
              "Values": { "A": 1, "C": 1, "F": 1, "L": 1, "U": 1 },
            }
          - {
              "Author": 17369,
              "ID": 0,
              "Ones": 0,
              "Op": 2,
              "Type": "add",
              "Values": { "J": 1, "W": 1 },
            }
          - {
              "Author": 17369,
              "ID": 0,
              "Ones": 0,
              "Op": 3,
              "Type": "verify",
              "TotalAdd": 1,
              "TotalRemove": 1,
              "Values": { "J": 1, "W": 1 },
            }
          - {
              "Author": 17369,
              "ID": 2,
              "Ones": 1,
              "Op": 1,
              "Type": "add",
              "Values": { "K": 1, "T": 1 },
            }
          - {
              "Author": 17369,
              "ID": 2,
              "Ones": 1,
              "Op": 2,
              "Type": "remove",
              "Values":
                { "A": 1, "D": 1, "F": 1, "H": 1, "K": 1, "O": 1, "P": 1 },
            }
          - {
              "Author": 17369,
              "ID": 2,
              "Ones": 1,
              "Op": 3,
              "Type": "verify",
              "TotalAdd": 1,
              "TotalRemove": 1,
              "Values": { "T": 1 },
            }
          - {
              "Author": 17369,
              "ID": 1,
              "Ones": 1,
              "Op": 3,
              "Type": "verify",
              "TotalAdd": 2,
              "TotalRemove": 0,
              "Values":
                {
                  "A": 1,
                  "C": 1,
                  "F": 1,
                  "H": 1,
                  "K": 1,
                  "L": 1,
                  "M": 1,
                  "Q": 1,
                  "U": 2,
                  "V": 1,
                },
            }

    - verify:
        collection: soak/set-ops/sets
        documents: &expected
          - {
              "AppliedAdd": 1,
              "AppliedOps": [1, 2, 3],
              "AppliedRemove": 1,
              "Author": 17369,
              "Derived": { "add": { "J": 1, "W": 1 } },
              "ExpectAdd": 1,
              "ExpectRemove": 1,
              "ExpectValues": { "J": 1, "W": 1 },
              "ID": 0,
            }
          - {
              "AppliedAdd": 2,
              "AppliedOps": [1, 2, 3],
              "Author": 17369,
              "Derived":
                {
                  "add":
                    {
                      "A": 1,
                      "C": 1,
                      "F": 1,
                      "H": 1,
                      "K": 1,
                      "L": 1,
                      "M": 1,
                      "Q": 1,
                      "U": 2,
                      "V": 1,
                    },
                },
              "ExpectAdd": 2,
              "ExpectRemove": 0,
              "ExpectValues":
                {
                  "A": 1,
                  "C": 1,
                  "F": 1,
                  "H": 1,
                  "K": 1,
                  "L": 1,
                  "M": 1,
                  "Q": 1,
                  "U": 2,
                  "V": 1,
                },
              "ID": 1,
            }
          - {
              "AppliedAdd": 1,
              "AppliedOps": [1, 2, 3],
              "AppliedRemove": 1,
              "Author": 17369,
              "Derived": { "add": { "T": 1 } },
              "ExpectAdd": 1,
              "ExpectRemove": 1,
              "ExpectValues": { "T": 1 },
              "ID": 2,
            }

    - verify:
        collection: soak/set-ops/sets-register
        documents: *expected
