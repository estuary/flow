#!/usr/bin/env bash
set -euo pipefail

#MISE description="Copy gcloud CLI and credentials from host to VM for sops/KMS encryption"
#USAGE arg "<vm_name>" help="Name of the VM to copy gcloud credentials to"

VM_NAME="${usage_vm_name}"

# Verify VM exists and is running
if ! limactl list 2>/dev/null | grep -q "^${VM_NAME}"; then
    echo "Error: VM '${VM_NAME}' not found"
    echo "Available VMs:"
    limactl list 2>/dev/null || echo "  (no VMs found)"
    exit 1
fi

if ! limactl list 2>/dev/null | grep "^${VM_NAME}" | grep -q "Running"; then
    echo "Error: VM '${VM_NAME}' is not running"
    echo "Start it with: limactl start ${VM_NAME}"
    exit 1
fi

echo "Copying gcloud CLI and credentials to VM '${VM_NAME}'..."
echo ""

# Get the VM user's home directory
VM_HOME=$(limactl shell "${VM_NAME}" -- bash -c 'echo $HOME')
echo "VM home directory: ${VM_HOME}"
echo ""

# Check if gcloud is installed on host
if ! command -v gcloud &> /dev/null; then
    echo "Error: gcloud CLI not found on host"
    echo ""
    echo "Install it with:"
    echo "  macOS: brew install google-cloud-sdk"
    echo "  Linux: https://cloud.google.com/sdk/docs/install"
    exit 1
fi

GCLOUD_PATH=$(command -v gcloud)
echo "Host gcloud location: ${GCLOUD_PATH}"

# Check if gcloud config directory exists on host
if [ ! -d "${HOME}/.config/gcloud" ]; then
    echo "Error: gcloud configuration not found at ~/.config/gcloud"
    echo ""
    echo "Please authenticate with:"
    echo "  gcloud auth login"
    echo "  gcloud auth application-default login"
    exit 1
fi

# Install gcloud in the VM if not present
echo "Installing gcloud CLI in VM..."
limactl shell "${VM_NAME}" -- bash -c '
    if ! command -v gcloud &> /dev/null; then
        echo "  Installing google-cloud-sdk..."

        # Add Google Cloud SDK repo
        echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | \
            sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list

        # Import the Google Cloud public key
        curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | \
            sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg

        # Update and install
        sudo apt-get update -qq
        sudo apt-get install -y -qq google-cloud-sdk

        echo "  ✓ gcloud CLI installed"
    else
        echo "  ✓ gcloud CLI already installed"
    fi
'

# Create .config/gcloud directory on VM
limactl shell "${VM_NAME}" -- mkdir -p "${VM_HOME}/.config/gcloud"

# Copy gcloud configuration
echo ""
echo "Copying gcloud configuration..."

# Copy the entire gcloud config directory
# This includes:
# - application_default_credentials.json (ADC)
# - credentials.db (user credentials)
# - configurations/ (named configurations)
# - config_sentinel (config file)
# - access_tokens.db (cached tokens)

# Use tar to preserve permissions and directory structure
cd "${HOME}/.config" && tar czf - gcloud | \
    limactl shell "${VM_NAME}" -- tar xzf - -C "${VM_HOME}/.config/"

echo "  ✓ gcloud configuration copied"

# Set proper permissions
limactl shell "${VM_NAME}" -- chmod -R 700 "${VM_HOME}/.config/gcloud"

# Find and protect sensitive credential files
limactl shell "${VM_NAME}" -- bash -c "
    find ${VM_HOME}/.config/gcloud -name '*credentials*.json' -exec chmod 600 {} \;
    find ${VM_HOME}/.config/gcloud -name '*.db' -exec chmod 600 {} \;
"

# Test gcloud authentication
echo ""
echo "Testing gcloud authentication..."
if limactl shell "${VM_NAME}" -- gcloud auth list 2>&1 | grep -q "ACTIVE"; then
    ACTIVE_ACCOUNT=$(limactl shell "${VM_NAME}" -- gcloud auth list --filter=status:ACTIVE --format="value(account)")
    echo "  ✓ gcloud authenticated as: ${ACTIVE_ACCOUNT}"
else
    echo "  ⚠ Warning: No active gcloud account found"
    echo "    This is expected if you haven't run 'gcloud auth login' on the host"
fi

# Test application default credentials (needed for sops)
echo ""
echo "Testing Application Default Credentials (ADC)..."
ADC_FILE="${HOME}/.config/gcloud/application_default_credentials.json"
if [ -f "${ADC_FILE}" ]; then
    echo "  ✓ ADC file found and copied"

    # Verify sops can access GCP KMS
    echo ""
    echo "Testing sops with GCP KMS..."
    if limactl shell "${VM_NAME}" -- bash -c 'command -v sops &> /dev/null'; then
        echo "  ✓ sops is installed"

        # Try a simple encryption test (will fail if credentials don't work)
        TEST_KMS="projects/estuary-control/locations/us-central1/keyRings/pulumi/cryptoKeys/state-secrets"
        if limactl shell "${VM_NAME}" -- bash -c "echo '{\"test\": \"value\"}' | sops --encrypt --gcp-kms ${TEST_KMS} --input-type json --output-type json /dev/stdin > /dev/null 2>&1"; then
            echo "  ✓ sops can encrypt with GCP KMS"
        else
            echo "  ⚠ Warning: sops encryption test failed"
            echo "    This may be due to:"
            echo "    - Missing KMS permissions for the authenticated account"
            echo "    - Network connectivity issues"
            echo "    - Invalid KMS key path"
        fi
    else
        echo "  ⚠ sops not installed in VM (will be installed by bootstrap tasks)"
    fi
else
    echo "  ⚠ Warning: Application Default Credentials not found"
    echo ""
    echo "    To set up ADC on the host:"
    echo "    1. Run: gcloud auth application-default login"
    echo "    2. Re-run this task to copy the credentials"
    echo ""
    echo "    ADC is required for sops to access GCP KMS for encryption/decryption"
fi

echo ""
echo "✓ gcloud credentials copied successfully!"
echo ""
echo "The data-plane-controller can now use sops with GCP KMS for encryption."
echo ""
echo "Note: Ensure the authenticated account has the 'Cloud KMS CryptoKey Encrypter/Decrypter' role:"
echo "  https://console.cloud.google.com/iam-admin/iam?project=estuary-control"
