#!/usr/bin/env bash
set -euo pipefail

#MISE description="Copy SSH credentials from host to VM for git repository access"
#USAGE arg "<vm_name>" help="Name of the VM to copy SSH credentials to"
#USAGE flag "--keys <keys>" help="Comma-separated list of SSH key names to copy (e.g., 'id_rsa,id_ed25519'). Defaults to auto-detect."

VM_NAME="${usage_vm_name}"
SPECIFIED_KEYS="${usage_keys:-}"

# Verify VM exists and is running
if ! limactl list 2>/dev/null | grep -q "^${VM_NAME}"; then
    echo "Error: VM '${VM_NAME}' not found"
    echo "Available VMs:"
    limactl list 2>/dev/null || echo "  (no VMs found)"
    exit 1
fi

if ! limactl list 2>/dev/null | grep "^${VM_NAME}" | grep -q "Running"; then
    echo "Error: VM '${VM_NAME}' is not running"
    echo "Start it with: limactl start ${VM_NAME}"
    exit 1
fi

echo "Copying SSH credentials to VM '${VM_NAME}'..."
echo ""

# Get the VM user's home directory
VM_HOME=$(limactl shell "${VM_NAME}" -- bash -c 'echo $HOME')
echo "VM home directory: ${VM_HOME}"
echo ""

# Determine which SSH keys to copy
if [ -n "${SPECIFIED_KEYS}" ]; then
    # Use specified keys
    IFS=',' read -ra KEY_NAMES <<< "${SPECIFIED_KEYS}"
else
    # Auto-detect common SSH key types
    KEY_NAMES=()
    for key_type in id_rsa id_ed25519 id_ecdsa; do
        if [ -f "${HOME}/.ssh/${key_type}" ]; then
            KEY_NAMES+=("${key_type}")
        fi
    done

    if [ ${#KEY_NAMES[@]} -eq 0 ]; then
        echo "Error: No SSH keys found in ~/.ssh/ on the host"
        echo "Looked for: id_rsa, id_ed25519, id_ecdsa"
        echo ""
        echo "Generate a key with: ssh-keygen -t ed25519 -C 'your_email@example.com'"
        exit 1
    fi
fi

# Create .ssh directory on VM if it doesn't exist
limactl shell "${VM_NAME}" -- mkdir -p "${VM_HOME}/.ssh"
limactl shell "${VM_NAME}" -- chmod 700 "${VM_HOME}/.ssh"

# Copy each SSH key and its public key
for key_name in "${KEY_NAMES[@]}"; do
    private_key="${HOME}/.ssh/${key_name}"
    public_key="${private_key}.pub"

    if [ ! -f "${private_key}" ]; then
        echo "Warning: ${private_key} not found, skipping"
        continue
    fi

    echo "Copying ${key_name}..."

    # Copy private key
    cat "${private_key}" | limactl shell "${VM_NAME}" -- tee ${VM_HOME}/.ssh/${key_name} > /dev/null
    limactl shell "${VM_NAME}" -- chmod 600 ${VM_HOME}/.ssh/${key_name}

    # Copy public key if it exists
    if [ -f "${public_key}" ]; then
        cat "${public_key}" | limactl shell "${VM_NAME}" -- tee ${VM_HOME}/.ssh/${key_name}.pub > /dev/null
        limactl shell "${VM_NAME}" -- chmod 644 ${VM_HOME}/.ssh/${key_name}.pub
    fi

    echo "  ✓ ${key_name} copied"
done

# Copy known_hosts if it exists
if [ -f "${HOME}/.ssh/known_hosts" ]; then
    echo "Copying known_hosts..."
    cat "${HOME}/.ssh/known_hosts" | limactl shell "${VM_NAME}" -- tee ${VM_HOME}/.ssh/known_hosts > /dev/null
    limactl shell "${VM_NAME}" -- chmod 644 ${VM_HOME}/.ssh/known_hosts
    echo "  ✓ known_hosts copied"
fi

# Copy SSH config if it exists, but filter out host-specific options
if [ -f "${HOME}/.ssh/config" ]; then
    echo "Copying SSH config (filtered)..."
    # Filter out:
    # - Lima includes (host-specific)
    # - UseKeychain (macOS-specific)
    # - Other macOS-specific options
    grep -v "Include.*lima" "${HOME}/.ssh/config" | \
        grep -iv "UseKeychain" | \
        grep -iv "AddKeysToAgent.*keychain" | \
        limactl shell "${VM_NAME}" -- tee ${VM_HOME}/.ssh/config > /dev/null || true
    limactl shell "${VM_NAME}" -- chmod 644 ${VM_HOME}/.ssh/config
    echo "  ✓ SSH config copied (host-specific options filtered out)"
fi

# Test SSH access to GitHub
echo ""
echo "Testing SSH access to GitHub..."
if limactl shell "${VM_NAME}" -- ssh -T git@github.com 2>&1 | grep -q "successfully authenticated"; then
    echo "  ✓ GitHub SSH access verified"
else
    echo "  ⚠ Warning: GitHub SSH authentication test failed"
    echo "    This is expected if your SSH key is not registered with GitHub"
    echo "    or if you don't have access to the required repositories."
    echo ""
    echo "    To add your SSH key to GitHub:"
    echo "    1. Display your public key: cat ~/.ssh/id_*.pub"
    echo "    2. Add it to GitHub: https://github.com/settings/keys"
fi

echo ""
echo "✓ SSH credentials copied successfully!"
echo ""
echo "The data-plane-controller can now clone git repositories from the VM."
