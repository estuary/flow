#!/usr/bin/env bash
set -euo pipefail

#MISE description="Start data-plane-controller in dry-run mode via systemd"
#MISE depends=["local:common", "local:supabase"]

FLOW_LOCAL="${HOME}/flow-local"
mkdir -p "${FLOW_LOCAL}/env"

cat > "${FLOW_LOCAL}/env/data-plane-controller.env" <<EOF
# Data Plane Controller environment (dry-run mode)
# Generated by mise ($(date))

DPC_DATABASE_URL=postgresql://postgres:postgres@db.flow.localhost:5432/postgres
DPC_CONCURRENCY=2
DPC_DEQUEUE_INTERVAL=5s
DPC_HEARTBEAT_TIMEOUT=30s
DPC_GIT_REPO=git@github.com:estuary/est-dry-dock.git
DPC_OPS_GIT_REPO=git@github.com:estuary/ops.git
RUST_LOG=info,data_plane_controller=debug
NO_COLOR=1

EOF

# Ensure systemd unit is installed
UNIT=flow-data-plane-controller.service
UNIT_FILE="${HOME}/.config/systemd/user/${UNIT}"
if [ ! -f "$UNIT_FILE" ]; then
    ln -sf "$(pwd)/local/systemd/${UNIT}" "$UNIT_FILE"
fi

systemctl --user daemon-reload
systemctl --user start flow-data-plane-controller.service

echo "Data-plane-controller started in dry-run mode."
echo "  Status: systemctl --user status flow-data-plane-controller"
echo "  Logs:   journalctl --user -u flow-data-plane-controller -f"
echo ""
echo "NOTE: Dry-run mode simulates Pulumi/Ansible commands without executing them."
echo "      No cloud infrastructure changes will be made."
