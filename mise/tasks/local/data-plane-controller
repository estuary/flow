#!/usr/bin/env bash
set -euo pipefail

#MISE description="Start data-plane-controller (service + job) in dry-run mode via systemd"
#MISE depends=["local:common", "local:supabase"]

FLOW_LOCAL="${HOME}/flow-local"
mkdir -p "${FLOW_LOCAL}/env"

# Create environment file for the Service (Worker)
cat > "${FLOW_LOCAL}/env/data-plane-controller-service.env" <<EOF
# Data Plane Controller Service environment
# Generated by mise ($(date))

DPC_DATABASE_URL=postgresql://postgres:postgres@db.flow.localhost:5432/postgres
DPC_PORT=8080
RUST_LOG=info,data_plane_controller=debug
NO_COLOR=1

EOF

# Create environment file for the Job (Dispatcher)
cat > "${FLOW_LOCAL}/env/data-plane-controller-job.env" <<EOF
# Data Plane Controller Job environment (dry-run mode)
# Generated by mise ($(date))

DPC_DATABASE_URL=postgresql://postgres:postgres@db.flow.localhost:5432/postgres
DPC_CONCURRENCY=2
DPC_DEQUEUE_INTERVAL=5s
DPC_HEARTBEAT_TIMEOUT=30s
DPC_GIT_REPO=git@github.com:estuary/est-dry-dock.git
DPC_OPS_GIT_REPO=git@github.com:estuary/ops.git
DPC_SERVICE_URL=http://localhost:8080
RUST_LOG=info,data_plane_controller=debug
NO_COLOR=1

EOF

# Ensure systemd units are installed
SERVICE_UNIT=flow-data-plane-controller-service.service
JOB_UNIT=flow-data-plane-controller-job.service

SERVICE_UNIT_FILE="${HOME}/.config/systemd/user/${SERVICE_UNIT}"
JOB_UNIT_FILE="${HOME}/.config/systemd/user/${JOB_UNIT}"

if [ ! -f "$SERVICE_UNIT_FILE" ]; then
    ln -sf "$(pwd)/local/systemd/${SERVICE_UNIT}" "$SERVICE_UNIT_FILE"
fi

if [ ! -f "$JOB_UNIT_FILE" ]; then
    ln -sf "$(pwd)/local/systemd/${JOB_UNIT}" "$JOB_UNIT_FILE"
fi

systemctl --user daemon-reload

# Start service first, then job (job depends on service)
systemctl --user start flow-data-plane-controller-service.service
echo "✓ Service started"

# Give service a moment to start
sleep 2

systemctl --user start flow-data-plane-controller-job.service
echo "✓ Job started"

echo ""
echo "Data-plane-controller started in dry-run mode (Job + Service architecture)."
echo ""
echo "  Service Status: systemctl --user status flow-data-plane-controller-service"
echo "  Service Logs:   journalctl --user -u flow-data-plane-controller-service -f"
echo ""
echo "  Job Status:     systemctl --user status flow-data-plane-controller-job"
echo "  Job Logs:       journalctl --user -u flow-data-plane-controller-job -f"
echo ""
echo "  Stop Both:      systemctl --user stop flow-data-plane-controller-job flow-data-plane-controller-service"
echo ""
echo "NOTE: Dry-run mode simulates Pulumi/Ansible commands without executing them."
echo "      No cloud infrastructure changes will be made."
