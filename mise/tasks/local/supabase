#!/usr/bin/env bash
set -euo pipefail

#MISE description="Start Supabase via systemd"
#MISE depends=["local:common"]
#USAGE flag "--no-block" help="Do not wait for service to start"

NO_BLOCK="${usage_no_block:-false}"
FLOW_LOCAL="${HOME}/flow-local"

cat > "${FLOW_LOCAL}/env/supabase-functions.env" <<EOF
# Environment for Supabase edge functions
# Generated by mise ($(date))

# Use local config encryption service.
CONFIG_ENCRYPTION_URL=http://host.docker.internal:8765/v1/encrypt-config
EOF

UNIT_FILE="${HOME}/.config/systemd/user/flow-supabase.service"
if [ ! -f "$UNIT_FILE" ]; then
    ln -sf "$(pwd)/local/systemd/flow-supabase.service" "$UNIT_FILE"
    systemctl --user daemon-reload
fi

if [ "${NO_BLOCK}" = "true" ]; then
    systemctl --user start --no-block flow-supabase
    echo "Supabase starting (non-blocking). Wait for completion with: systemctl --user start flow-supabase"
else
    systemctl --user start flow-supabase
    echo "Supabase started."
fi

echo "Check status with: systemctl --user status flow-supabase"
echo "View logs with: journalctl --user -u flow-supabase -f"
echo "Database accessible at: postgresql://postgres:postgres@db.flow.localhost:5432/postgres"
