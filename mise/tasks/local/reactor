#!/usr/bin/env bash
set -euo pipefail

#MISE description="Start flow reactor via systemd"
#USAGE arg "<data_plane>" help="Name of the data plane"
#USAGE arg "<base_port>" help="Base port for reactor(s)"
#USAGE arg "<broker_port>" help="Seed port to discover broker cluster"
#USAGE flag "--count <count>" default="1" help="Number of reactors to start"

DATA_PLANE="${usage_data_plane}"
BASE_PORT="${usage_base_port}"
BROKER_PORT="${usage_broker_port}"
COUNT="${usage_count}"

FLOW_LOCAL="${HOME}/flow-local"
HMAC_KEY=$(echo -n "key-${DATA_PLANE}" | base64 | tr -d '\n')

# Configure all reactor instances
for i in $(seq 0 $((COUNT - 1))); do
    REACTOR_PORT=$((BASE_PORT + i))
    INSTANCE="${DATA_PLANE}-${REACTOR_PORT}"

    # Generate reactor instance-specific environment file
    cat > "${FLOW_LOCAL}/env/reactor-${INSTANCE}.env" <<EOF
# Reactor environment for ${INSTANCE}
# Generated by mise ($(date))

# Authorization keys are the base64-encoding of "key-${DATA_PLANE}".

# Note the local cert is signed with a wildcard of *.flow.localhost,
# and CONSUMER_HOST must match for the connector networking feature to function.
# SSL_CERT_FILE is required for calls to the control agent API.

BROKER_ADDRESS=https://broker-${DATA_PLANE}.flow.localhost:${BROKER_PORT}
BROKER_AUTH_KEYS=${HMAC_KEY}
BROKER_CACHE_SIZE=128
BROKER_FILE_ROOT=${FLOW_LOCAL}/fragments/${DATA_PLANE}/
BROKER_TRUSTED_CA_FILE=${FLOW_LOCAL}/ca.crt
CONSUMER_ALLOW_ORIGIN=http://localhost:3000
CONSUMER_AUTH_KEYS=${HMAC_KEY}
CONSUMER_HOST=reactor-${DATA_PLANE}.flow.localhost
CONSUMER_LIMIT=1024
CONSUMER_PEER_CA_FILE=${FLOW_LOCAL}/ca.crt
CONSUMER_PORT=${REACTOR_PORT}
CONSUMER_SERVER_CERT_FILE=${FLOW_LOCAL}/server.crt
CONSUMER_SERVER_CERT_KEY_FILE=${FLOW_LOCAL}/server.key
ETCD_ADDRESS=http://etcd.flow.localhost:2379
ETCD_PREFIX=/flow/${DATA_PLANE}
FLOW_ALLOW_LOCAL=true
FLOW_BUILDS_ROOT=file://${FLOW_LOCAL}/builds/
FLOW_CONTROL_API=http://agent.flow.localhost:8675
FLOW_DASHBOARD=http://localhost:3000
FLOW_DATA_PLANE_FQDN=${DATA_PLANE}.dp.estuary-data.com
FLOW_NETWORK=supabase_network_flow
LOG_LEVEL=info
SSL_CERT_FILE=${FLOW_LOCAL}/ca.crt # Required for agent API calls.

# Test (non-production) key for local development.
# This matches KMS_KEY in the control-plane development task.
SOPS_AGE_KEY=AGE-SECRET-KEY-1UX6ZHA36JJZCFCV9U7FVHZZECHCCKA8NCFT27L68HV0NPRQ2V5ZSRKJJPU
EOF

    # Create drop-in configuration that binds this instance <=> data plane.
    DROPIN_DIR="${HOME}/.config/systemd/user/flow-reactor@${INSTANCE}.service.d"
    mkdir -p "$DROPIN_DIR"
    cat > "${DROPIN_DIR}/plane.conf" <<EOF
[Unit]
PartOf=flow-plane@${DATA_PLANE}.target
After=flow-plane@${DATA_PLANE}.target
EOF

    DROPIN_DIR="${HOME}/.config/systemd/user/flow-plane@${DATA_PLANE}.target.d"
    mkdir -p "$DROPIN_DIR"
    cat > "${DROPIN_DIR}/wants-reactor-${INSTANCE}.conf" <<EOF
[Unit]
Wants=flow-reactor@${INSTANCE}.service
EOF

    echo "Created flow-reactor@${INSTANCE}"
done

# Ensure template units are installed
TEMPLATE_UNIT="${HOME}/.config/systemd/user/flow-reactor@.service"
if [ ! -f "$TEMPLATE_UNIT" ]; then
    ln -sf "$(pwd)/local/systemd/flow-plane@.target" "${HOME}/.config/systemd/user/flow-plane@.target"
    ln -sf "$(pwd)/local/systemd/flow-reactor@.service" "$TEMPLATE_UNIT"
fi

systemctl --user daemon-reload
systemctl --user start "flow-plane@${DATA_PLANE}.target"