#!/usr/bin/env bash
set -euo pipefail

#MISE description="Start data plane with gazette brokers and reactors"
#MISE depends=["build:connector-init", "build:rocksdb", "local:common", "local:tls-cert", "local:etcd"]
#USAGE arg "<data_plane>" help="Name of the data plane"
#USAGE arg "<base_port>" help="Base port block for data plane services (must be divisible by 100, e.g., 8100, 9600)"
#USAGE flag "--num-brokers <num_brokers>" help="Number of broker instances"
#USAGE flag "--num-reactors <num_reactors>" help="Number of reactor instances"
#USAGE flag "--link" help="Link data plane to control plane via API"
#USAGE flag "--dekaf" help="Start Dekaf for this data plane"

DATA_PLANE="${usage_data_plane:?}"
PORT_BLOCK="${usage_base_port:?}"
N_BROKERS="${usage_num_brokers:-0}"
N_REACTORS="${usage_num_reactors:-0}"
LINK="${usage_link:-false}"
DEKAF="${usage_dekaf:-false}"

# Validate that base port is divisible by 100
if [ $((PORT_BLOCK % 100)) -ne 0 ]; then
    echo "Error: Port block ${PORT_BLOCK} must be divisible by 100 (e.g., 8100, 9600)" >&2
    exit 1
fi

# Validate that we don't exceed the 100-port block limit
TOTAL_INSTANCES=$((N_BROKERS + N_REACTORS))
if [ "${TOTAL_INSTANCES}" -gt 100 ]; then
    echo "Error: Total instances (${N_BROKERS} brokers + ${N_REACTORS} reactors = ${TOTAL_INSTANCES}) exceeds 100-port block limit" >&2
    exit 1
fi

FLOW_LOCAL="${HOME}/flow-local"
HMAC_KEY=$(echo -n "key-${DATA_PLANE}" | base64 | tr -d '\n')

# Deterministic Dekaf port allocation within the 100-port block
DEKAF_KAFKA_PORT=$((PORT_BLOCK + 50))
DEKAF_REGISTRY_PORT=$((PORT_BLOCK + 51))
DEKAF_METRICS_PORT=$((PORT_BLOCK + 52))

# Start broker instances if requested
if [ "${N_BROKERS}" -gt 0 ] 2>/dev/null; then
    # Brokers count upward from block start (e.g., 8100, 8101, 8102)
    mise run local:gazette ${DATA_PLANE} ${PORT_BLOCK} --count ${N_BROKERS}
fi

# Start reactor instances if requested
if [ "${N_REACTORS}" -gt 0 ] 2>/dev/null; then
    # Reactors count downward from block end (e.g., 8199, 8198, 8197)
    # Use the first broker port for discovery
    mise run local:reactor ${DATA_PLANE} $((PORT_BLOCK + 100 - N_REACTORS)) ${PORT_BLOCK} --count ${N_REACTORS}
fi

if [ "${DEKAF}" = "true" ]; then
    # Dekaf requires upstream Kafka for consumer group management
    mise run local:dekaf-kafka

    cargo build -p dekaf --quiet

    DATA_PLANE_FQDN="${DATA_PLANE}.dp.estuary-data.com"

    cat > "${FLOW_LOCAL}/env/dekaf-${DATA_PLANE}.env" <<EOF
# Dekaf environment for ${DATA_PLANE}
# Generated by mise ($(date))

DATA_PLANE_FQDN=${DATA_PLANE_FQDN}
DATA_PLANE_ACCESS_KEY=${HMAC_KEY}
DEKAF_KAFKA_PORT=${DEKAF_KAFKA_PORT}
DEKAF_REGISTRY_PORT=${DEKAF_REGISTRY_PORT}
DEKAF_METRICS_PORT=${DEKAF_METRICS_PORT}
DEKAF_UPSTREAM_PORT=29092
DEKAF_ENCRYPTION_SECRET=test-encryption-secret-32-bytes!
SSL_CERT_FILE=${FLOW_LOCAL}/ca.crt
RUST_LOG=dekaf=debug,info
EOF

    # Create drop-in to bind Dekaf service to dataplane target
    DROPIN_DIR="${HOME}/.config/systemd/user/flow-dekaf@${DATA_PLANE}.service.d"
    mkdir -p "$DROPIN_DIR"
    cat > "${DROPIN_DIR}/plane.conf" <<EOF
[Unit]
PartOf=flow-plane@${DATA_PLANE}.target
EOF

    # Add Dekaf to dataplane target's Wants
    DROPIN_DIR="${HOME}/.config/systemd/user/flow-plane@${DATA_PLANE}.target.d"
    mkdir -p "$DROPIN_DIR"
    cat > "${DROPIN_DIR}/wants-dekaf.conf" <<EOF
[Unit]
Wants=flow-dekaf@${DATA_PLANE}.service
EOF

    TEMPLATE_UNIT="${HOME}/.config/systemd/user/flow-dekaf@.service"
    if [ ! -f "$TEMPLATE_UNIT" ]; then
        ln -sf "$(pwd)/local/systemd/flow-dekaf@.service" "$TEMPLATE_UNIT"
    fi

    systemctl --user daemon-reload

    # Always restart to apply current configuration from env file
    if ! systemctl --user restart "flow-dekaf@${DATA_PLANE}.service"; then
        echo "flow-dekaf@${DATA_PLANE} failed to start. Logs:"
        journalctl --user -u "flow-dekaf@${DATA_PLANE}.service" --no-pager
        exit 1
    fi

    echo "Dekaf for ${DATA_PLANE} started on ports: Kafka=${DEKAF_KAFKA_PORT}, Registry=${DEKAF_REGISTRY_PORT}, Metrics=${DEKAF_METRICS_PORT}"
fi

# Link data plane to control plane if requested
if [ "${LINK}" = "true" ]; then

    # Generate environment file for the link service
    cat > "${FLOW_LOCAL}/env/plane-link-${DATA_PLANE}.env" <<EOF
# Data plane link environment for ${DATA_PLANE}
# Generated by mise ($(date))

# Required for agent API calls
SSL_CERT_FILE=${FLOW_LOCAL}/ca.crt

# A token for the local-stack system user signed against the local-stack
# supabase secret (super-secret-jwt-token-with-at-least-32-characters-long).
SYSTEM_USER_TOKEN=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJodHRwOi8vMTI3LjAuMC4xOjU0MzEvYXV0aC92MSIsInN1YiI6ImZmZmZmZmZmLWZmZmYtZmZmZi1mZmZmLWZmZmZmZmZmZmZmZiIsImF1ZCI6ImF1dGhlbnRpY2F0ZWQiLCJleHAiOjI3MDAwMDAwMDAsImlhdCI6MTcwMDAwMDAwMCwiZW1haWwiOiJzdXBwb3J0QGVzdHVhcnkuZGV2Iiwicm9sZSI6ImF1dGhlbnRpY2F0ZWQiLCJpc19hbm9ueW1vdXMiOmZhbHNlfQ.Nb-N4s_YnObBHGivSTe_8FEniVUUpehzrRkF5JgNWWU

# Data for JSON payload (simple key-value pairs without escaping issues)
DATA_PLANE_NAME=${DATA_PLANE}
BROKER_ADDRESS=https://broker-${DATA_PLANE}.flow.localhost:${PORT_BLOCK}
REACTOR_ADDRESS=https://reactor-${DATA_PLANE}.flow.localhost:$((PORT_BLOCK + 99))
HMAC_KEY=${HMAC_KEY}
EOF

    if [ "${DEKAF}" = "true" ]; then
        echo "DEKAF_ADDRESS=tcp://127.0.0.1:${DEKAF_KAFKA_PORT}" >> "${FLOW_LOCAL}/env/plane-link-${DATA_PLANE}.env"
        echo "DEKAF_REGISTRY_ADDRESS=http://127.0.0.1:${DEKAF_REGISTRY_PORT}" >> "${FLOW_LOCAL}/env/plane-link-${DATA_PLANE}.env"
    fi

    # Create drop-in configuration that binds this link service <=> data plane target
    DROPIN_DIR="${HOME}/.config/systemd/user/flow-plane-link@${DATA_PLANE}.service.d"
    mkdir -p "$DROPIN_DIR"
    cat > "${DROPIN_DIR}/plane.conf" <<EOF
[Unit]
PartOf=flow-plane@${DATA_PLANE}.target
After=flow-plane@${DATA_PLANE}.target
After=flow-gazette@${DATA_PLANE}-${PORT_BLOCK}.service
After=flow-reactor@${DATA_PLANE}-$((PORT_BLOCK + 99)).service
EOF

    DROPIN_DIR="${HOME}/.config/systemd/user/flow-plane@${DATA_PLANE}.target.d"
    mkdir -p "$DROPIN_DIR"
    cat > "${DROPIN_DIR}/wants-link-${DATA_PLANE}.conf" <<EOF
[Unit]
Wants=flow-plane-link@${DATA_PLANE}.service
EOF

    # Ensure template unit is installed
    TEMPLATE_UNIT="${HOME}/.config/systemd/user/flow-plane-link@.service"
    if [ ! -f "$TEMPLATE_UNIT" ]; then
        ln -sf "$(pwd)/local/systemd/flow-plane-link@.service" "$TEMPLATE_UNIT"
    fi

    systemctl --user daemon-reload
    systemctl --user start "flow-plane-link@${DATA_PLANE}.service"
fi

STATUS="systemctl --user list-dependencies flow-plane@${DATA_PLANE}.target"
echo "Created flow-plane@${DATA_PLANE}.target (See: ${STATUS})"
exec ${STATUS}
