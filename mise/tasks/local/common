#!/usr/bin/env bash
set -euo pipefail

#MISE description="Generate common environment file for systemd services"

FLOW_LOCAL="${HOME}/flow-local"

mkdir -p "${FLOW_LOCAL}/env"
mkdir -p "${HOME}/.config/systemd/user"

# Generate common environment file
cat > "${FLOW_LOCAL}/env/common.env" <<EOF
# Common environment for Flow development services
# Generated by mise ($(date))

# PATH includes mise-installed binaries, cargo target directories for debug
# and musl-debug binaries, and the Go bin dir.

CARGO_TARGET_DIR="${CARGO_TARGET_DIR}"
CGO_CFLAGS="${CGO_CFLAGS}"
CGO_CPPFLAGS="${CGO_CPPFLAGS}"
CGO_LDFLAGS="${CGO_LDFLAGS}"
FLOW_ROOT="$(pwd)"
JEMALLOC_OVERRIDE="${JEMALLOC_OVERRIDE}"
PATH="${PATH}:${CARGO_TARGET_DIR}/debug/:${CARGO_TARGET_DIR}/$(uname -m)-unknown-linux-musl/debug/:${HOME}/go/bin/"
ROCKSDB_INCLUDE_DIR="${ROCKSDB_INCLUDE_DIR}"
ROCKSDB_LIB_DIR="${ROCKSDB_LIB_DIR}"
ROCKSDB_VERSION="${ROCKSDB_VERSION}"
RUSTFLAGS="${RUSTFLAGS}"
SNAPPY_LIB_DIR="${SNAPPY_LIB_DIR}"
SNAPPY_STATIC="${SNAPPY_STATIC}"

EOF
