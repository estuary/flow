#!/usr/bin/env bash
set -euo pipefail

#MISE description="Start gazette broker via systemd"
#USAGE arg "<data_plane>" help="Name of the data plane"
#USAGE arg "<base_port>" help="Base port for broker(s)"
#USAGE flag "--count <count>" default="1" help="Number of brokers to start"

DATA_PLANE="${usage_data_plane}"
BASE_PORT="${usage_base_port}"
COUNT="${usage_count}"

FLOW_LOCAL="${HOME}/flow-local"
HMAC_KEY=$(echo -n "key-${DATA_PLANE}" | base64 | tr -d '\n')

# Ensure fragment directory exists.
mkdir -p ${FLOW_LOCAL}/fragments/${DATA_PLANE}/

# Configure all broker instances
for i in $(seq 0 $((COUNT - 1))); do
    BROKER_PORT=$((BASE_PORT + i))
    INSTANCE="${DATA_PLANE}-${BROKER_PORT}"

    # Generate gazette instance-specific environment file
    cat > "${FLOW_LOCAL}/env/gazette-${INSTANCE}.env" <<EOF
# Gazette broker environment for ${INSTANCE}
# Generated by mise ($(date))

# Authorization keys are the base64-encoding of "key-${DATA_PLANE}".

BROKER_ALLOW_ORIGIN=http://localhost:3000
BROKER_AUTH_KEYS=${HMAC_KEY}
BROKER_AUTO_SUSPEND=true
BROKER_FILE_ONLY=true
BROKER_FILE_ROOT=${FLOW_LOCAL}/fragments/${DATA_PLANE}/
BROKER_HOST=broker-${DATA_PLANE}.flow.localhost
BROKER_PEER_CA_FILE=${FLOW_LOCAL}/ca.crt
BROKER_PORT=${BROKER_PORT}
BROKER_SERVER_CERT_FILE=${FLOW_LOCAL}/server.crt
BROKER_SERVER_CERT_KEY_FILE=${FLOW_LOCAL}/server.key
ETCD_ADDRESS=http://etcd.flow.localhost:2379
ETCD_PREFIX=/gazette/${DATA_PLANE}
LOG_LEVEL=info
EOF

    # Create drop-in configuration that binds this instance <=> data plane.
    DROPIN_DIR="${HOME}/.config/systemd/user/flow-gazette@${INSTANCE}.service.d"
    mkdir -p "$DROPIN_DIR"
    cat > "${DROPIN_DIR}/plane.conf" <<EOF
[Unit]
PartOf=flow-plane@${DATA_PLANE}.target
After=flow-plane@${DATA_PLANE}.target
EOF

    DROPIN_DIR="${HOME}/.config/systemd/user/flow-plane@${DATA_PLANE}.target.d"
    mkdir -p "$DROPIN_DIR"
    cat > "${DROPIN_DIR}/wants-gazette-${INSTANCE}.conf" <<EOF
[Unit]
Wants=flow-gazette@${INSTANCE}.service
EOF

    echo "Created flow-gazette@${INSTANCE}"
done

# Ensure template units are installed
TEMPLATE_UNIT="${HOME}/.config/systemd/user/flow-gazette@.service"
if [ ! -f "$TEMPLATE_UNIT" ]; then
    ln -sf "$(pwd)/local/systemd/flow-plane@.target" "${HOME}/.config/systemd/user/flow-plane@.target"
    ln -sf "$(pwd)/local/systemd/flow-gazette@.service" "$TEMPLATE_UNIT"
fi

systemctl --user daemon-reload
systemctl --user start "flow-plane@${DATA_PLANE}.target"