#!/usr/bin/env bash
set -euo pipefail

#MISE description="Start Dekaf against local stack"
#MISE depends=["local:dekaf-kafka", "local:tls-cert"]

FLOW_LOCAL="${HOME}/flow-local"

# Generate Dekaf environment file
# The data plane access key must match what's in the data_planes table
# For local-cluster: echo -n "key-local-cluster" | base64
DATA_PLANE_ACCESS_KEY=$(echo -n "key-local-cluster" | base64 | tr -d '\n')

cat > "${FLOW_LOCAL}/env/dekaf.env" <<EOF
# Dekaf environment
# Generated by mise ($(date))

DEKAF_KAFKA_PORT=9092
DEKAF_REGISTRY_PORT=9093
DEKAF_METRICS_PORT=9094
DEKAF_UPSTREAM_PORT=29092
DEKAF_ENCRYPTION_SECRET=test-encryption-secret-32-bytes!
DATA_PLANE_ACCESS_KEY=${DATA_PLANE_ACCESS_KEY}
SSL_CERT_FILE=${FLOW_LOCAL}/ca.crt
RUST_LOG=dekaf=debug,info
EOF

UNIT_FILE="${HOME}/.config/systemd/user/flow-dekaf.service"
if [ ! -f "$UNIT_FILE" ]; then
    ln -sf "$(pwd)/local/systemd/flow-dekaf.service" "$UNIT_FILE"
    systemctl --user daemon-reload
fi

systemctl --user start flow-dekaf
