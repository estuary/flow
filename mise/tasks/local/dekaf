#!/usr/bin/env bash
set -euo pipefail

#MISE description="Start Dekaf against local stack"
#MISE depends=["local:dekaf-kafka", "local:tls-cert"]

FLOW_LOCAL="${HOME}/flow-local"

# Generate Dekaf environment file
cat > "${FLOW_LOCAL}/env/dekaf.env" <<EOF
# Dekaf environment
# Generated by mise ($(date))

DEKAF_KAFKA_PORT=9092
DEKAF_REGISTRY_PORT=9093
DEKAF_METRICS_PORT=9094
DEKAF_UPSTREAM_PORT=29092
DEKAF_ENCRYPTION_SECRET=test-encryption-secret-32-bytes!
RUST_LOG=dekaf=debug,info
EOF

UNIT_FILE="${HOME}/.config/systemd/user/flow-dekaf.service"
if [ ! -f "$UNIT_FILE" ]; then
    ln -sf "$(pwd)/local/systemd/flow-dekaf.service" "$UNIT_FILE"
    systemctl --user daemon-reload
fi

systemctl --user start flow-dekaf

echo "Dekaf started."
echo "  Kafka port: 9092"
echo "  Schema registry port: 9093"
echo "  Metrics port: 9094"
echo "  Upstream Kafka: tcp://localhost:29092"
echo ""
echo "Check status with: systemctl --user status flow-dekaf"
echo "View logs with: journalctl --user -u flow-dekaf -f"
