#!/usr/bin/env bash
set -euo pipefail

#MISE description="Start control plane agent via systemd"
#MISE depends=["local:common", "local:tls-cert", "local:supabase"]

FLOW_LOCAL="${HOME}/flow-local"
mkdir -p "${FLOW_LOCAL}/env"

cat > "${FLOW_LOCAL}/env/agent.env" <<EOF
# Agent environment
# Generated by mise ($(date))

# SSL_CERT_FILE is required for calls made to brokers and reactors.

API_PORT=8675
BUILDS_ROOT=file://${FLOW_LOCAL}/builds/
CONTROL_PLANE_JWT_SECRET=super-secret-jwt-token-with-at-least-32-characters-long
DATABASE_URL=postgresql://postgres:postgres@db.flow.localhost:5432/postgres
LOG_FORMAT=text
CONTROLLER_MAX_JOBS=10
NO_COLOR=1
RUST_LOG=info
SERVE_HANDLERS=true
SKIP_CONNECTOR_TABLE_CHECK=true
SSL_CERT_FILE=${FLOW_LOCAL}/ca.crt

EOF

cat > "${FLOW_LOCAL}/env/config-encryption.env" <<EOF
# Config-encryption service environment
# Generated by mise ($(date))

API_PORT=8765
RUST_LOG=info

# This matches SOPS_AGE_KEY in the reactor development task.
KMS_TYPE=age
KMS_KEY=age19f7t2mt8k9ug5pelhevkrs0k4wfre8vdn9fku4kwd6mng5e8nckszmzfgp

EOF

# Ensure units are installed.
for UNIT in flow-control-agent.service flow-config-encryption.service flow-control-plane.target; do
    UNIT_FILE="${HOME}/.config/systemd/user/${UNIT}"
    if [ ! -f "$UNIT_FILE" ]; then
        ln -sf "$(pwd)/local/systemd/${UNIT}" "$UNIT_FILE"
    fi
done

systemctl --user daemon-reload
systemctl --user start flow-control-plane.target

echo "Control-plane started. Check status with: systemctl --user status flow-control-plane.target"
echo "  Status: systemctl --user list-dependencies flow-control-plane.target"
