#!/usr/bin/env bash

#USAGE flag "--release" help="Link a release build of libbindings.a"

if [ "${usage_release:-false}" = "true" ]; then
    # Link the release library into place of the debug one.
    # This is a little janky, but allows CGO_LDFLAGS to remain unchanged.
    mkdir -p ${CARGO_TARGET_DIR}/debug
    ln -f ${CARGO_TARGET_DIR}/release/libbindings.a ${CARGO_TARGET_DIR}/debug/libbindings.a
fi

# Write a Go source file holding the bindings hash to ./go/bindings/cache_bust.go
cat <<EOF > ./go/bindings/cache_bust.go
package bindings
var BuildTime = "$(stat -c %Y ${CARGO_TARGET_DIR}/debug/libbindings.a)"
EOF

go build -tags libsqlite3 -o ${HOME}/go/bin/flowctl-go ./go/flowctl-go