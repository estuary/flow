#!/usr/bin/env bash
set -euo pipefail

#MISE description="Run Dekaf E2E tests"
#MISE depends=["local:test-tenant"]
#USAGE flag "--filter <filter>" help="Test filter pattern for nextest"
#USAGE flag "--update-snapshots" help="Update insta snapshots"
#USAGE flag "--concurrency <concurrency>" help="How many tests to run at once"
#USAGE flag "--debug" help="Enable debug logging and show all test output"


FILTER="${usage_filter:-}"
UPDATE_SNAPSHOTS="${usage_update_snapshots:-false}"
CONCURRENCY="${usage_concurrency:-"num-cpus"}"
DEBUG="${usage_debug:-false}"

FLOW_LOCAL="${HOME}/flow-local"
CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-${HOME}/cargo-target}"

DEKAF1_KAFKA_PORT=8050  # 8000 + 50
DEKAF2_KAFKA_PORT=8250  # 8200 + 50

SYSTEM_USER_TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJodHRwOi8vMTI3LjAuMC4xOjU0MzEvYXV0aC92MSIsInN1YiI6ImZmZmZmZmZmLWZmZmYtZmZmZi1mZmZmLWZmZmZmZmZmZmZmZiIsImF1ZCI6ImF1dGhlbnRpY2F0ZWQiLCJleHAiOjI3MDAwMDAwMDAsImlhdCI6MTcwMDAwMDAwMCwiZW1haWwiOiJzdXBwb3J0QGVzdHVhcnkuZGV2Iiwicm9sZSI6ImF1dGhlbnRpY2F0ZWQiLCJpc19hbm9ueW1vdXMiOmZhbHNlfQ.Nb-N4s_YnObBHGivSTe_8FEniVUUpehzrRkF5JgNWWU"

# Wait for agent to be ready by checking if it's listening
echo "Waiting for agent..."
TIMEOUT=120
ELAPSED=0
until nc -z localhost 8675 2>/dev/null; do
    sleep 1
    ELAPSED=$((ELAPSED + 1))
    if [ "${ELAPSED}" -ge "${TIMEOUT}" ]; then
        echo "Error: Agent failed to start within ${TIMEOUT} seconds"
        exit 1
    fi
done
echo "Agent is ready"

echo "Building flowctl..."
cargo build -p flowctl --quiet

# local-cluster with Dekaf is expected to already be running from local:stack
# Only set up local-cluster-2 for migration tests
echo "Setting up local-cluster-2 dataplane with Dekaf..."
mise run local:data-plane local-cluster-2 8200 --num-brokers 4 --num-reactors 1 --link --dekaf

echo "Updating storage mappings for migration tests..."
psql "postgresql://postgres:postgres@localhost:5432/postgres" -c "
    UPDATE storage_mappings
    SET spec = jsonb_set(spec::jsonb, '{data_planes}', '[\"ops/dp/public/local-cluster\", \"ops/dp/public/local-cluster-2\"]')
    WHERE catalog_prefix = 'test/';
"

echo "Waiting for Dekaf instances..."
TIMEOUT=60
for port in ${DEKAF1_KAFKA_PORT} ${DEKAF2_KAFKA_PORT}; do
    ELAPSED=0
    until nc -z localhost ${port} 2>/dev/null; do
        sleep 1
        ELAPSED=$((ELAPSED + 1))
        if [ "${ELAPSED}" -ge "${TIMEOUT}" ]; then
            echo "Error: Dekaf on port ${port} failed to start within ${TIMEOUT} seconds"
            journalctl --user -u "flow-dekaf@*" --no-pager -n 100 || true
            exit 1
        fi
    done
    echo "Dekaf on port ${port} is ready"
done

echo "Running Dekaf E2E tests..."

export DEKAF_BROKER="localhost:${DEKAF1_KAFKA_PORT}"
export DEKAF_REGISTRY="http://localhost:$((DEKAF1_KAFKA_PORT + 1))"
export SSL_CERT_FILE="${FLOW_LOCAL}/ca.crt"
export FLOW_ACCESS_TOKEN="${SYSTEM_USER_TOKEN}"

if [ "${DEBUG}" = "true" ]; then
    export RUST_LOG="debug"
else
    export RUST_LOG="info"
fi

TEST_EXIT_CODE=0
INSTA_ENV=""
if [ "${UPDATE_SNAPSHOTS}" = "true" ]; then
    INSTA_ENV="INSTA_UPDATE=always"
fi

if [ "${DEBUG}" = "true" ]; then
    OUTPUT_FLAGS="--no-capture"
else
    OUTPUT_FLAGS="--failure-output=immediate --success-output=final"
fi

if [ -n "${FILTER}" ]; then
    # Use --ignore-default-filter since user is explicitly choosing what to run
    PATH="${CARGO_TARGET_DIR}/debug:${PATH}" \
    env ${INSTA_ENV} \
    cargo nextest run --profile dekaf-e2e -p dekaf ${OUTPUT_FLAGS} \
        --ignore-default-filter -E "binary_id(/dekaf::e2e/) and test(${FILTER})" || TEST_EXIT_CODE=$?
else
    PATH="${CARGO_TARGET_DIR}/debug:${PATH}" \
    env ${INSTA_ENV} \
    cargo nextest run --profile dekaf-e2e -p dekaf ${OUTPUT_FLAGS} -j "${CONCURRENCY}" --no-fail-fast --retries=1 || TEST_EXIT_CODE=$?
fi

# On failure, output service logs for debugging
if [ "${TEST_EXIT_CODE}" -ne 0 ]; then
    echo ""
    echo "========================================"
    echo "Tests failed! Dumping service logs..."
    echo "========================================"
    echo ""
    echo "--- Dekaf (local-cluster) logs ---"
    journalctl --user -u flow-dekaf@local-cluster --no-pager -n 200 || true
    echo ""
    echo "--- Dekaf (local-cluster-2) logs ---"
    journalctl --user -u flow-dekaf@local-cluster-2 --no-pager -n 200 || true
    echo ""
    echo "--- Agent logs ---"
    journalctl --user -u flow-control-agent --no-pager -n 200 || true
    echo ""
    exit "${TEST_EXIT_CODE}"
fi
