#!/usr/bin/env bash
set -euo pipefail

#MISE description="Run Dekaf E2E tests"
#MISE depends=["local:test-tenant", "local:dekaf"]
#USAGE flag "--filter <filter>" help="Test filter pattern for nextest"
#USAGE flag "--update-snapshots" help="Update insta snapshots"

FILTER="${usage_filter:-}"
UPDATE_SNAPSHOTS="${usage_update_snapshots:-false}"

FLOW_LOCAL="${HOME}/flow-local"
CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-${HOME}/cargo-target}"
KAFKA_PORT=9092
REGISTRY_PORT=9093

# System user access token for local stack (support@estuary.dev)
# This JWT is signed against the local supabase secret and expires in 2055.
SYSTEM_USER_TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJodHRwOi8vMTI3LjAuMC4xOjU0MzEvYXV0aC92MSIsInN1YiI6ImZmZmZmZmZmLWZmZmYtZmZmZi1mZmZmLWZmZmZmZmZmZmZmZiIsImF1ZCI6ImF1dGhlbnRpY2F0ZWQiLCJleHAiOjI3MDAwMDAwMDAsImlhdCI6MTcwMDAwMDAwMCwiZW1haWwiOiJzdXBwb3J0QGVzdHVhcnkuZGV2Iiwicm9sZSI6ImF1dGhlbnRpY2F0ZWQiLCJpc19hbm9ueW1vdXMiOmZhbHNlfQ.Nb-N4s_YnObBHGivSTe_8FEniVUUpehzrRkF5JgNWWU"

# Wait for agent to be ready by checking if it's listening
echo "Waiting for agent..."
TIMEOUT=120
ELAPSED=0
until nc -z localhost 8675 2>/dev/null; do
    sleep 1
    ELAPSED=$((ELAPSED + 1))
    if [ "${ELAPSED}" -ge "${TIMEOUT}" ]; then
        echo "Error: Agent failed to start within ${TIMEOUT} seconds"
        exit 1
    fi
done
echo "Agent is ready"

# Build Dekaf and flowctl
echo "Building Dekaf and flowctl..."
cargo build -p dekaf -p flowctl --quiet

# Wait for Dekaf to be ready (started by local:dekaf dependency)
echo "Waiting for Dekaf..."
TIMEOUT=30
ELAPSED=0
until nc -z localhost ${KAFKA_PORT} 2>/dev/null; do
    sleep 1
    ELAPSED=$((ELAPSED + 1))
    if [ "${ELAPSED}" -ge "${TIMEOUT}" ]; then
        echo "Error: Dekaf failed to start within ${TIMEOUT} seconds"
        exit 1
    fi
done
echo "Dekaf is ready"

echo "Running Dekaf E2E tests..."

# Set environment variables for the test harness
export DEKAF_BROKER="localhost:${KAFKA_PORT}"
export DEKAF_REGISTRY="http://localhost:${REGISTRY_PORT}"
export SSL_CERT_FILE="${FLOW_LOCAL}/ca.crt"
export FLOW_ACCESS_TOKEN="${SYSTEM_USER_TOKEN}"

# Set INSTA_UPDATE to update snapshots if requested
if [ "${UPDATE_SNAPSHOTS}" = "true" ]; then
    export INSTA_UPDATE=always
fi

# Run E2E tests using the dekaf-e2e nextest profile
# Add cargo-target/debug to PATH so the test harness finds flowctl
# Use --no-capture to stream test output in real-time
TEST_EXIT_CODE=0
if [ -n "${FILTER}" ]; then
    PATH="${CARGO_TARGET_DIR}/debug:${PATH}" \
    cargo nextest run --profile dekaf-e2e -p dekaf --no-capture --failure-output=immediate --success-output=immediate -E "test(${FILTER})" || TEST_EXIT_CODE=$?
else
    PATH="${CARGO_TARGET_DIR}/debug:${PATH}" \
    cargo nextest run --profile dekaf-e2e -p dekaf -j 2 --no-capture || TEST_EXIT_CODE=$?
fi

# On failure, output service logs for debugging
if [ "${TEST_EXIT_CODE}" -ne 0 ]; then
    echo ""
    echo "========================================"
    echo "Tests failed! Dumping service logs..."
    echo "========================================"
    echo ""
    echo "--- Dekaf logs ---"
    journalctl --user -u flow-dekaf --no-pager -n 200 || true
    echo ""
    echo "--- Agent logs ---"
    journalctl --user -u flow-control-agent --no-pager -n 200 || true
    echo ""
    exit "${TEST_EXIT_CODE}"
fi
