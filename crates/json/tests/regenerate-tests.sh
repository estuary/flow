#!/bin/bash

# Generates rust tests from the set of official json schema test cases.
# This is run manually each time the git submodule is updated.

set -e

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

DRAFT2019_TESTS="${DIR}/draft2019_tests.rs";
cat >"$DRAFT2019_TESTS" <<EOF
//! DO NOT EDIT THIS FILE!
//! This file is generated by $(basename "$0") based on the official
//! test cases in the submodule.

mod validator_test_utils;
use validator_test_utils::run_draft09_test;

EOF

function make_base_test_name() {
    # Strips off the .json extension, then changes all capitals to lowercase with preceeding
    # underscore and also replaces dashes with underscores the bit in the middle is a special case
    # to remove a leading underscore in case the first character was an uppercase
    basename "$1" .json | sed 's/\([A-Z]\)/_\L\1/g;s/^_//;s/-/_/g'
}

for file in $DIR/official/tests/draft2019-09/*.json; do
    filename=$(basename "$file")
    test_base_name="$(make_base_test_name "$filename")"
    printf 'Using file "%s" to generate test: "%s"\n' "$filename" "$test_base_name"

    cat >> "$DRAFT2019_TESTS" << EOF
#[test]
fn test_d09_${test_base_name}() {
    run_draft09_test("${filename}");
}

EOF
done

