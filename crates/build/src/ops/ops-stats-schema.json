{
    "$schema": "https://json-schema.org/draft-07/schema",
    "title": "Flow task stats",
    "description": "Statistics related to the processing of a Flow capture, derivation, or materialization",
    "type": "object",
    "properties": {
        "task": { "$ref": "ops-task-schema.json" },
        "ts": {
            "description": "Timestamp corresponding to the start of the transaction",
            "type": "string",
            "format": "date-time",
            "reduce": {"strategy": "maximize"}
        },
        "combine": {
            "type": "object",
            "properties": {
                "left": {
                    "$ref": "#/$defs/combineMetrics"
                },
                "right": {
                    "$ref": "#/$defs/combineMetrics"
                },
                "out": {
                    "$ref": "#/$defs/combineMetrics"
                }
            },
            "reduce": {"strategy": "merge"}
        },
        "lambda": {
            "type": "object",
            "properties": {
                "update": {
                    "$ref": "#/$defs/lambdaMetrics"
                },
                "publish": {
                    "$ref": "#/$defs/lambdaMetrics"
                }
            },
            "reduce": {"strategy": "merge"}
        },
        "connector": {
            "type": "object",
            "properties": {
                "start": {
                    "type": "integer",
                    "description": "Counter of connector invocations",
                    "reduce": {"strategy": "sum"}
                }
            },
            "reduce": {"strategy": "merge"}
        }
    },
    "reduce": {"strategy": "merge"},
    "required": ["task", "ts", "combine"],
    "$defs": {
        "combineMetrics": {
            "type": "object",
            "properties": {
                "docs_total": {
                    "description": "The number of documents processed from or into the given collection capture or materialization",
                    "type": "integer",
                    "reduce": {"strategy": "sum"}
                },
                "bytes_total": {
                    "description": "The number of bytes processed from or into the given collection capture or materialization. Note that for \ncaptures and materializations this relates to the size of Flow JSON documents not the representation used by the external system.\n",
                    "type": "integer",
                    "reduce": {"strategy": "sum"}
                }
            },
            "reduce": {"strategy": "merge"},
            "required": [
                "docs_total",
                "bytes_total"
            ]
        },
        "lambdaMetrics": {
            "type": "object",
            "properties": {
                "invocations_total": {
                    "type": "integer",
                    "description": "The number of invocations during this transaction",
                    "reduce": {"strategy": "sum"}
                },
                "duration_seconds": {
                    "type": "number",
                    "description": "The total number of seconds elapsed for all invocations.",
                    "reduce": {"strategy": "sum"}
                }
            },
            "reduce": {"strategy": "merge"},
            "required": [
                "invocations_total",
                "duration_seconds"
            ]
        }
    }
}
