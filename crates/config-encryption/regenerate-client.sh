#!/bin/bash

set -e

function log() {
    echo "$@" 1>&2
}

OUT_DIR=client

# temporary location to put the downloaded jar file
OPENAPI_JAR="/tmp/openapi-generator-cli.jar"
# sha 256 sum of the openapi generator. You know, for safety.
SHA_SUM="f3ed312310e390324b33ba2ffff290ce812935207a1493ec5c098d0a441be51c  $OPENAPI_JAR"

if [[ ! -f "$OPENAPI_JAR" ]]; then
    log fetching open api generator
    wget https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/5.4.0/openapi-generator-cli-5.4.0.jar -O "$OPENAPI_JAR"
fi
# verify even if we didn't download it, so that we don't have to worry about cleaning up the
# downloaded file if the checksum fails.
echo "$SHA_SUM" | sha256sum -c

# Clear everything out of the out directory
if [[ -d "$OUT_DIR" ]]; then
    rm -r "$OUT_DIR"
fi
mkdir "$OUT_DIR"
cat > "$OUT_DIR/README.md" <<EOF
# Generated Client

The files in this directory are generated by regenerate-client.sh and nothing should be added or
modified manually here.
EOF

exec java -jar "$OPENAPI_JAR" generate -g typescript-fetch -i src/openapi-spec.json -o "$OUT_DIR"
