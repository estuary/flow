<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-concepts/derivations" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Derivations | Estuary Flow Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://docs.estuary.dev/pr-preview/pr-2559/img/estuary-new.png"><meta data-rh="true" name="twitter:image" content="https://docs.estuary.dev/pr-preview/pr-2559/img/estuary-new.png"><meta data-rh="true" property="og:url" content="https://docs.estuary.dev/pr-preview/pr-2559/concepts/derivations/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Derivations | Estuary Flow Documentation"><meta data-rh="true" name="description" content="At times, the collections generated by a capture may not be suitable for your needs."><meta data-rh="true" property="og:description" content="At times, the collections generated by a capture may not be suitable for your needs."><link data-rh="true" rel="icon" href="/pr-preview/pr-2559/img/favicon-2.ico"><link data-rh="true" rel="canonical" href="https://docs.estuary.dev/pr-preview/pr-2559/concepts/derivations/"><link data-rh="true" rel="alternate" href="https://docs.estuary.dev/pr-preview/pr-2559/concepts/derivations/" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.estuary.dev/pr-preview/pr-2559/concepts/derivations/" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Concepts","item":"https://docs.estuary.dev/pr-preview/pr-2559/concepts/"},{"@type":"ListItem","position":2,"name":"Derivations","item":"https://docs.estuary.dev/pr-preview/pr-2559/concepts/derivations"}]}</script><link rel="preconnect" href="https://www.googletagmanager.com">
<script>window.dataLayer=window.dataLayer||[]</script>
<script>!function(e,t,a,n){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var g=t.getElementsByTagName(a)[0],m=t.createElement(a);m.async=!0,m.src="https://www.googletagmanager.com/gtm.js?id=GTM-WK8SB2L",g.parentNode.insertBefore(m,g)}(window,document,"script","dataLayer")</script>
<script id="ai-widget-script" async src="https://widget.kapa.ai/kapa-widget.bundle.js" data-website-id="349e5b72-3e5a-4c19-8b7a-27c7b90caa0f" data-project-name="Estuary" data-modal-title="Estuary AI Assistant" data-project-color="#5072EB" data-button-text-color="#F2F2F2" data-project-logo="https://docs.estuary.dev/img/estuary-new.png" data-modal-example-questions-title="Try asking me..." data-modal-disclaimer="This AI assistant answers questions using Estuary&#39;s [documentation](https://docs.estuary.dev/), [blogs](https://estuary.dev/blog/), and additional resources. If you can&#39;t find your answer, join us on [Slack](https://go.estuary.dev/slack) or [send an email](https://estuary.dev/contact-us)." data-modal-example-questions="How does CDC work in Estuary?,How can I deploy to a private cloud?,How do I connect to PostgreSQL?,Is Estuary Flow scalable?" data-uncertain-answer-callout="I may not have all of the information on that topic. I bet someone can answer it in [Slack](https://go.estuary.dev/slack)." data-mcp-enabled="true" data-mcp-server-url="https://estuary.mcp.kapa.ai"></script><link rel="stylesheet" href="/pr-preview/pr-2559/assets/css/styles.7c6c0a48.css">
<script src="/pr-preview/pr-2559/assets/js/runtime~main.b54230e5.js" defer="defer"></script>
<script src="/pr-preview/pr-2559/assets/js/main.1bc8ca11.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script>


<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WK8SB2L" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/pr-preview/pr-2559/"><div class="navbar__logo"><img src="/pr-preview/pr-2559/img/estuary-new.png" alt="Estuary Flow Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/pr-preview/pr-2559/img/estuary-new.png" alt="Estuary Flow Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Estuary Flow</b></a><a aria-current="page" class="navbar__item navbar__link docs-section-link navbar__link--active" href="/pr-preview/pr-2559/">Platform</a><a class="navbar__item navbar__link docs-section-link" href="/pr-preview/pr-2559/reference/Connectors/">Connectors</a><div class="navbar__item"><a href="https://estuary.dev/blog" target="_blank">Blog</a></div></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://status.estuary.dev/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Status<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><a href="https://github.com/estuary/flow" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="navbar__item button-link"><a href="https://dashboard.estuary.dev/register">Try Estuary</a></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/pr-preview/pr-2559/"><span title="Getting Started" class="categoryLinkLabel_W154">Getting Started</span></a><button aria-label="Expand sidebar category &#x27;Getting Started&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/pr-preview/pr-2559/guides/"><span title="Using Estuary Flow" class="categoryLinkLabel_W154">Using Estuary Flow</span></a><button aria-label="Expand sidebar category &#x27;Using Estuary Flow&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/pr-preview/pr-2559/guides/dbt-integration/"><span title="Transforming Data" class="categoryLinkLabel_W154">Transforming Data</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/pr-preview/pr-2559/features/mcp-integration/"><span title="Advanced Features" class="categoryLinkLabel_W154">Advanced Features</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" href="/pr-preview/pr-2559/concepts/"><span title="Concepts" class="categoryLinkLabel_W154">Concepts</span></a><button aria-label="Collapse sidebar category &#x27;Concepts&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pr-preview/pr-2559/concepts/"><span title="Concepts" class="linkLabel_WmDU">Concepts</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pr-preview/pr-2559/concepts/captures/"><span title="Captures" class="linkLabel_WmDU">Captures</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pr-preview/pr-2559/concepts/catalogs/"><span title="Catalog" class="linkLabel_WmDU">Catalog</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pr-preview/pr-2559/concepts/collections/"><span title="Collections" class="linkLabel_WmDU">Collections</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pr-preview/pr-2559/concepts/connectors/"><span title="Connectors" class="linkLabel_WmDU">Connectors</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/pr-preview/pr-2559/concepts/derivations/"><span title="Derivations" class="linkLabel_WmDU">Derivations</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pr-preview/pr-2559/concepts/flowctl/"><span title="flowctl" class="linkLabel_WmDU">flowctl</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pr-preview/pr-2559/concepts/import/"><span title="Imports" class="linkLabel_WmDU">Imports</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/pr-preview/pr-2559/concepts/materialization/"><span title="Materializations" class="categoryLinkLabel_W154">Materializations</span></a><button aria-label="Expand sidebar category &#x27;Materializations&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pr-preview/pr-2559/concepts/schemas/"><span title="Schemas" class="linkLabel_WmDU">Schemas</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pr-preview/pr-2559/concepts/storage-mappings/"><span title="Storage Mappings" class="linkLabel_WmDU">Storage Mappings</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pr-preview/pr-2559/concepts/tests/"><span title="Tests" class="linkLabel_WmDU">Tests</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pr-preview/pr-2559/concepts/web-app/"><span title="Web Application" class="linkLabel_WmDU">Web Application</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/pr-preview/pr-2559/concepts/advanced/evolutions/"><span title="Advanced Concepts" class="categoryLinkLabel_W154">Advanced Concepts</span></a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/pr-preview/pr-2559/private-byoc/"><span title="Private &amp; BYOC Deployments" class="categoryLinkLabel_W154">Private &amp; BYOC Deployments</span></a><button aria-label="Expand sidebar category &#x27;Private &amp; BYOC Deployments&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/pr-preview/pr-2559/security/"><span title="Security &amp; Compliance" class="categoryLinkLabel_W154">Security &amp; Compliance</span></a><button aria-label="Expand sidebar category &#x27;Security &amp; Compliance&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/pr-preview/pr-2559/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/pr-preview/pr-2559/concepts/"><span>Concepts</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Derivations</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Derivations</h1></header>
<p>At times, the collections generated by a <a class="" href="/pr-preview/pr-2559/concepts/#captures">capture</a> may not be suitable for your needs.
For instance, you might want to filter certain documents or add calculations to them.
Perhaps you need to unpack an array nested inside or aggregate data from many documents.
Alternatively, you might need to merge across several collections using a common key,
or employ business logic to arrive at a real-time decision.
With Flow derivations, you can perform a wide range of transformations,
from a simple remapping to complicated, self-referential, and stateful transaction processing.</p>
<p>In essence, a derivation is a <a class="" href="/pr-preview/pr-2559/concepts/#collections">collection</a>
that is constructed from applying transformations to one or more sourced collections.
Derivations operate continuously, keeping up with updates to the source collections as they happen.</p>
<p>A derivation consists of three primary elements:</p>
<ul>
<li class="">A collection that stores the output.</li>
<li class="">A <a class="" href="/pr-preview/pr-2559/concepts/#tasks">catalog task</a> that applies transformations to source documents
as they become available and writes the resulting documents into the derived collection.</li>
<li class="">An <a href="#internal-state" class="">internal task state</a> which enables aggregations, joins, and windowing.</li>
</ul>
<p>Flow enables you to write derivations using
<a href="#sqlite" class="">SQLite</a>, <a href="#typescript" class="">TypeScript</a>, or <a href="#python" class="">Python</a>.
Today, Python derivations are restricted to private and BYOC data planes.
We intend to lift this restriction in the future.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>If you would like a a more hands-on approach to learn derivations, check out <a class="" href="/pr-preview/pr-2559/getting-started/tutorials/derivations_acmebank/">this</a> tutorial!</p></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="specification">Specification<a href="#specification" class="hash-link" aria-label="Direct link to Specification" title="Direct link to Specification" translate="no">​</a></h2>
<p>A derivation is specified as a regular <a class="" href="/pr-preview/pr-2559/concepts/#collections">collection</a>
with an additional <code>derive</code> stanza:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">collections</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># The unique name of the derivation.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">acmeCo/my/derivation</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">schema</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">schema.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">/key</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Presence of a `derive` stanza makes this collection a derivation.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Type: object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">derive</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Connector which this derivation uses.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># One of `typescript` or `sqlite`.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">using</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Derivation is using the SQLite connector.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Optional, type: object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">sqlite</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># SQL migrations to apply as inline SQL or file references.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># If a referenced file does not exist</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># a stub can be generated using `flowctl generate`.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># Optional, type: array of strings</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">migrations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> CREATE TABLE foobar (id INTEGER PRIMARY KEY NOT NULL);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ../path/to/other/migration.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Derivation is using the TypeScript connector.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Optional, type: object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">typescript</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># TypeScript module implementing this derivation,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># as inline TypeScript or a relative file reference.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># If a referenced file does not exist</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># a stub can be generated using `flowctl generate`.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">module</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> acmeModule.ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Derivation is using the Python connector.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Optional, type: object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">python</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># Python module implementing this derivation,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># as inline Python or a relative file reference.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># If a referenced file does not exist</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># a stub can be generated using `flowctl generate`.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">module</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> acmeModule.flow.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># Additional Python package dependencies.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># Optional, type: object mapping package names to version specifiers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">dependencies</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">requests</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&gt;=2.31.0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">pandas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&gt;=2.0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># The array of transformations that build this derived collection.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">transform</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Unique name of the transformation, containing only Unicode</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Letters, Numbers, `-`, or `_` (no spaces or other punctuation).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> myTransformName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># Source collection read by this transformation.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># Required, type: object or string.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">source</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Name of the collection to be read.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Required.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> acmeCo/my/source/collection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Partition selector of the source collection.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Optional. Default is to read all partitions.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">partitions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Lower bound date-time for documents which should be processed.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Source collection documents published before this date-time are filtered.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># `notBefore` is *only* a filter. Updating its value will not cause Flow</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># to re-process documents that have already been read.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Optional. Default is to process all documents.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">notBefore</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token datetime number" style="color:#36acaa">2023-01-23T01:00:00Z</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Upper bound date-time for documents which should be processed.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Source collection documents published after this date-time are filtered.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Like `notBefore`, `notAfter` is *only* a filter. Updating its value will</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># not cause Flow to re-process documents that have already been read.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Optional. Default is to process all documents.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">notAfter</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token datetime number" style="color:#36acaa">2023-01-23T02:00:00Z</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># Lambda of this transform, with a meaning which depends</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># on the derivation connector:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># * SQLite derivation lambdas are blocks of SQL code.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># * TypeScript and Python do not use `lambda`, as implementations</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">#   are provided by the derivation&#x27;s module.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># Lambdas can be either inline or a relative file reference.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">lambda</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SELECT $foo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> $bar;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># Delay applied to sourced documents before being processed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># by this transformation.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># Default: No delay, pattern: ^\\d+(s|m|h)$</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">readDelay</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;48h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># Key by which source documents are shuffled to task shards.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># Optional, type: object.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># If not set, the source collection key is used.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">shuffle</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Composite key of JSON pointers which are extracted from</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># source documents.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">/shuffle/key/one</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> /shuffle/key/two</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># Priority applied to documents of this transformation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># relative to other transformations of the derivation.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># Default: 0, integer &gt;= 0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">priority</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="supported-languages">Supported Languages<a href="#supported-languages" class="hash-link" aria-label="Direct link to Supported Languages" title="Direct link to Supported Languages" translate="no">​</a></h2>
<p>As with captures and materializations,
Flow derivations are built around a plug-able <a class="" href="/pr-preview/pr-2559/concepts/#connectors">connectors</a> architecture.
Derivation connectors encapsulate the details of <em>how</em> documents are transformed,
and integrate with Flow&#x27;s runtime through a common protocol.</p>
<p>At present, Flow supports transformations in SQL using <a href="#sqlite" class="">SQLite</a>, <a href="#typescript" class="">TypeScript</a>, and <a href="#python" class="">Python</a>.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="sqlite">SQLite<a href="#sqlite" class="hash-link" aria-label="Direct link to SQLite" title="Direct link to SQLite" translate="no">​</a></h2>
<p>Flow&#x27;s SQLite connector lets you write plain SQL which
is evaluated with each source collection document:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">derive</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">using</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">sqlite</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">transforms</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fromOrders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">source</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> acmeCo/orders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">shuffle</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> any</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">lambda</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SELECT $customer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DATE($timestamp) AS date</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PRINTF(&#x27;$%.2f&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> $item_price + $sales_tax) AS cost;</span><br></span></code></pre></div></div>
<p>Given an input document:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;customer&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Wile E. Coyote&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;timestamp&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2023-04-17T16:45:31Z&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;item_price&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11.5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;sales_tax&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>The derivation will produce an output document like:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;customer&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Wile E. Coyote&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;date&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2023-04-17&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;cost&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;$12.30&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>SQLite derivations run within the context of a persistent,
managed <a href="https://sqlite.org/" target="_blank" rel="noopener noreferrer" class="">SQLite database</a>.
Most anything you can do within SQLite,
you can do within a SQLite derivation.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="sql-lambdas">SQL Lambdas<a href="#sql-lambdas" class="hash-link" aria-label="Direct link to SQL Lambdas" title="Direct link to SQL Lambdas" translate="no">​</a></h3>
<p>Lambdas are blocks of one or more SQL statements.
They can be defined inline within a Flow specification,
or they can be provided as a relative file reference to a file of SQL.</p>
<p>Your SQL lambda code can include any number of statements,
and your statements are evaluated in the context of your applied
database <a href="#migrations" class="">migrations</a>.
Use regular <code>INSERT</code>, <code>UPDATE</code>, and <code>DELETE</code> statements
in your SQL blocks to manipulate your internal tables as required.</p>
<p>Any rows which are returned by SQL statements,
such as <code>SELECT</code> and also variations like <code>INSERT ... RETURNING</code>,
are <a href="#document-mapping" class="">mapped into documents</a> that are published
into your derived collection.
Published documents must conform to your collection schema
or your derivation task will stop due to the schema violation.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>The SQLite connector wraps your lambdas in an enclosing transaction.
Do <strong>not</strong> include <code>BEGIN</code> or <code>COMMIT</code> statements in your lambdas.
You may use a <a href="https://www.sqlite.org/lang_savepoint.html" target="_blank" rel="noopener noreferrer" class="">SAVEPOINT</a> or <code>ROLLBACK TO</code>.</p></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="document-mapping">Document Mapping<a href="#document-mapping" class="hash-link" aria-label="Direct link to Document Mapping" title="Direct link to Document Mapping" translate="no">​</a></h3>
<p>In most cases, each named output column of your query becomes
a top-level property of its corresponding document.</p>
<p>When you directly select a <code>$parameter</code> its corresponding field name is used.
For example, a projection with field name <code>my-field</code> would be queried as
<code>SELECT $my_field;</code> and map into a document like <code>{&quot;my-field&quot;:&quot;value&quot;}</code>.</p>
<p>A named column such as <code>SELECT $x * 100 AS foo;</code>,
maps to a property using the provided name: <code>{&quot;foo&quot;: 200}</code>.</p>
<p>Your selected columns may included nested JSON documents,
such as <code>SELECT &#x27;hello&#x27; AS greeting, JSON_ARRAY(1, &#x27;two&#x27;, 3) AS items;</code>.
The connector looks for SQLite TEXT values which can be parsed
into JSON arrays or objects and embeds them into the mapped document:
<code>{&quot;greeting&quot;: &quot;hello&quot;, &quot;items&quot;: [1, &quot;two&quot;, 3]}</code>.
If parsing fails, the raw string is used instead.</p>
<p>If you would like to select all columns of the input collection,
rather than <code>select *</code>, use <code>select JSON($flow_document)</code>, e.g.
<code>select JSON($flow_document where $status = open;</code>.</p>
<p>As a special case if your query selects a <em>single</em> column
having a name that begins with <code>json</code> or <code>JSON</code>,
as is common when working with SQLite&#x27;s <a href="https://www.sqlite.org/json1.html" target="_blank" rel="noopener noreferrer" class="">JSON functions</a>,
then that column will become the output document.
For example <code>SELECT JSON_OBJECT(&#x27;a&#x27;, 1, &#x27;b&#x27;, JSON(&#x27;true&#x27;));</code> maps into document <code>{&quot;a&quot;: 1, &quot;b&quot;: true}</code>.
This can be used to build documents with dynamic top-level properties.</p>
<p>Note that this also allows you to manage Flow&#x27;s final document specification in ways that SQLite would not otherwise allow.
SQLite does not support a <a href="https://sqlite.org/datatype3.html#boolean_datatype" target="_blank" rel="noopener noreferrer" class="">boolean data type</a>, instead defaulting to the integers <code>0</code> and <code>1</code>.
By selecting a <code>JSON_OBJECT</code> with a <code>JSON(&#x27;true&#x27;)</code> or <code>JSON(&#x27;false&#x27;)</code> value, the final JSON field will have a boolean type.</p>
<p>You can set a boolean value dynamically with a case statement. For example:</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">select</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  json_object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;id&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;decision&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> json_extract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">document</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;$.decision&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">when</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;true&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"> json</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;true&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">when</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;false&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"> json</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;false&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="parameters">Parameters<a href="#parameters" class="hash-link" aria-label="Direct link to Parameters" title="Direct link to Parameters" translate="no">​</a></h3>
<p>Your SQL lambda will execute with every source document of the collection it transforms.
To access locations within the document, you utilize <code>$parameter</code> placeholders
in your SQL code, which bind to <a class="" href="/pr-preview/pr-2559/concepts/#projections">projections</a> of the source document.
You can use both your defined projections
as well as projections which are statically inferred from your source collection&#x27;s schema.</p>
<p>You can access projected fields that are top-level
as well as those which are nested within a source document.
Consider the following schematized document:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;top-level&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;object&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;foo&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">42</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;arr&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;bar&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>In your SQL code, you can use parameters like <code>$top_level</code>, <code>$object$foo</code>, or <code>$arr$0</code>.
If you&#x27;re unsure of what parameter to use for a given field,
try typing something approximate and Flow will suggest the appropriate <code>$parameter</code>.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="migrations">Migrations<a href="#migrations" class="hash-link" aria-label="Direct link to Migrations" title="Direct link to Migrations" translate="no">​</a></h3>
<p>The SQLite connector offers a managed, persistent SQLite database
that can accommodate any number of tables, indices, views, triggers, and other schema,
as defined by your database migrations.
To add a migration, simply append it to the <code>migrations</code> array,
either as a block of inline SQL statements
or as a relative path to a file of SQL statements:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">derive</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">using</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">sqlite</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">migrations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> CREATE TABLE foo (thing INTEGER NOT NULL);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          CREATE INDEX idx_foo_thing foo (thing);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ../path/to/another/migration.sql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ALTER TABLE foo ADD COLUMN other_thing TEXT NOT NULL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//example.com/yet/another/migration.sql</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_BuS1"><p>You cannot change an existing migration once it has been published.
Instead, add a new migration which applies your desired schema.</p></div></div>
<p>The tables and other schema you create through database migrations
are the <a href="#internal-state" class="">internal state</a> of your derivation.
They don&#x27;t directly cause any documents to be published into your derived collection,
but changes made to tables in one SQL lambda execution are immediately visible to others.
Changes are also durable and transactional:
a Flow derivation transaction commits new documents to the derived collection
in lockstep with committing changes made to your task tables.</p>
<p>Flow is responsible for the persistence and replication of your SQLite database,
and the SQLite connector tracks and will apply your migrations as needed.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="performance">Performance<a href="#performance" class="hash-link" aria-label="Direct link to Performance" title="Direct link to Performance" translate="no">​</a></h3>
<p>Your observed performance will <em>of course</em> depend on the specifics of your use case,
including the size of your task states
and the complexity of your source documents and transformations.</p>
<p>Generally speaking, SQLite is very performant
and Flow&#x27;s SQLite connector strives to drive it as efficiently as possible.
Real-world use cases are observed to process many <strong>tens
of thousands</strong> of documents per second on a single core.</p>
<p>Flow can also scale your task without downtime
by creating point-in-time clones of the database
that subdivide the overall workload and storage of the task.
Once created, these subdivisions process in parallel across
multiple physical machines to enhance performance.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="typescript">TypeScript<a href="#typescript" class="hash-link" aria-label="Direct link to TypeScript" title="Direct link to TypeScript" translate="no">​</a></h2>
<p>Flow&#x27;s TypeScript derivation connector transforms your source documents
by executing methods of a TypeScript class which you implement.
TypeScript derivations are executed using <a href="https://deno.land/" target="_blank" rel="noopener noreferrer" class="">Deno</a>
and let you take advantage of the broad ecosystem of
available third-party JavaScript and TypeScript libraries,
as well as native code compiled to WASM.</p>
<p>TypeScript derivations are strongly typed:
Flow maps the JSON schemas of your source and output collections
into corresponding TypeScript types,
which are type-checked as you develop and test your derivation.
This helps catch a wide variety of potential bugs and avoid accidental violations of your collection data contracts.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="modules">Modules<a href="#modules" class="hash-link" aria-label="Direct link to Modules" title="Direct link to Modules" translate="no">​</a></h3>
<p>The bulk of a TypeScript derivation lives in its associated module,
which is a TypeScript source file that exports the class that implements your derivation.</p>
<p>Each derivation also has an accompanying, generated interfaces module.
Interface modules are managed by Flow and are purely advisory:
they&#x27;re generated to improve your development experience,
but any changes you make are ignored.</p>
<p>The <code>flowctl generate --source path/to/my/derivation.flow.yaml</code> CLI command
will generate interface modules under paths like
<code>flow_generated/typescript/acmeCo/my-derivation.ts</code>,
under the top-level directory under <code>--source</code> having a <code>flow.yaml</code> or <code>flow.json</code> file.</p>
<p>It will also generate a <code>deno.json</code> file in your top-level directory,
which is designed to work with developer tooling like
<a href="https://marketplace.visualstudio.com/items?itemName=denoland.vscode-deno" target="_blank" rel="noopener noreferrer" class="">VSCode&#x27;s Deno extension</a>.</p>
<p><a class="" href="/pr-preview/pr-2559/getting-started/tutorials/derivations_acmebank/#current-account-balances">See the Current Account Balances tutorial for a concrete example of modules</a>.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="state">State<a href="#state" class="hash-link" aria-label="Direct link to State" title="Direct link to State" translate="no">​</a></h3>
<p>The abstract <code>IDerivation</code> class generated within the interfaces module
includes additional, experimental methods which can be used for
persisting and recovering internal state of the connector.</p>
<p>Consult the generated implementation and feel free to reach out to support
if you&#x27;d like more information on building stateful TypeScript derivations.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="python">Python<a href="#python" class="hash-link" aria-label="Direct link to Python" title="Direct link to Python" translate="no">​</a></h2>
<p>Flow&#x27;s Python derivation connector transforms your source documents
by executing async methods of a Python class which you implement.
Python derivations are executed using <a href="https://docs.astral.sh/uv/" target="_blank" rel="noopener noreferrer" class="">uv</a>,
a fast Python package manager, and let you take advantage of the extensive
Python ecosystem while maintaining strong type safety through Pydantic models.</p>
<p>Python derivations are strongly typed:
Flow maps the JSON schemas of your source and output collections
into corresponding Pydantic models,
which are validated at publish time using <a href="https://github.com/microsoft/pyright" target="_blank" rel="noopener noreferrer" class="">pyright</a>
in strict mode and provide excellent IDE support with autocomplete.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="modules-1">Modules<a href="#modules-1" class="hash-link" aria-label="Direct link to Modules" title="Direct link to Modules" translate="no">​</a></h3>
<p>The bulk of a Python derivation lives in its associated module,
which is a Python source file that exports the class that implements your derivation.</p>
<p>Each derivation also has an accompanying, generated types module.
Type modules are managed by Flow and are purely advisory:
they&#x27;re generated to improve your development experience,
but any changes you make are ignored.</p>
<p>The <code>flowctl generate --source path/to/my/derivation.flow.yaml</code> CLI command
will generate type modules under paths like
<code>flow_generated/python/acmeCo/my_derivation/__init__.py</code>,
along with <code>pyproject.toml</code> and <code>pyrightconfig.json</code> for IDE integration.</p>
<p>These generated files work seamlessly with Python IDEs and language servers
to provide type checking, autocomplete, and inline documentation as you write your derivations.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="dependencies">Dependencies<a href="#dependencies" class="hash-link" aria-label="Direct link to Dependencies" title="Direct link to Dependencies" translate="no">​</a></h3>
<p>You can specify additional Python packages in your derivation configuration:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">derive</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">using</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">python</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">module</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> my_derivation.flow.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">dependencies</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">requests</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&gt;=2.31.0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">pandas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&gt;=2.0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">httpx</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&gt;=0.27.0&quot;</span><br></span></code></pre></div></div>
<p>The <code>pydantic</code> (&gt;=2.0) and <code>pyright</code> (&gt;=1.1) packages are automatically included
as required dependencies. Flow uses <code>uv</code> to install and manage all dependencies
efficiently during both validation and execution.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="async-patterns">Async Patterns<a href="#async-patterns" class="hash-link" aria-label="Direct link to Async Patterns" title="Direct link to Async Patterns" translate="no">​</a></h3>
<p>Python derivations use async generators to process documents efficiently.
Each transform method must be an async generator that yields output documents:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">from_orders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> read</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ReadFromOrders</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> AsyncIterator</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Document</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Process the input document</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> some_async_operation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">read</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">doc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Yield one or more output documents</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">yield</span><span class="token plain"> Document</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        key</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">read</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">doc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        processed_value</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>This async design allows you to efficiently perform I/O operations like API calls,
database queries, or HTTP requests while processing documents.
For managing concurrent operations with bounded parallelism,
see the <a href="https://github.com/estuary/flow/blob/master/examples/derive-patterns/pipeline.flow.py" target="_blank" rel="noopener noreferrer" class="">pipeline pattern example</a>.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="state-1">State<a href="#state-1" class="hash-link" aria-label="Direct link to State" title="Direct link to State" translate="no">​</a></h3>
<p>Python derivations support persistent state management through lifecycle methods:</p>
<ul>
<li class=""><strong><code>__init__(self, open: Request.Open)</code></strong>: Initialize and load persisted state
from previous transactions via <code>open.state</code></li>
<li class=""><strong><code>start_commit(self, start_commit: Request.StartCommit) -&gt; Response.StartedCommit</code></strong>:
Return state updates to persist at the end of each transaction</li>
<li class=""><strong><code>reset(self)</code></strong>: Reset state between catalog tests</li>
</ul>
<p>State is serialized as JSON and persists across task restarts, enabling
stateful transformations like running aggregations, joins, and windowed computations.</p>
<p>The <code>start_commit</code> method supports JSON merge patch semantics through <code>merge_patch=True</code>,
allowing you to efficiently update only the portions of state that changed
during a transaction rather than replacing the entire state.</p>
<p>For a complete example of stateful derivations, see the
<a href="https://github.com/estuary/flow/blob/master/examples/derive-patterns/stateful.flow.py" target="_blank" rel="noopener noreferrer" class="">stateful pattern example</a>.</p>
<p><a href="https://github.com/estuary/flow/tree/master/examples/derive-patterns" target="_blank" rel="noopener noreferrer" class="">See more derivation patterns in the examples directory</a></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="transformations">Transformations<a href="#transformations" class="hash-link" aria-label="Direct link to Transformations" title="Direct link to Transformations" translate="no">​</a></h2>
<p>A transformation binds a <a href="#sources" class="">source</a> collection to a derivation,
causing its documents to be read and processed by the derivation connector.</p>
<p>Read source documents are first <a href="#shuffles" class="">shuffled</a> on a <strong>shuffle key</strong>
to co-locate the processing of documents that have equal shuffle keys.
The transformation then processes documents by invoking <strong>lambdas</strong>:
user-defined functions that accept documents as arguments,
return documents in response,
and potentially update internal task state.</p>
<p>A derivation may have many transformations,
and each transformation has a long-lived and stable name.
Each transformation independently reads documents from its
source collection and tracks its own read progress.
More than one transformation can read from the same source collection,
and transformations may also source from their own derivation,
enabling cyclic data-flows and graph algorithms.</p>
<p>Transformations may be added to or removed from a derivation at any time.
This makes it possible to, for example, add a new collection into an
existing multi-way join, or gracefully migrate to a new source
collection without incurring downtime.
However, renaming a running transformation is not possible.
If attempted, the old transformation is dropped and
a new transformation under the new name is created,
which begins reading its source collection all over again.</p>
<div class="mermaid">
	graph LR;
    d[Derivation];
    t[Transformation];
    s[Internal State];
    l[Lambda];
    c[Sourced Collection];
    o[Derived Collection];
    d-- has many --&gt;t;
    d-- has one --&gt;s;
    d-- has one --&gt;o;
    c-- reads from --&gt;t;
    t-- invokes --&gt;l;
    l-- updates --&gt;s;
    s-- queries --&gt;l;
    l-- publishes to --&gt;o;
</div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="sources">Sources<a href="#sources" class="hash-link" aria-label="Direct link to Sources" title="Direct link to Sources" translate="no">​</a></h3>
<p>The <strong>source</strong> of a transformation is a collection.
As documents are published into the source collection,
they are continuously read and processed by the transformation.</p>
<p>A <a class="" href="/pr-preview/pr-2559/concepts/advanced/projections/#partition-selectors">partition selector</a> may be provided
to process only a subset of the source collection&#x27;s logical partitions.
Selectors are efficient: only partitions that match the selector are read,
and Flow can cheaply skip over partitions that don&#x27;t.</p>
<p>Derivations re-validate their source documents against
the source collection&#x27;s schema as they are read.
This is because collection schemas may evolve over time,
and could have inadvertently become incompatible with
historical documents of the source collection.
Upon a schema error, the derivation will pause and
give you an opportunity to correct the problem.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="shuffles">Shuffles<a href="#shuffles" class="hash-link" aria-label="Direct link to Shuffles" title="Direct link to Shuffles" translate="no">​</a></h3>
<p>As each source document is read, it&#x27;s shuffled — or equivalently, mapped —
on an extracted key.</p>
<p>If you&#x27;re familiar with data shuffles in tools like MapReduce,
Apache Spark, or Flink, the concept is very similar.
Flow catalog tasks scale out into multiple shards,
each running in parallel on different physical machines,
where each shard processes a subset of source documents.</p>
<p>Shuffles let Flow identify the shard that should process a particular
source document, in order to co-locate that processing with other
documents it may need to know about.</p>
<p>For example, transforms of the
<a class="" href="/pr-preview/pr-2559/getting-started/tutorials/derivations_acmebank/#approving-transfers">Approving Transfers example</a>
shuffle on either <code>/sender</code> or <code>/recipient</code> in order to
process documents that debit or credit accounts on the specific shard
that is uniquely responsible for maintaining the balance of a given account.</p>
<div class="mermaid">
	graph LR;
    subgraph s1 [Source Partitions]
      p1&gt;acmeBank/transfers/part-1];
      p2&gt;acmeBank/transfers/part-2];
    end
    subgraph s2 [Derivation Task Shards]
      t1([derivation/shard-1]);
      t2([derivation/shard-2]);
    end
    p1-- sender: alice --&gt;t1;
    p1-- recipient: bob --&gt;t2;
    p2-- recipient: alice --&gt;t1;
    p2-- sender: bob --&gt;t2;
</div>
<p>Flow offers three modes for configuring document shuffles: <code>key</code>, <code>any</code>, and <code>lambda</code>.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="shuffle-key">shuffle: key<a href="#shuffle-key" class="hash-link" aria-label="Direct link to shuffle: key" title="Direct link to shuffle: key" translate="no">​</a></h4>
<p>Shuffle keys are defined as an array of JSON pointers to locations
that should be extracted from your source documents.
This array forms the composite key over which your documents are shuffled:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">transforms</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fromOrders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">source</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> acmeCo/orders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">shuffle</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">/item/product_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> /customer_id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Flow guarantees that the same shard will process the user&#x27;s lambda</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># for all instances of a specific (product ID, customer ID) tuple.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">lambda</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">...</span><br></span></code></pre></div></div>
<p>If a derivation has more than one transformation,
the shuffle keys of all transformations must align with one another
in terms of the extracted key types (string vs integer)
as well as the number of components in a composite key.</p>
<p>For example, one transformation couldn&#x27;t shuffle transfers on <code>[/id]</code>
while another shuffles on <code>[/sender]</code>, because <code>sender</code> is a string and
<code>id</code> an integer.</p>
<p>Similarly mixing a shuffle of <code>[/sender]</code> alongside <code>[/sender, /recipient]</code>
is prohibited because the keys have different numbers of components.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="shuffle-any">shuffle: any<a href="#shuffle-any" class="hash-link" aria-label="Direct link to shuffle: any" title="Direct link to shuffle: any" translate="no">​</a></h4>
<p>If your lambda doesn&#x27;t rely on any task state then it may not matter which
task shard processes a given source document.
In these instances you can use <code>shuffle: any</code>, which allows source documents
to be processed by any available task shard.</p>
<p>This is common for transformation lambdas which perform basic filtering
or mapping of source documents and which don&#x27;t require any joined task state.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">transforms</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fromOrders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">source</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> acmeCo/orders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">shuffle</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> any</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># The user&#x27;s lambda is a pure function and can be evaluated by any available shard.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">lambda</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      SELECT $customer_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> $item_price WHERE $item_price </span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"> 100;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="shuffle-lambda">shuffle: lambda<a href="#shuffle-lambda" class="hash-link" aria-label="Direct link to shuffle: lambda" title="Direct link to shuffle: lambda" translate="no">​</a></h4>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Warning</div><div class="admonitionContent_BuS1"><p>Computed shuffles are in active development and are not yet functional.</p></div></div>
<p>Your source documents may not always contain an appropriate value to shuffle upon.
For instance, you might want to shuffle on product ID and order date,
but your source documents contain only an order timestamp field.</p>
<p>You can use <code>shuffle: lambda</code> to define a function that maps your
source document into the appropriate shuffle key:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">transforms</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fromOrders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">source</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> acmeCo/orders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">shuffle</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">lambda</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SELECT $product_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> DATE($order_timestamp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Flow guarantees that the same shard will process the user&#x27;s lambda</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># for all instances of a specific (product ID, date) tuple.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">lambda</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">...</span><br></span></code></pre></div></div>
<p>Your shuffle lambda must return exactly one row, and its columns and
types must align with the other shuffles of your derivation transformations.</p>
<p>Flow must know the types of your composite shuffle key.
In most cases it will infer these types from the <code>shuffle: key</code> of another transformation.
If you have no <code>shuffle: key</code> transformations, Flow will ask that you explicitly tell it your shuffle types:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">derive</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">using</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">sqlite</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">shuffleKeyTypes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">integer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">transforms</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fromOrders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">source</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> acmeCo/orders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">shuffle</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">lambda</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SELECT $product_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> DATE($order_timestamp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">lambda</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">...</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="lambdas">Lambdas<a href="#lambdas" class="hash-link" aria-label="Direct link to Lambdas" title="Direct link to Lambdas" translate="no">​</a></h3>
<p>Lambdas are user-defined functions that are invoked by transformations.
They accept documents as arguments
and return transformed documents in response.
Lambdas can update internal task state,
publish documents into the derived collection,
or both.</p>
<p>Lambdas are &quot;serverless&quot;: Flow manages the execution
and scaling of your transformation lambdas on your behalf.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="processing-order">Processing order<a href="#processing-order" class="hash-link" aria-label="Direct link to Processing order" title="Direct link to Processing order" translate="no">​</a></h3>
<p>Transformations may simultaneously read from many source collections,
or even read from the same source collection multiple times.</p>
<p>Roughly speaking, the derivation will globally process transformations and
their source documents in the time-based order in which the source documents
were originally written to their source collections.
This means that a derivation started a month ago
and a new copy of the derivation started today,
will process documents in the same order and arrive at the same result.
Derivations are <strong>repeatable</strong>.</p>
<p>More precisely, processing order is stable for each individual shuffle key,
though different shuffle keys may process in different orders if more than
one task shard is used.</p>
<p>Processing order can be attenuated through a <a href="#read-delay" class="">read delay</a>
or differentiated <a href="#read-priority" class="">read priority</a>.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="read-delay">Read delay<a href="#read-delay" class="hash-link" aria-label="Direct link to Read delay" title="Direct link to Read delay" translate="no">​</a></h3>
<p>A transformation can define a read delay, which will hold back the processing
of its source documents until the time delay condition is met.
For example, a read delay of 15 minutes would mean that a source document
cannot be processed until it was published at least 15 minutes ago.
If the derivation is working through a historical backlog of source documents,
than a delayed transformation will respect its ordering delay relative
to the publishing times of other historical documents also being read.</p>
<p>Event-driven workflows are a great fit for reacting to events as they occur,
but aren’t terribly good at taking action when something <em>hasn’t</em> happened:</p>
<blockquote>
<ul>
<li class="">A user adds a product to their cart, but then doesn’t complete a purchase.</li>
<li class="">A temperature sensor stops producing its expected, periodic measurements.</li>
</ul>
</blockquote>
<p>A common pattern for tackling these workflows in Flow is to
read a source collection without a delay and update an internal state.
Then, read a collection with a read delay
and determine whether the desired action has happened or not.
For example, source from a collection of sensor readings
and index the last timestamp of each sensor.
Then, source the same collection again with a read delay:
if the register timestamp isn&#x27;t more recent
than the delayed source reading,
the sensor failed to produce a measurement.</p>
<p>Flow read delays are very efficient and scale better
than managing very large numbers of fine-grain timers.</p>
<p><a class="" href="/pr-preview/pr-2559/getting-started/tutorials/derivations_acmebank/#grouped-windows-of-transfers">See Grouped Windows of Transfers for an example using a read delay</a></p>
<p><a href="https://github.com/estuary/flow/blob/master/examples/citi-bike/idle-bikes.flow.yaml" target="_blank" rel="noopener noreferrer" class="">Learn more from the Citi Bike &quot;idle bikes&quot; example</a></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="read-priority">Read priority<a href="#read-priority" class="hash-link" aria-label="Direct link to Read priority" title="Direct link to Read priority" translate="no">​</a></h3>
<p>Sometimes it&#x27;s necessary for <em>all</em> documents of a source collection
to be processed by a transformation before <em>any</em> documents of some
other source collection are processed, regardless of their
relative publishing time.
For example, a collection may have corrections that should be
applied before the historical data of another collection
is re-processed.</p>
<p>Transformation priorities allow you to express the relative
processing priority of a derivation&#x27;s various transformations.
When priorities are not equal, <em>all</em> available source documents
of a higher-priority transformation
are processed before <em>any</em> source documents
of a lower-priority transformation.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="internal-state">Internal State<a href="#internal-state" class="hash-link" aria-label="Direct link to Internal State" title="Direct link to Internal State" translate="no">​</a></h2>
<p>Derivation tasks often require an internal state,
perhaps to hold a partial aggregation or join result.
Internal state is not a direct part of the output of a derivation.
Instead, transformation lambdas query and update internal state
as they process source documents and return derived documents.</p>
<p>For SQLite derivations,
the entire SQLite database is the internal state of the task.
TypeScript derivations can use in-memory states with a
recovery and checkpoint mechanism.
Estuary intends to offer additional mechanisms for
automatic internal state snapshot and recovery in the future.</p>
<p>The exact nature of internal task states vary,
but under the hood they&#x27;re backed by a replicated
embedded RocksDB instance which is co-located
with the task shard execution contexts that Flow manages.
As contexts are assigned and re-assigned,
their state databases travel with them.</p>
<p>If a task shard needs to be scaled out,
Flow is able to perform an <a class="" href="/pr-preview/pr-2559/concepts/advanced/shards/#shard-splits">online split</a>,
which cheaply clones its state database into two new databases
— and paired shards — which are re-assigned to other machines.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="where-to-accumulate">Where to accumulate?<a href="#where-to-accumulate" class="hash-link" aria-label="Direct link to Where to accumulate?" title="Direct link to Where to accumulate?" translate="no">​</a></h2>
<p>Derivation collection schemas may have
<a class="" href="/pr-preview/pr-2559/concepts/schemas/#reductions">reduction</a> annotations,
and lambdas can be combined with reductions in interesting ways.
You may be familiar with <code>map</code> and <code>reduce</code> functions
built into languages like
<a href="https://book.pythontips.com/en/latest/map_filter.html" target="_blank" rel="noopener noreferrer" class="">Python</a>,
<a href="https://www.freecodecamp.org/news/javascript-map-reduce-and-filter-explained-with-examples/" target="_blank" rel="noopener noreferrer" class="">JavaScript</a>,
and many others
or have used tools like MapReduce or Spark.
In functional terms, lambdas you write within Flow are &quot;mappers,&quot;
and reductions are always done
by the Flow runtime using your schema annotations.</p>
<p>This means that, when you implement a derivation,
you get to choose where <strong>accumulation</strong> will happen:</p>
<ol>
<li class="">Your lambdas can update and query aggregates stored in <a href="#internal-state" class="">internal task state</a>.
<a class="" href="/pr-preview/pr-2559/getting-started/tutorials/derivations_acmebank/#approving-transfers">Approving Transfers</a> is an example that maintains account balances in a SQLite table.</li>
<li class="">Or, your lambdas can compute <em>changes</em> of an aggregate, which are then reduced by Flow using reduction annotations.
<a class="" href="/pr-preview/pr-2559/getting-started/tutorials/derivations_acmebank/#current-account-balances">Current Account Balances</a> is an example that combines a lambda with a reduce annotation.</li>
</ol>
<p>These two approaches can produce equivalent results,
but they do so in very different ways.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="accumulate-in-internal-task-state">Accumulate in Internal Task State<a href="#accumulate-in-internal-task-state" class="hash-link" aria-label="Direct link to Accumulate in Internal Task State" title="Direct link to Accumulate in Internal Task State" translate="no">​</a></h3>
<p>You can accumulate using the internal state of your derivation:
for instance, by using an internal table within your SQLite derivation.
You then write lambdas which update that state,
or query it to publish derived documents.</p>
<p>For example, consider a collection that’s summing a value:</p>
<table><thead><tr><th>Time</th><th>State</th><th>Lambdas</th><th>Derived Document</th></tr></thead><tbody><tr><td>T0</td><td><strong>0</strong></td><td>UPDATE val = val + 5; SELECT val;</td><td><strong>5</strong></td></tr><tr><td>T1</td><td><strong>5</strong></td><td>UPDATE val = val - 1; SELECT val;</td><td><strong>4</strong></td></tr><tr><td>T2</td><td><strong>4</strong></td><td>UPDATE val = val + 2; SELECT val;</td><td><strong>6</strong></td></tr><tr><td>T3</td><td><strong>6</strong></td><td></td><td></td></tr></tbody></table>
<p>Using a derivation&#x27;s internal state is a great solution if you expect to
materialize the derived collection into a non-transactional store.
That&#x27;s because its documents are complete statements of the current answer,
and can be correctly applied to systems that support only at-least-once semantics.</p>
<p>They’re also well-suited for materializations into endpoints that aren&#x27;t stateful,
such as Pub/Sub systems or Webhooks.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="accumulate-in-a-database">Accumulate in a Database<a href="#accumulate-in-a-database" class="hash-link" aria-label="Direct link to Accumulate in a Database" title="Direct link to Accumulate in a Database" translate="no">​</a></h3>
<p>To accumulate in your materialization endpoint, such as a database,
you define a derivation with a reducible schema
and implement lambdas which publish the <em>changes</em> to a current answer.
The Flow runtime then uses your reduction annotations
to combine the documents published into your derived collection.</p>
<p>Later, when the collection is materialized, your reduction annotations
are applied again to reduce each collection document into a final,
fully-reduced value for each collection key
that&#x27;s kept up to date in the materialized table.</p>
<p>A key insight is that the database is
the <em>only</em> stateful system in this scenario.
The derivation itself is stateless, with lambdas that are pure functions,
which is typically extremely performant.</p>
<p>Returning to our summing example:</p>
<table><thead><tr><th>Time</th><th>DB</th><th>Lambdas</th><th>Derived Document</th></tr></thead><tbody><tr><td>T0</td><td><strong>0</strong></td><td>SELECT 5;</td><td><strong>5</strong></td></tr><tr><td>T1</td><td><strong>5</strong></td><td>SELECT -1;</td><td><strong>-1</strong></td></tr><tr><td>T2</td><td><strong>4</strong></td><td>SELECT 2;</td><td><strong>2</strong></td></tr><tr><td>T3</td><td><strong>6</strong></td><td></td><td></td></tr></tbody></table>
<p>This works especially well when materializing into a transactional database.
Flow couples its processing transactions with corresponding database transactions,
ensuring end-to-end “exactly once” semantics.</p>
<p>When materializing into a non-transactional store,
Flow is only able to provide weaker “at least once” semantics;
it’s possible that a document may be combined into a database value more than once.
Whether that’s a concern depends a bit on the task at hand.
Some reductions like <code>merge</code> can be applied repeatedly without changing the result,
while in other use cases approximations are acceptable.
For the summing example above,
&quot;at-least-once&quot; semantics could give an incorrect result.</p>
<p><a href="https://github.com/estuary/flow/tree/master/examples/derive-patterns" target="_blank" rel="noopener noreferrer" class="">Learn more in the derivation pattern examples of Flow&#x27;s repository</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/estuary/flow/edit/master/site/docs/concepts/derivations.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/pr-preview/pr-2559/concepts/connectors/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Connectors</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/pr-preview/pr-2559/concepts/flowctl/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">flowctl</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#specification" class="table-of-contents__link toc-highlight">Specification</a></li><li><a href="#supported-languages" class="table-of-contents__link toc-highlight">Supported Languages</a></li><li><a href="#sqlite" class="table-of-contents__link toc-highlight">SQLite</a><ul><li><a href="#sql-lambdas" class="table-of-contents__link toc-highlight">SQL Lambdas</a></li><li><a href="#document-mapping" class="table-of-contents__link toc-highlight">Document Mapping</a></li><li><a href="#parameters" class="table-of-contents__link toc-highlight">Parameters</a></li><li><a href="#migrations" class="table-of-contents__link toc-highlight">Migrations</a></li><li><a href="#performance" class="table-of-contents__link toc-highlight">Performance</a></li></ul></li><li><a href="#typescript" class="table-of-contents__link toc-highlight">TypeScript</a><ul><li><a href="#modules" class="table-of-contents__link toc-highlight">Modules</a></li><li><a href="#state" class="table-of-contents__link toc-highlight">State</a></li></ul></li><li><a href="#python" class="table-of-contents__link toc-highlight">Python</a><ul><li><a href="#modules-1" class="table-of-contents__link toc-highlight">Modules</a></li><li><a href="#dependencies" class="table-of-contents__link toc-highlight">Dependencies</a></li><li><a href="#async-patterns" class="table-of-contents__link toc-highlight">Async Patterns</a></li><li><a href="#state-1" class="table-of-contents__link toc-highlight">State</a></li></ul></li><li><a href="#transformations" class="table-of-contents__link toc-highlight">Transformations</a><ul><li><a href="#sources" class="table-of-contents__link toc-highlight">Sources</a></li><li><a href="#shuffles" class="table-of-contents__link toc-highlight">Shuffles</a></li><li><a href="#lambdas" class="table-of-contents__link toc-highlight">Lambdas</a></li><li><a href="#processing-order" class="table-of-contents__link toc-highlight">Processing order</a></li><li><a href="#read-delay" class="table-of-contents__link toc-highlight">Read delay</a></li><li><a href="#read-priority" class="table-of-contents__link toc-highlight">Read priority</a></li></ul></li><li><a href="#internal-state" class="table-of-contents__link toc-highlight">Internal State</a></li><li><a href="#where-to-accumulate" class="table-of-contents__link toc-highlight">Where to accumulate?</a><ul><li><a href="#accumulate-in-internal-task-state" class="table-of-contents__link toc-highlight">Accumulate in Internal Task State</a></li><li><a href="#accumulate-in-a-database" class="table-of-contents__link toc-highlight">Accumulate in a Database</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/pr-preview/pr-2559/">Platform Docs</a></li><li class="footer__item"><a class="footer__link-item" href="/pr-preview/pr-2559/reference/Connectors/">Connector Docs</a></li><li class="footer__item"><a href="https://estuary.dev/success-stories/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Success Stories<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://go.estuary.dev/slack" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.linkedin.com/company/estuary-tech/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://twitter.com/EstuaryDev" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/estuary/flow" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@estuarydev" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://estuary.dev/contact-us/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Contact Us<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 Estuary Technologies, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>