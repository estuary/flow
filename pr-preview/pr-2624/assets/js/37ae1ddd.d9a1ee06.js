"use strict";(self.webpackChunksite=self.webpackChunksite||[]).push([[504],{28453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>s});var r=t(96540);const o={},i=r.createContext(o);function a(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),r.createElement(i.Provider,{value:n},e.children)}},46197:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>u,frontMatter:()=>a,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"transformations/flatten-array","title":"How to Flatten an Array Using TypeScript","description":"This guide will show you how to flatten an array field in a collection by creating a TypeScript derivation in Estuary.","source":"@site/docs/transformations/flatten-array.md","sourceDirName":"transformations","slug":"/guides/flatten-array/","permalink":"/pr-preview/pr-2624/guides/flatten-array/","draft":false,"unlisted":false,"editUrl":"https://github.com/estuary/flow/edit/master/site/docs/transformations/flatten-array.md","tags":[],"version":"current","frontMatter":{"slug":"/guides/flatten-array/"},"sidebar":"docsSidebar","previous":{"title":"How to Transform Data Using TypeScript","permalink":"/pr-preview/pr-2624/guides/transform_data_using_typescript/"},"next":{"title":"How to Join Two Collections (TypeScript)","permalink":"/pr-preview/pr-2624/guides/howto_join_two_collections_typescript/"}}');var o=t(74848),i=t(28453);const a={slug:"/guides/flatten-array/"},s="How to Flatten an Array Using TypeScript",l={},c=[{value:"Step 1: Set up your development environment",id:"step-1-set-up-your-development-environment",level:2},{value:"Step 2: Set up your schema",id:"step-2-set-up-your-schema",level:2},{value:"Step 3: Write your TypeScript derivation",id:"step-3-write-your-typescript-derivation",level:2},{value:"Step 4: Preview your derivation",id:"step-4-preview-your-derivation",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"how-to-flatten-an-array-using-typescript",children:"How to Flatten an Array Using TypeScript"})}),"\n",(0,o.jsx)(n.p,{children:"This guide will show you how to flatten an array field in a collection by creating a TypeScript derivation in Estuary."}),"\n",(0,o.jsx)(n.admonition,{type:"note",children:(0,o.jsxs)(n.p,{children:["We'll be using TypeScript for our derivation in this guide. Check out our other guides if you're interested in using ",(0,o.jsx)(n.a,{href:"/guides/derivation_tutorial_sql",children:"SQL"})," or ",(0,o.jsx)(n.a,{href:"/guides/transform_data_using_python",children:"Python"})," for transformations."]})}),"\n",(0,o.jsxs)(n.p,{children:["The collection we'll be working with (",(0,o.jsx)(n.code,{children:"user_content"}),") contains a field called ",(0,o.jsx)(n.code,{children:"tags"}),", which is an array of objects. Each object in the array has a name and a value. We'll be flattening this array into a new collection, with two separate fields: ",(0,o.jsx)(n.code,{children:"tag_name"})," and ",(0,o.jsx)(n.code,{children:"tag_value"}),"."]}),"\n",(0,o.jsx)(n.p,{children:"The original data looks like this:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{\n  "id": "1",\n  "name": "example",\n  "tags": [\n    {\n      "name": "tag1",\n      "value": "value1"\n    },\n    {\n      "name": "tag2",\n      "value": "value2"\n    }\n  ]\n}\n'})}),"\n",(0,o.jsx)(n.p,{children:"The resulting data will have the following structure:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{\n  "tag_name": "tag1",\n  "tag_value": "value1"\n}\n'})}),"\n",(0,o.jsx)(n.h2,{id:"step-1-set-up-your-development-environment",children:"Step 1: Set up your development environment"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["Ensure you have ",(0,o.jsx)(n.code,{children:"flowctl"})," ",(0,o.jsx)(n.a,{href:"/guides/get-started-with-flowctl",children:"installed and authenticated"}),"."]}),"\n",(0,o.jsx)(n.li,{children:"In the Estuary dashboard, note the name of the collection you'd like to transform."}),"\n",(0,o.jsxs)(n.li,{children:["In your local development environment, create a working directory with a new ",(0,o.jsx)(n.code,{children:"flow.yaml"})," file."]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"step-2-set-up-your-schema",children:"Step 2: Set up your schema"}),"\n",(0,o.jsxs)(n.p,{children:["Open your new ",(0,o.jsx)(n.code,{children:"flow.yaml"})," file. This file will contain the schema for your derived collection. You'll need to modify this file to match what we want our derived collection to look like."]}),"\n",(0,o.jsxs)(n.p,{children:["We'll be using the ",(0,o.jsx)(n.code,{children:"tags"})," field from the original data, so we'll need to add a new property for each field we want to include in the derived collection. We'll also need to set a key for the derived collection."]}),"\n",(0,o.jsxs)(n.p,{children:["Your ",(0,o.jsx)(n.code,{children:"flow.yaml"})," file will therefore look something like this:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"---\ncollections:\n  <your_tenant>/<derivation_name>:\n    schema:\n      type: object\n      properties:\n        tag_name:\n          type: string\n        tag_value:\n          type: string\n      required:\n        - tag_name\n        - tag_value\n    key:\n      - /tag_name\n    derive:\n      using:\n        typescript:\n          module: <derivation_name>.ts\n      transforms:\n        - name: user_content\n          source: <your_tenant>/<capture_name>/public/<collection_name>\n          shuffle: any\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Copy this into your ",(0,o.jsx)(n.code,{children:"flow.yaml"})," file. Replace resource names within angle brackets (eg. ",(0,o.jsx)(n.code,{children:"<your_tenant>"}),") with your own information and save your changes."]}),"\n",(0,o.jsx)(n.h2,{id:"step-3-write-your-typescript-derivation",children:"Step 3: Write your TypeScript derivation"}),"\n",(0,o.jsxs)(n.p,{children:["Note that the YAML specification references a TypeScript file (",(0,o.jsx)(n.code,{children:"<derivation_name>.ts"}),") that doesn't exist yet.\nYou can generate a stub file for your TypeScript transformation using:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"flowctl generate --source flow.yaml\n"})}),"\n",(0,o.jsx)(n.p,{children:"This file is where you'll write your TypeScript code to flatten the array."}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Open the new ",(0,o.jsx)(n.code,{children:"<derivation_name>.ts"})," file."]}),"\n",(0,o.jsx)(n.p,{children:"You'll see a basic structure for your TypeScript code. It should look something like this:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:'import {\n  IDerivation,\n  Document,\n  SourceUserContent,\n} from "flow/sean-estuary/test-derivation.ts";\n\nexport class Derivation extends IDerivation {\n  userContent(_read: { doc: SourceUserContent }): Document[] {\n    throw new Error("Not implemented");\n  }\n}\n'})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Now, let's modify the ",(0,o.jsx)(n.code,{children:"userContent"})," function to flatten the array. We'll loop through each document in the ",(0,o.jsx)(n.code,{children:"SourceUserContent"}),", and for each document, we'll loop through the ",(0,o.jsx)(n.code,{children:"tags"})," array. For each tag, we'll create a new document with the ",(0,o.jsx)(n.code,{children:"tag_name"})," and ",(0,o.jsx)(n.code,{children:"tag_value"})," fields."]}),"\n",(0,o.jsxs)(n.p,{children:["Update the ",(0,o.jsx)(n.code,{children:"userContent"})," function to look like this:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:'import {\n  IDerivation,\n  Document,\n  SourceUserContent,\n} from "flow/sean-estuary/test-derivation.ts";\n\nexport class Derivation extends IDerivation {\n  userContent(_read: { doc: SourceUserContent }): Document[] {\n    const doc = _read.doc;\n    const output: Document[] = [];\n\n    if (doc.tags) {\n      const tagsJson = JSON.parse(doc.tags); // Since our tags are arriving as a string from Google Sheets\n      for (const tag of tagsJson) {\n        output.push({\n          tag_name: tag.name,\n          tag_value: tag.value,\n        });\n      }\n    }\n    return output;\n  }\n}\n'})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Save the ",(0,o.jsx)(n.code,{children:"<derivation_name>.ts"})," file."]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"step-4-preview-your-derivation",children:"Step 4: Preview your derivation"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Run the following command to test your derivation:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"flowctl preview --source flow.yaml\n"})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"This will show you a preview of the derived collection, including the flattened fields. Make sure everything looks good."}),"\n",(0,o.jsx)(n.p,{children:"For example, an original row like this:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{\n  "_meta": {\n    ...\n  },\n  "id": "1",\n  "name": "test1",\n  "tags": "[{"name":"PFJUjs6Wec","value":"HB668r7MfN"},{"name":"aIWpjtpNnj","value":"elQ9948Wpf"}]"\n}\n'})}),"\n",(0,o.jsx)(n.p,{children:"Should appear in your preview as two individual records:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{\n  "_meta": {\n    ...\n  },\n  "tag_name": "PFJUjs6Wec",\n  "tag_value": "HB668r7MfN"\n}\n{\n  "_meta": {\n    ...\n  },\n  "tag_name": "aIWpjtpNnj",\n  "tag_value": "elQ9948Wpf"\n}\n'})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Once you've confirmed your results, you can proceed to publish your derivation to Estuary:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"flowctl catalog publish --source flow.yaml\n"})}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"Congratulations! You've successfully flattened an array in TypeScript using Estuary. You can now use this technique to flatten other arrays in your data as well."})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}}}]);